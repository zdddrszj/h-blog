<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Shirly</title>
  
  <subtitle>subtitle</subtitle>
  <link href="/h-blog/atom.xml" rel="self"/>
  
  <link href="https://zdddrszj.github.io/h-blog/"/>
  <updated>2018-10-07T01:46:42.307Z</updated>
  <id>https://zdddrszj.github.io/h-blog/</id>
  
  <author>
    <name>Shirly</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>React ç®€å•å®ç°ï¼ˆä¸€ï¼‰</title>
    <link href="https://zdddrszj.github.io/h-blog/2018/10/07/reactAchieved1/"/>
    <id>https://zdddrszj.github.io/h-blog/2018/10/07/reactAchieved1/</id>
    <published>2018-10-07T01:46:10.000Z</published>
    <updated>2018-10-07T01:46:42.307Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><ul><li><a href="#ä¸€-å‰è¨€">ä¸€ã€å‰è¨€</a></li><li><a href="#äºŒ-createelement-å®ç°">äºŒã€createElement å®ç°</a></li><li><a href="#ä¸‰-render-å®ç°">ä¸‰ã€render å®ç°</a><ul><li><a href="#1-å­—ç¬¦ä¸²ç±»å‹">1ã€å­—ç¬¦ä¸²ç±»å‹</a></li><li><a href="#2-æ ‡ç­¾ç±»å‹">2ã€æ ‡ç­¾ç±»å‹</a></li><li><a href="#3-å‡½æ•°ç±»å‹">3ã€å‡½æ•°ç±»å‹</a></li></ul></li><li><a href="#å››-setstate-å®ç°">å››ã€setState å®ç°</a></li></ul><!-- tocstop --><p><code>React</code> æ˜¯ä¸€æ¬¾ç”¨äºæ„å»ºç”¨æˆ·ç•Œé¢çš„ <code>JavaScript</code> åº“ã€‚å®ƒä»¥å£°æ˜å¼ç¼–å†™ <code>UI</code>ï¼Œåˆ›å»ºæ‹¥æœ‰å„è‡ªçŠ¶æ€çš„ç»„ä»¶ï¼Œå†ç”±ç»„ä»¶æ„æˆæ›´åŠ å¤æ‚çš„ç•Œé¢ã€‚</p><h2><span id="ä¸€-å‰è¨€">ä¸€ã€å‰è¨€</span></h2><p>åœ¨ <code>React</code> ä¸­æˆ‘ä»¬ä½¿ç”¨ <code>JSX</code> è¯­æ³•æ¥æ›¿ä»£å¸¸è§„çš„  <code>JavaScript</code>ï¼Œå¹¶é€šè¿‡ <code>Babel</code> ç¼–è¯‘ï¼Œæ¯”å¦‚ä¾‹å­1ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JSXè¯­æ³•</span></span><br><span class="line"><span class="keyword">let</span> str = <span class="xml"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">className</span>=<span class="string">"title"</span>&gt;</span>hello<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Babelç¼–è¯‘å</span></span><br><span class="line"><span class="keyword">var</span> str = React.createElement(</span><br><span class="line">  <span class="string">"h1"</span>,</span><br><span class="line">  &#123; <span class="attr">className</span>: <span class="string">"title"</span> &#125;,</span><br><span class="line">  <span class="string">"hello"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></p><p>ç„¶åæˆ‘ä»¬æ§åˆ¶å°è¾“å‡º <code>str</code>ï¼Œå¾—åˆ°ç»“æœå¦‚ä¸‹ï¼š<br><img src="https://user-gold-cdn.xitu.io/2018/7/27/164dc02769830bd2?w=24&amp;f=png&amp;s=30515" alt=""><br>ä¾‹å­2ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JSXè¯­æ³•</span></span><br><span class="line"><span class="keyword">let</span> App = <span class="function"><span class="keyword">function</span> <span class="title">MyComponent</span> (<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>hello&#123;props.value&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Babelç¼–è¯‘å</span></span><br><span class="line"><span class="keyword">var</span> App = <span class="function"><span class="keyword">function</span> <span class="title">MyComponent</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> React.createElement(</span><br><span class="line">    <span class="string">"h1"</span>,</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    <span class="string">"hello"</span>,</span><br><span class="line">    props.value</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ§åˆ¶å°è¾“å‡º <code>App</code>ï¼Œå¾—åˆ°ç»“æœå¦‚ä¸‹ï¼š<br><img src="https://user-gold-cdn.xitu.io/2018/7/27/164dc63f58c8a996?w=378&amp;h=50&amp;f=png&amp;s=31369" alt=""></p><p>è¿™ä¸ªå¯¹è±¡å°±æ˜¯è™šæ‹Ÿ <code>DOM</code> å¯¹è±¡ï¼Œæœ€åé€šè¿‡ <code>ReactDOM.render</code> æ–¹æ³•å°†è™šæ‹Ÿ <code>DOM</code> è§£ææ¸²æŸ“åˆ°é¡µé¢ä¸Šã€‚ä¸‹é¢æˆ‘ä»¬å°±åˆ†åˆ«æ¥å®ç° <code>createElement</code> å’Œ <code>render</code> æ–¹æ³•ã€‚</p><h2><span id="äºŒ-createelement-å®ç°">äºŒã€createElement å®ç°</span></h2><p>æ­¤æ–¹æ³•å°±æ˜¯å®ç°ä¸€ä¸ªæ•°æ®ç»“æ„ï¼ŒæŠŠ <code>JSX</code> ç¼–è¯‘åçš„ç»“æ„ä»¥åµŒå¥—å½¢å¼ä¿å­˜åœ¨æ•°æ®ç»“æ„å¯¹è±¡ä¸­ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create and return a new ReactElement of the given type.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createElement</span> (<span class="params">type, props, ...children</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type,</span><br><span class="line">    props: &#123;</span><br><span class="line">      ...props,</span><br><span class="line">      children: children.length &lt;= <span class="number">1</span> ? children[<span class="number">0</span>] : children</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="ä¸‰-render-å®ç°">ä¸‰ã€render å®ç°</span></h2><p><code>render</code> å‡½æ•°å°±æ˜¯è§£æè™šæ‹Ÿ <code>DOM</code>ï¼Œç„¶åé€šè¿‡ <code>appendChild</code> æ¸²æŸ“åˆ°é¡µé¢ä¸Šï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°†çœŸå®domæ¸²æŸ“åˆ°é¡µé¢</span></span><br><span class="line"><span class="comment"> * @param &#123;*è™šæ‹Ÿdom&#125; vnode </span></span><br><span class="line"><span class="comment"> * @param &#123;*é¡µé¢å®¹å™¨&#125; container </span></span><br><span class="line"><span class="comment"> * @param &#123;*æ¸²æŸ“åçš„å›è°ƒ&#125; callback </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">vnode, container, callback</span>) </span>&#123;</span><br><span class="line">  container.appendChild(_render(vnode))</span><br><span class="line">  callback &amp;&amp; callback()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°†è™šæ‹Ÿdomè½¬æˆçœŸå®èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> * @param &#123;*è™šæ‹Ÿdom&#125; vnode </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_render</span> (<span class="params">vnode</span>) </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è™šæ‹Ÿ <code>DOM</code> çš„æœ‰ä¸‰ç§ç±»å‹ï¼Œä¸åŒç±»å‹æœ‰ä¸åŒçš„æ¸²æŸ“æ–¹å¼ï¼Œä¸‹é¢æˆ‘ä»¬åˆ†åˆ«æ¥åˆ†æä¸€ä¸‹ã€‚</p><h3><span id="1-å­—ç¬¦ä¸²ç±»å‹">1ã€å­—ç¬¦ä¸²ç±»å‹</span></h3><p>å­—ç¬¦ä¸²ç±»å‹å³æ˜¯æ–‡æœ¬ï¼Œæ¯”å¦‚ä¸Šé¢çš„ <code>hello</code>ï¼Œç›´æ¥åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹è¿”å›å³å¯ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_render</span> (<span class="params">vnode</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å¦‚æœæ˜¯æ™®é€šå­—ç¬¦</span></span><br><span class="line">  <span class="keyword">if</span> (util.isString(vnode) || util.isNumber(vnode)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">document</span>.createTextNode(vnode)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3><span id="2-æ ‡ç­¾ç±»å‹">2ã€æ ‡ç­¾ç±»å‹</span></h3><p>å¸¸è§æ ‡ç­¾å¦‚ <code>div/h1/span</code> ç­‰ï¼Œåˆ›å»ºå…ƒç´ æ ‡ç­¾åéœ€è¦éå†è®¾ç½®å±æ€§ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_render</span> (<span class="params">vnode</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> &#123; type, props &#125; = vnode</span><br><span class="line">  <span class="keyword">let</span> &#123; children, ...attrs &#125; = props</span><br><span class="line">  <span class="comment">// å¦‚æœæ˜¯æ ‡ç­¾å…ƒç´ ï¼Œå¦‚ div span</span></span><br><span class="line">  <span class="keyword">let</span> dom = <span class="built_in">document</span>.createElement(type)</span><br><span class="line">  <span class="keyword">if</span> (children) &#123;</span><br><span class="line">    <span class="keyword">if</span> (util.isArray(children)) &#123;</span><br><span class="line">      children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">        render(child, dom)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      dom.appendChild(<span class="built_in">document</span>.createTextNode(children))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è®¾ç½®å±æ€§</span></span><br><span class="line">  setAttributes(attrs, dom)</span><br><span class="line">  <span class="keyword">return</span> dom</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3><span id="3-å‡½æ•°ç±»å‹">3ã€å‡½æ•°ç±»å‹</span></h3><p>å‡½æ•°ç±»å‹ä¹Ÿåˆ†äºŒç§æƒ…å†µï¼Œä¸€ç§æ˜¯æ— çŠ¶æ€æ™®é€šå‡½æ•°å³å‡½æ•°ç»„ä»¶ï¼Œå¦ä¸€ç§åˆ™æ˜¯ç»§æ‰¿äº† <code>React.Component</code> ç±»çš„æœ‰çŠ¶æ€å‡½æ•°ï¼Œå³ç±»ç»„ä»¶ã€‚å¼€å§‹ä¹‹å‰éœ€è¦å®šä¹‰ä¸€ä¸ª  <code>Component</code> çˆ¶ç±»ä»¥ä¾¿ç»§æ‰¿ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create React.Component class</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> (props) &#123;</span><br><span class="line">    <span class="keyword">this</span>.props = props</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  componentWillMount () &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Component: componentWillMount'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  componentDidMount () &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Component: componentDidMount'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  setState () &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Component: setState'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä¸ç®¡å“ªç§ç»„ä»¶ï¼Œä¸ºäº†ä¿è¯è¡Œä¸ºç»Ÿä¸€æ€§ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†åˆ«ç»è¿‡ç»„ä»¶åˆ›å»ºï¼Œç»„ä»¶æ¸²æŸ“ï¼Œç„¶åè¿”å›çœŸå® <code>DOM</code> èŠ‚ç‚¹ï¼Œæœ€åæ¸²æŸ“åˆ°é¡µé¢ä¸Šçš„æ­¥éª¤ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_render</span> (<span class="params">vnode</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> &#123; type, props &#125; = vnode</span><br><span class="line">  <span class="keyword">let</span> &#123; children, ...attrs &#125; = props</span><br><span class="line">  <span class="comment">// å¦‚æœæ˜¯å‡½æ•°ï¼Œè¯´æ˜æ˜¯ç»„ä»¶ï¼ˆåŒ…æ‹¬å‡½æ•°ç»„ä»¶å’Œç±»ç»„ä»¶ï¼‰</span></span><br><span class="line">  <span class="keyword">if</span> (util.isFunction(type)) &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºç»„ä»¶</span></span><br><span class="line">    <span class="keyword">let</span> comp = createComponent(type, props)</span><br><span class="line">    comp.props = props</span><br><span class="line">    <span class="comment">// æ¸²æŸ“ç»„ä»¶</span></span><br><span class="line">    <span class="keyword">let</span> dom = renderComponent(comp)</span><br><span class="line">    comp.dom = dom</span><br><span class="line">    <span class="comment">// è®¾ç½®å±æ€§</span></span><br><span class="line">    setAttributes(attrs, dom)</span><br><span class="line">    <span class="keyword">return</span> dom</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åˆ›å»ºç»„ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createComponent</span> (<span class="params">comp, props</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å¦‚æœæ˜¯ç±»ç»„ä»¶ï¼Œéœ€è¦newä¸€ä¸ªå®ä¾‹ï¼Œå¯ä»¥è°ƒç”¨renderæ–¹æ³•</span></span><br><span class="line">  <span class="keyword">if</span> (comp.prototype.render) &#123;</span><br><span class="line">    comp = <span class="keyword">new</span> comp(props)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    comp.render = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> comp(props)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> comp</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸²æŸ“ç»„ä»¶ï¼šæ‰§è¡Œç»„ä»¶çš„renderæ–¹æ³•ï¼Œç„¶åé€šè¿‡_renderå°†è™šæ‹Ÿdomè½¬æˆçœŸå®domï¼Œæœ€åè¿”å›çœŸå®èŠ‚ç‚¹</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderComponent</span> (<span class="params">comp</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> dom</span><br><span class="line">  <span class="comment">// å¦‚æœæœªæ¸²æŸ“è¿‡ç»„ä»¶</span></span><br><span class="line">  <span class="keyword">if</span> (!comp.dom) &#123;</span><br><span class="line">    <span class="keyword">if</span> (comp.componentWillMount) &#123;</span><br><span class="line">      comp.componentWillMount()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  dom = _render(comp.render())</span><br><span class="line">  <span class="keyword">if</span> (comp.componentDidMount) &#123;</span><br><span class="line">    comp.componentDidMount()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> dom</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åˆ°è¿™é‡Œè§£æå’Œæ¸²æŸ“åŠŸèƒ½å¤§ä½“å®Œæˆï¼Œä¸‹é¢ä»‹ç»ä¸€ä¸‹å¦‚ä½•ä¿®æ”¹ç»„ä»¶çŠ¶æ€ã€‚</p><h2><span id="å››-setstate-å®ç°">å››ã€setState å®ç°</span></h2><p>åœ¨ä¸Šé¢æˆ‘ä»¬é€šè¿‡ <code>setAttribute</code> å·²ç»å°†äº‹ä»¶ç»‘å®šåˆ°å…ƒç´ ä¸Šï¼Œäº‹ä»¶ä¸­å¾ˆæœ‰å¯èƒ½ä¼šä¿®æ”¹ç»„ä»¶çŠ¶æ€ï¼Œæ¯”å¦‚<code>this.setState({a: this.state.a + 1})</code> è¯­å¥ï¼Œä»¥æ­¤æ›´æ–°è§†å›¾ã€‚ä¸è¿‡é€šè¿‡ä¸Šé¢è™šæ‹Ÿ <code>DOM</code> è§£ææˆçœŸå® <code>DOM</code> çš„å­¦ä¹ ï¼Œåœ¨è¿™é‡Œå…ˆå¿½ç•¥ <code>DOM Diff</code> åŠŸèƒ½ï¼Œé‡æ–°æ¸²æŸ“è¿˜æ˜¯å¾ˆå¥½å®ç°çš„ï¼Œä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  setState (newState) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Component: setState'</span>)</span><br><span class="line">    <span class="built_in">Object</span>.assign(<span class="keyword">this</span>.state, newState)</span><br><span class="line">    <span class="keyword">let</span> old = <span class="keyword">this</span>.dom</span><br><span class="line">    <span class="comment">// renderComponentï¼šæ•´ä½“é‡æ–°æ¸²æŸ“ï¼Œç„¶åè¿”å›çœŸå®èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">let</span> newDom = renderComponent(<span class="keyword">this</span>)</span><br><span class="line">    old.parentNode.replaceChild(newDom, old)</span><br><span class="line">    <span class="keyword">this</span>.dom = newDom</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><a href="https://github.com/zdddrszj/react-source-study" target="_blank" rel="noopener">æºç </a></p><p>å¥½äº†ï¼Œä»Šå¤©çš„å­¦ä¹ å°±å…ˆåˆ°è¿™é‡Œå§ğŸ˜‹ğŸ˜‹ğŸ˜‹ï½</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#ä¸€-å‰è¨€&quot;&gt;ä¸€ã€å‰è¨€&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#äºŒ-createelement-å®ç°&quot;&gt;äºŒã€createElement å®ç°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ä¸‰-render-å®ç°&quot;
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://zdddrszj.github.io/h-blog/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="react" scheme="https://zdddrszj.github.io/h-blog/tags/react/"/>
    
  </entry>
  
  <entry>
    <title>bind ç®€å•ä»‹ç»</title>
    <link href="https://zdddrszj.github.io/h-blog/2018/09/13/bind-md/"/>
    <id>https://zdddrszj.github.io/h-blog/2018/09/13/bind-md/</id>
    <published>2018-09-13T11:02:49.000Z</published>
    <updated>2018-10-07T00:52:49.912Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><ul><li><a href="#ä¸€-bind-æ–¹æ³•çš„ä½œç”¨">ä¸€ã€bind æ–¹æ³•çš„ä½œç”¨</a><ul><li><a href="#1-ä¿®æ”¹-this-æŒ‡å‘">1ã€ä¿®æ”¹ this æŒ‡å‘</a></li><li><a href="#2-å¯ä»¥å®ç°åå‡½æ•°çš„æ•ˆæœ">2ã€å¯ä»¥å®ç°åå‡½æ•°çš„æ•ˆæœ</a></li><li><a href="#3-bind-å¤šæ¬¡æ—¶-this-æ€»æ˜¯æŒ‡å‘ç¬¬ä¸€æ¬¡-bind-çš„å¯¹è±¡">3ã€bind å¤šæ¬¡æ—¶ this æ€»æ˜¯æŒ‡å‘ç¬¬ä¸€æ¬¡ bind çš„å¯¹è±¡</a></li><li><a href="#4-ç»‘å®šæ„é€ å‡½æ•°">4ã€ç»‘å®šæ„é€ å‡½æ•°</a></li></ul></li><li><a href="#äºŒ-bind-æ–¹æ³•çš„å®ç°">äºŒã€bind æ–¹æ³•çš„å®ç°</a><ul><li><a href="#1-ä¿®æ”¹-this-æŒ‡å‘-1">1ã€ä¿®æ”¹ this æŒ‡å‘</a></li><li><a href="#2-å®ç°ç±»ä¼¼-curry-åŒ–çš„æ•ˆæœ">2ã€å®ç°ç±»ä¼¼ curry åŒ–çš„æ•ˆæœ</a></li><li><a href="#3-ç»‘å®šæ„é€ å‡½æ•°">3ã€ç»‘å®šæ„é€ å‡½æ•°</a></li><li><a href="#4-mozilla-å®˜æ–¹å®ç°">4ã€mozilla å®˜æ–¹å®ç°</a></li></ul></li></ul><!-- tocstop --><h3><span id="ä¸€-bind-æ–¹æ³•çš„ä½œç”¨">ä¸€ã€bind æ–¹æ³•çš„ä½œç”¨</span></h3><h4><span id="1-ä¿®æ”¹-this-æŒ‡å‘">1ã€ä¿®æ”¹ this æŒ‡å‘</span></h4><p>è¯·çœ‹å¦‚ä¸‹ä»£ç ï¼š<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> $ = <span class="built_in">document</span>.querySelector</span><br><span class="line"><span class="keyword">const</span> div = $(<span class="string">'div'</span>)</span><br><span class="line"><span class="comment">// Uncaught TypeError: Illegal invocation</span></span><br></pre></td></tr></table></figure></p><p>è¿™æ®µä»£ç æŠ¥ç±»å‹é”™è¯¯ï¼Œå› ä¸ºwindowå¯¹è±¡ä¸‹å¹¶æ²¡æœ‰querySelectoræ–¹æ³•ã€‚å¯ä»¥ç”¨bindè§£å†³ï¼Œä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> $ = <span class="built_in">document</span>.querySelector.bind(<span class="built_in">document</span>)</span><br><span class="line"><span class="keyword">const</span> div = $(<span class="string">'div'</span>)</span><br><span class="line"><span class="comment">// è¿”å›ç»“æœ &lt;div&gt;......&lt;/div&gt;</span></span><br></pre></td></tr></table></figure></p><p>å…¶ä»–å®ç°æ–¹å¼ï¼š<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> $ = <span class="built_in">document</span>.querySelector</span><br><span class="line"><span class="keyword">const</span> div = $.call(<span class="built_in">document</span>,<span class="string">'div'</span>)</span><br><span class="line"><span class="comment">// è¿”å›ç»“æœ &lt;div&gt;......&lt;/div&gt;</span></span><br></pre></td></tr></table></figure></p><p>call å’Œ apply å‡½æ•°çš„ç¼ºé™·æ˜¯ä¸èƒ½è¿”å›ä¸€ä¸ªæ–°æ–¹æ³•ã€‚</p><h4><span id="2-å¯ä»¥å®ç°åå‡½æ•°çš„æ•ˆæœ">2ã€å¯ä»¥å®ç°åå‡½æ•°çš„æ•ˆæœ</span></h4><p>bindæ–¹æ³•å¯ä»¥è¿”å›ä¸€ä¸ªæ–°å‡½æ•°ï¼Œè€Œä¸”å¯ä»¥åœ¨ç»‘å®šçš„æ—¶å€™ä¼ å…¥å…¶ä»–å‚æ•°ï¼Œæ¯”å¦‚ï¼š<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sum = <span class="function">(<span class="params">...args</span>) =&gt;</span> args.reduce(<span class="function">(<span class="params">prev,next</span>) =&gt;</span> prev+next, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">const</span> sum2 = sum.bind(<span class="literal">null</span>, <span class="number">1</span>)</span><br><span class="line"><span class="built_in">console</span>.log(sum2(<span class="number">1</span>, <span class="number">2</span>)) <span class="comment">// 4</span></span><br></pre></td></tr></table></figure></p><h4><span id="3-bind-å¤šæ¬¡æ—¶-this-æ€»æ˜¯æŒ‡å‘ç¬¬ä¸€æ¬¡-bind-çš„å¯¹è±¡">3ã€bind å¤šæ¬¡æ—¶ this æ€»æ˜¯æŒ‡å‘ç¬¬ä¸€æ¬¡ bind çš„å¯¹è±¡</span></h4><p>è¿è¡Œå¦‚ä¸‹ä»£ç ï¼š<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getName = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">this</span>.name)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> p1 = &#123;</span><br><span class="line">  name:<span class="string">'zhangsan'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> p2= &#123;</span><br><span class="line">  name: <span class="string">'lisi'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> name = getName.bind(p1).bind(p2)</span><br><span class="line">name() <span class="comment">// zhangsan</span></span><br></pre></td></tr></table></figure></p><h4><span id="4-ç»‘å®šæ„é€ å‡½æ•°">4ã€ç»‘å®šæ„é€ å‡½æ•°</span></h4><p>è¿è¡Œå¦‚ä¸‹ä»£ç ï¼š<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span> (<span class="params">firstName, lastName</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.firstName = firstName</span><br><span class="line">  <span class="keyword">this</span>.lastName = lastName</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">this</span>.firstName + <span class="keyword">this</span>.lastName)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> Person(<span class="string">'zhang'</span>, <span class="string">'san'</span>) <span class="comment">// zhangsan</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> P = Person.bind(<span class="literal">null</span>, <span class="string">'li'</span>)</span><br><span class="line"><span class="keyword">const</span> p3 = <span class="keyword">new</span> P(<span class="string">'si'</span>) <span class="comment">// lisi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(p <span class="keyword">instanceof</span> Person) <span class="comment">// true</span></span><br><span class="line"><span class="built_in">console</span>.log(p3 <span class="keyword">instanceof</span> Person) <span class="comment">// true</span></span><br></pre></td></tr></table></figure></p><p>ä»å¦‚ä¸Šç»“æœå¯ä»¥çœ‹å‡ºï¼Œ<code>bind</code> å®ç°ä¸­è¦æ ¹æ®å½“å‰è°ƒç”¨å‡½æ•° <code>this</code> æ˜¯å¦æ˜¯è¢«ç»‘å®šå‡½æ•°çš„å®ä¾‹ï¼Œå¦‚æœæ˜¯ï¼Œä¿®æ”¹ <code>this</code> ä¸ºå½“å‰è°ƒç”¨è€…çš„ <code>this</code></p><h3><span id="äºŒ-bind-æ–¹æ³•çš„å®ç°">äºŒã€bind æ–¹æ³•çš„å®ç°</span></h3><blockquote><p>è¯­æ³•ï¼š<code>fun.bind(thisArg[, arg1[, arg2[, ...]]])</code><br>  å‚æ•°ï¼š<code>thisArg</code> -&gt; è°ƒç”¨ç»‘å®šå‡½æ•°æ—¶ä½œä¸ºthiså‚æ•°ä¼ é€’ç»™ç›®æ ‡å‡½æ•°çš„å€¼ã€‚<br>        <code>arg1, arg2, ... -&gt;</code> å½“ç»‘å®šå‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œè¿™äº›å‚æ•°å°†ç½®äºå®å‚ä¹‹å‰ä¼ é€’ç»™è¢«ç»‘å®šçš„æ–¹æ³•ã€‚<br> è¿”å›å€¼ï¼šè¿”å›ç”±æŒ‡å®šçš„ <code>this</code> å€¼å’Œåˆå§‹åŒ–å‚æ•°æ”¹é€ çš„åŸå‡½æ•°æ‹·è´</p></blockquote><h4><span id="1-ä¿®æ”¹-this-æŒ‡å‘">1ã€ä¿®æ”¹ this æŒ‡å‘</span></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.bind = <span class="function"><span class="keyword">function</span> (<span class="params">oThis</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> self = <span class="keyword">this</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    self.apply(oThis, <span class="built_in">arguments</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="2-å®ç°ç±»ä¼¼-curry-åŒ–çš„æ•ˆæœ">2ã€å®ç°ç±»ä¼¼ curry åŒ–çš„æ•ˆæœ</span></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.bind = <span class="function"><span class="keyword">function</span> (<span class="params">oThis</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> self = <span class="keyword">this</span></span><br><span class="line">  <span class="keyword">var</span> aArgs = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> self.apply(oThis, aArgs.concat(<span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>)))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="3-ç»‘å®šæ„é€ å‡½æ•°">3ã€ç»‘å®šæ„é€ å‡½æ•°</span></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.bind = <span class="function"><span class="keyword">function</span> (<span class="params">oThis</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> self = <span class="keyword">this</span></span><br><span class="line">  <span class="keyword">var</span> aArgs = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>)</span><br><span class="line">  <span class="keyword">const</span> fun = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> fBound = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">const</span> currentThis = <span class="keyword">this</span> <span class="keyword">instanceof</span> fun ? <span class="keyword">this</span> : oThis</span><br><span class="line">    <span class="keyword">return</span> self.apply(currentThis, aArgs.concat(<span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>)))</span><br><span class="line">  &#125;</span><br><span class="line">  fun.prototype = <span class="keyword">this</span>.prototype</span><br><span class="line">  fBound.prototype = <span class="keyword">new</span> fun()</span><br><span class="line">  <span class="keyword">return</span> fBound</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="4-mozilla-å®˜æ–¹å®ç°">4ã€mozilla å®˜æ–¹å®ç°</span></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="built_in">Function</span>.prototype.bind) &#123;</span><br><span class="line">  <span class="built_in">Function</span>.prototype.bind = <span class="function"><span class="keyword">function</span>(<span class="params">oThis</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span> !== <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="comment">// closest thing possible to the ECMAScript 5</span></span><br><span class="line">      <span class="comment">// internal IsCallable function</span></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Function.prototype.bind - what is trying to be bound is not callable'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> aArgs   = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>),</span><br><span class="line">        fToBind = <span class="keyword">this</span>,</span><br><span class="line">        fNOP    = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;,</span><br><span class="line">        fBound  = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="comment">// this instanceof fNOP === trueæ—¶,è¯´æ˜è¿”å›çš„fBoundè¢«å½“åšnewçš„æ„é€ å‡½æ•°è°ƒç”¨</span></span><br><span class="line">          <span class="keyword">return</span> fToBind.apply(<span class="keyword">this</span> <span class="keyword">instanceof</span> fNOP</span><br><span class="line">                 ? <span class="keyword">this</span></span><br><span class="line">                 : oThis,</span><br><span class="line">                 <span class="comment">// è·å–è°ƒç”¨æ—¶(fBound)çš„ä¼ å‚.bind è¿”å›çš„å‡½æ•°å…¥å‚å¾€å¾€æ˜¯è¿™ä¹ˆä¼ é€’çš„</span></span><br><span class="line">                 aArgs.concat(<span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>)));</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»´æŠ¤åŸå‹å…³ç³»</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.prototype) &#123;</span><br><span class="line">      <span class="comment">// Function.prototype doesn't have a prototype property</span></span><br><span class="line">      fNOP.prototype = <span class="keyword">this</span>.prototype; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸‹è¡Œçš„ä»£ç ä½¿fBound.prototypeæ˜¯fNOPçš„å®ä¾‹,å› æ­¤</span></span><br><span class="line">    <span class="comment">// è¿”å›çš„fBoundè‹¥ä½œä¸ºnewçš„æ„é€ å‡½æ•°,newç”Ÿæˆçš„æ–°å¯¹è±¡ä½œä¸ºthisä¼ å…¥fBound,æ–°å¯¹è±¡çš„__proto__å°±æ˜¯fNOPçš„å®ä¾‹</span></span><br><span class="line">    fBound.prototype = <span class="keyword">new</span> fNOP();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fBound;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#ä¸€-bind-æ–¹æ³•çš„ä½œç”¨&quot;&gt;ä¸€ã€bind æ–¹æ³•çš„ä½œç”¨&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-ä¿®æ”¹-this-æŒ‡å‘&quot;&gt;1ã€ä¿®æ”¹ this æŒ‡å‘&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-å¯ä»¥å®ç°åå‡½æ•°
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://zdddrszj.github.io/h-blog/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="bind" scheme="https://zdddrszj.github.io/h-blog/tags/bind/"/>
    
  </entry>
  
  <entry>
    <title>Promise ç®€å•å®ç°</title>
    <link href="https://zdddrszj.github.io/h-blog/2018/07/19/promiseAchieved/"/>
    <id>https://zdddrszj.github.io/h-blog/2018/07/19/promiseAchieved/</id>
    <published>2018-07-19T03:42:24.000Z</published>
    <updated>2018-10-07T00:52:49.913Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><ul><li><a href="#ä¸€-promise-æ„é€ å‡½æ•°å®ç°">ä¸€ã€Promise æ„é€ å‡½æ•°å®ç°</a></li><li><a href="#äºŒ-promisethen-å®ç°">äºŒã€Promise.then å®ç°</a><ul><li><a href="#1-then-è®¢é˜…åŠŸèƒ½">1ã€then è®¢é˜…åŠŸèƒ½</a></li><li><a href="#2-then-è¿”å›-promise">2ã€then è¿”å› promise</a></li><li><a href="#2-then-è°ƒç”¨å¤šæ¬¡">2ã€then è°ƒç”¨å¤šæ¬¡</a></li><li><a href="#3-çŠ¶æ€ä¸å¯é€†è½¬">3ã€çŠ¶æ€ä¸å¯é€†è½¬</a></li><li><a href="#4-promisethen-å¼‚æ­¥æ‰§è¡Œ">4ã€Promise.then å¼‚æ­¥æ‰§è¡Œ</a></li><li><a href="#5-promisethen-ç©¿é€">5ã€Promise.then ç©¿é€</a></li></ul></li><li><a href="#ä¸‰-å…¶å®ƒæ–¹æ³•å®ç°">ä¸‰ã€å…¶å®ƒæ–¹æ³•å®ç°</a><ul><li><a href="#1-promiseresolve">1ã€Promise.resolve</a></li><li><a href="#2-promisereject">2ã€Promise.reject</a></li><li><a href="#3-promiseall">3ã€Promise.all</a></li><li><a href="#4-promiserace">4ã€Promise.race</a></li><li><a href="#5-promisepromisify">5ã€Promise.promisify</a></li></ul></li><li><a href="#å››-promise-æ ¡éªŒ">å››ã€Promise æ ¡éªŒ</a></li></ul><!-- tocstop --><p>ä»Šå¤©çš„ä»»åŠ¡æ˜¯æ ¹æ®<code>Promise A+</code> è§„èŒƒç®€å•å®ç°ä¸€ä¸ª <code>Promise</code> åº“ã€‚å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆé€šè¯»ä¸€ä¸‹è¿™ä¸ªè§„èŒƒï¼Œ<a href="https://promisesaplus.com/" target="_blank" rel="noopener">æˆ³è¿™é‡Œ</a>ã€‚</p><p>é™å¿ƒè¯»ä¸€ä¸‹è¿™ä¸ªè§„èŒƒçœŸçš„å¾ˆé‡è¦ï¼Œå¾ˆé‡è¦ï¼Œå¾ˆé‡è¦ã€‚è™½ç„¶æ˜¯è‹±æ–‡ç‰ˆï¼Œä½†æ˜¯è¯»èµ·æ¥ä¹Ÿè®¸ä¼šæ¯”æ±‰è¯­æ›´èƒ½è®©äººç†è§£ã€‚</p><p><code>A promise represents the eventual result of an asynchronous operation. The primary way of interacting with a promise is through its then method, which registers callbacks to receive either a promiseâ€™s eventual value or the reason why the promise cannot be fulfilled.</code></p><p>æåˆ° <code>Promise</code> è‡ªç„¶æƒ³åˆ°å¼‚æ­¥ï¼Œå¼‚æ­¥æƒ³åˆ°å›è°ƒï¼Œå›è°ƒå°±æ˜¯å›å¤´åœ¨è°ƒã€‚å›å¤´åœ¨è°ƒçš„å‰ææ˜¯æå‰å­˜å‚¨å›è°ƒå†…å®¹ï¼Œç­‰åˆ°æ—¶é—´åä»å­˜å‚¨çš„åœ°æ–¹å–åˆ°å¯¹åº”çš„å†…å®¹å†æ‰§è¡Œå³å¯ã€‚</p><h2><span id="ä¸€-promise-æ„é€ å‡½æ•°å®ç°">ä¸€ã€Promise æ„é€ å‡½æ•°å®ç°</span></h2><p><code>2.1 A promise must be in one of three states: pending, fulfilled, or rejected.</code></p><p><code>2.1.1 A pending promise may transition to either the fulfilled or rejected state.</code></p><p><code>2.1.2 A fulfilled promise must have a value, which must not change.</code></p><p><code>2.1.3 A rejected promise must have a reason, which must not change.</code></p><p>æˆ‘ä»¬å¹³æ—¶ä½†å‡¡åšä»€ä¹ˆäº‹æƒ…ï¼Œå¤§æ¦‚éƒ½æœ‰ä¸‰ç§åŸºæœ¬çŠ¶æ€ï¼Œæ­£åœ¨è¿›è¡Œã€æˆåŠŸã€å¤±è´¥ã€‚ä¸€ä¸ª <code>Promise</code> ä»£è¡¨ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œä¹Ÿæœ‰è¿™ä¸‰ç§çŠ¶æ€ï¼Œä¸”çŠ¶æ€åªèƒ½ä»æ­£åœ¨è¿›è¡Œåˆ°æˆåŠŸæˆ–è€…å¤±è´¥ï¼Œä¸å¯é€†è½¬ã€‚ä¸ç®¡äº‹æƒ…æœ€ç»ˆä»€ä¹ˆçŠ¶æ€ï¼Œæ—¢ç„¶ç»“æœå‡ºæ¥äº†ï¼Œé‚£å°±é€šçŸ¥ä¹‹å‰ç¼“å­˜å›è°ƒçš„æ•°ç»„ï¼ˆå› ä¸ºå¯ä»¥ <code>then</code> å¤šæ¬¡ï¼Œæ•…ä¸ºæ•°ç»„ï¼‰å¹¶æŠŠç»“æœç»™å®ƒå§ã€‚</p><p><code>Promise</code> åŸºæœ¬ä½¿ç”¨ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        resolve(<span class="string">'success'</span>)</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line">promise.then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;<span class="built_in">console</span>.log(data)&#125;)</span><br></pre></td></tr></table></figure></p><p>é¦–å…ˆ <code>Promise</code> æ˜¯ä¸€ä¸ªç±»ï¼Œé€šè¿‡ <code>new</code> åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œå‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°å‚æ•°é»˜è®¤å‘½åä¸º <code>resolve</code> å’Œ <code>reject</code>ï¼Œæˆ‘ä»¬ç§°è¯¥å‡½æ•°ä¸ºä¸€ä¸ªæ‰§è¡Œå™¨ <code>executor</code>ï¼Œé»˜è®¤æ‰§è¡Œã€‚æ„é€ å‡½ä¸­è¿˜éœ€è¦ä¸€ä¸ªçŠ¶æ€å˜é‡ <code>status</code>ï¼Œä¿å­˜å½“å‰æ‰§è¡ŒçŠ¶æ€ï¼›ä»¥åŠæ‰§è¡ŒæˆåŠŸ <code>value</code> æˆ–å¤±è´¥ <code>reason</code> çš„ç»“æœå˜é‡ï¼›æœ€åè¿˜éœ€è¦ä¸Šé¢æåŠçš„ç¼“å­˜å›è°ƒçš„æ•°ç»„ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Promise</span> () </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span> (executor) &#123;</span><br><span class="line">        <span class="comment">// é»˜è®¤ç­‰å¾…æ€</span></span><br><span class="line">        <span class="keyword">this</span>.status = <span class="string">'pending'</span></span><br><span class="line">        <span class="comment">// æˆåŠŸç»“æœ</span></span><br><span class="line">        <span class="keyword">this</span>.value = <span class="literal">undefined</span></span><br><span class="line">        <span class="comment">// å¤±è´¥åŸå› </span></span><br><span class="line">        <span class="keyword">this</span>.reason = <span class="literal">undefined</span></span><br><span class="line">        <span class="comment">// å­˜å‚¨æˆåŠŸå›è°ƒæ•°ç»„</span></span><br><span class="line">        <span class="keyword">this</span>.onResolvedCallbacks = []</span><br><span class="line">        <span class="comment">// å­˜å‚¨å¤±è´¥å›è°ƒæ•°ç»„</span></span><br><span class="line">        <span class="keyword">this</span>.onRejectedCallbacks = []</span><br><span class="line">        <span class="comment">// æ‰§è¡Œå™¨</span></span><br><span class="line">        executor(resolve, reject)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ‰§è¡Œå™¨å‡½æ•°å‚æ•°æ˜¯ <code>resolve</code> å’Œ <code>reject</code>ï¼Œ åŒæ ·ä¹Ÿæ˜¯å‡½æ•°ï¼ŒåŠŸèƒ½æ˜¯æœ‰ç»“æœåè§¦å‘ç¼“å­˜å›è°ƒæ•°ç»„ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºå‘å¸ƒã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Promise</span> () </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span> (executor) &#123;</span><br><span class="line">        <span class="comment">// å˜é‡å£°æ˜</span></span><br><span class="line">        <span class="keyword">this</span>.status = <span class="string">'pending'</span></span><br><span class="line">        <span class="keyword">this</span>.value = <span class="literal">undefined</span></span><br><span class="line">        <span class="keyword">this</span>.reason = <span class="literal">undefined</span></span><br><span class="line">        <span class="keyword">this</span>.onResolvedCallbacks = []</span><br><span class="line">        <span class="keyword">this</span>.onRejectedCallbacks = []</span><br><span class="line">        <span class="comment">// ç»“æœæˆåŠŸï¼Œé€šçŸ¥å‡½æ•°å®šä¹‰</span></span><br><span class="line">        <span class="keyword">let</span> resolve = <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.status === <span class="string">'pending'</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.status = <span class="string">'resolved'</span></span><br><span class="line">                <span class="keyword">this</span>.value = value</span><br><span class="line">                <span class="keyword">this</span>.onFulfilledCallbacks.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn())</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ç»“æœå¤±è´¥ï¼Œé€šçŸ¥å‡½æ•°å®šä¹‰</span></span><br><span class="line">        <span class="keyword">let</span> reject = <span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.status === <span class="string">'pending'</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.status = <span class="string">'rejected'</span></span><br><span class="line">                <span class="keyword">this</span>.reason = reason</span><br><span class="line">                <span class="keyword">this</span>.onRejectedCallbacks.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn())</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            executor(resolve, reject)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            reject(e)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ—¢ç„¶æœ‰ç»“æœåè¦è§¦å‘ç¼“å­˜å›è°ƒæ•°ç»„ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªå›è°ƒæ•°ç»„å¦‚ä½•ç¼“å­˜ã€‚</p><h2><span id="äºŒ-promisethen-å®ç°">äºŒã€Promise.then å®ç°</span></h2><p><code>2.2 A promise must provide a then method to access its current or eventual value or reason.</code></p><h3><span id="1-then-è®¢é˜…åŠŸèƒ½">1ã€then è®¢é˜…åŠŸèƒ½</span></h3><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œ<code>promise</code> å®ä¾‹åªæœ‰é€šè¿‡è°ƒç”¨ <code>then</code> å‡½æ•°æ‰èƒ½æ‹¿åˆ°ç»“æœï¼Œ<code>then</code> å‡½æ•°å‚æ•°åˆ†åˆ«ä¸ºæˆåŠŸå›è°ƒå’Œå¤±è´¥å›è°ƒï¼Œå›è°ƒå‚æ•°ä¸ºæˆåŠŸå€¼å’Œå¤±è´¥å€¼ã€‚å›º <code>then</code> å‡½æ•°çš„ä¸»è¦åŠŸèƒ½å³æ˜¯ç¼“å­˜å›è°ƒå‡½æ•°ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºè®¢é˜…ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Promise</span> () </span>&#123;</span><br><span class="line">    <span class="comment">// constructorçœç•¥...</span></span><br><span class="line">    then (onFulfilled, onRejected) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœexectorå†…å®¹ä¸ºåŒæ­¥ä»£ç ï¼Œresolveå‡½æ•°æ‰§è¡Œåï¼ŒçŠ¶æ€å·²å˜ä¸ºresolvedï¼Œåˆ™ç›´æ¥æ‰§è¡Œå›è°ƒ</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.status === <span class="string">'resolved'</span>) &#123;</span><br><span class="line">            onFulfilled(<span class="keyword">this</span>.value)</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">// å¦‚æœexectorå†…å®¹ä¸ºåŒæ­¥ä»£ç ï¼Œrejectå‡½æ•°æ‰§è¡Œåï¼ŒçŠ¶æ€å·²å˜ä¸ºrejectedï¼Œç›´æ¥æ‰§è¡Œå›è°ƒ</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.status === <span class="string">'rejected'</span>) &#123;</span><br><span class="line">           onRejected(<span class="keyword">this</span>.reason)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœexectorå†…å®¹ä¸ºå¼‚æ­¥ä»£ç ï¼ŒçŠ¶æ€ä¸ºpendingæ—¶ï¼Œåˆ™ç¼“å­˜å›è°ƒå‡½æ•°ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç†è§£ä¸ºè®¢é˜…</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.status === <span class="string">'pending'</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.onResolvedCallbacks.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">               onFulfilled(<span class="keyword">this</span>.value)</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">this</span>.onRejectedCallbacks.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                onRejected(<span class="keyword">this</span>.reason)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="2-then-è¿”å›-promise">2ã€then è¿”å› promise</span></h3><p><code>2.2.6 Then may be called multiple times on the same promise.</code></p><p><code>2.2.7 Then must return a promise. promise2 = promise1.then(onFulfilled, onRejected)</code></p><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Promise</span> () </span>&#123;</span><br><span class="line">    <span class="comment">// constructorçœç•¥...</span></span><br><span class="line">    then (onFulfilled, onRejected) &#123;</span><br><span class="line">        <span class="keyword">let</span> promise2</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.status === <span class="string">'resolved'</span>) &#123;</span><br><span class="line">            promise2 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">                onFulfilled(<span class="keyword">this</span>.value)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.status === <span class="string">'rejected'</span>) &#123;</span><br><span class="line">            promise2 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">                onRejected(<span class="keyword">this</span>.reason)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.status === <span class="string">'pending'</span>) &#123;</span><br><span class="line">            promise2 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.onResolvedCallbacks.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    onFulfilled(<span class="keyword">this</span>.value)</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="keyword">this</span>.onRejectedCallbacks.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    onRejected(<span class="keyword">this</span>.reason)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> promise2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3><span id="2-then-è°ƒç”¨å¤šæ¬¡">2ã€then è°ƒç”¨å¤šæ¬¡</span></h3><p><code>2.2.7.1 onFulfilled or onRejected returns a value x, run the Promise Resolution Procedure [[Resolve]](promise2, x).</code></p><p><code>then</code> å¯ä»¥è°ƒç”¨å¤šæ¬¡ï¼Œä¸”æ¯æ¬¡ <code>then</code> å‚æ•° <code>onFulFilled</code> å‡½æ•°çš„å‚æ•°å€¼ä¸ºä¸Šä¸€æ¬¡ <code>promise</code> å‡½æ•°çš„æ‰§è¡Œç»“æœï¼Œå³ä¸º <code>onFulfilled(this.value)</code> çš„æ‰§è¡Œç»“æœï¼Œæˆ‘ä»¬è®¾ä¸º <code>x</code>ã€‚æ ¹æ® <code>x</code> çš„ä¸åŒæƒ…å†µåšä¸åŒå¤„ç†ï¼Œè¯¦æƒ…è§ <code>Promise A+</code> è§„èŒƒ <code>2.3 Promise Resolution Procedure</code>ã€‚</p><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Promise</span> () </span>&#123;</span><br><span class="line">    <span class="comment">// constructorçœç•¥...</span></span><br><span class="line">    then (onFulfilled, onRejected) &#123;</span><br><span class="line">        <span class="keyword">let</span> promise2</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.status === <span class="string">'resolved'</span>) &#123;</span><br><span class="line">            promise2 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> x = onFulfilled(<span class="keyword">this</span>.value)</span><br><span class="line">                <span class="comment">// Promise Resolution Procedure</span></span><br><span class="line">                resolvePromise(promise2, x, resolve. reject)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.status === <span class="string">'rejected'</span>) &#123;</span><br><span class="line">            promise2 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> x = onRejected(<span class="keyword">this</span>.reason)</span><br><span class="line">                <span class="comment">// Promise Resolution Procedure</span></span><br><span class="line">                resolvePromise(promise2, x, resolve. reject)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.status === <span class="string">'pending'</span>) &#123;</span><br><span class="line">            promise2 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.onResolvedCallbacks.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> x = onFulfilled(<span class="keyword">this</span>.value)</span><br><span class="line">                    <span class="comment">// Promise Resolution Procedure</span></span><br><span class="line">                    resolvePromise(promise2, x, resolve. reject)</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="keyword">this</span>.onRejectedCallbacks.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> x = onRejected(<span class="keyword">this</span>.reason)</span><br><span class="line">                    resolvePromise(promise2, x, resolve, reject)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> promise2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¤„ç†å‡½æ•°ï¼šå¤„ç†promise2å’Œxçš„å…³ç³»</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span> (<span class="params">promise2, x, resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 2.3.1 If promise and x refer to the same object, reject promise with a TypeError as the reason.</span></span><br><span class="line">    <span class="keyword">if</span> (promise2 === x) &#123;</span><br><span class="line">        <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'å¾ªç¯å¼•ç”¨'</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//  2.3.3 if x is an object or function</span></span><br><span class="line">    <span class="keyword">if</span> (x !== <span class="literal">null</span> &amp;&amp; <span class="keyword">typeof</span> x === <span class="string">'object'</span> || <span class="keyword">typeof</span> x === <span class="string">'function'</span> )&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 2.3.3.1 Let then be x.then.</span></span><br><span class="line">            <span class="keyword">let</span> then = x.then</span><br><span class="line">            <span class="comment">// 2.3.3.3 If then is a functionï¼Œcall it with x as this.</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> then === <span class="string">'function'</span>) &#123;</span><br><span class="line">                <span class="comment">// 2.3.3.3.1 If/when resolvePromise is called with a value y, run [[Resolve]](promise, y)</span></span><br><span class="line">                then.call(x, y =&gt; &#123;</span><br><span class="line">                    resolvePromise(promise2, y, resolve, reject)</span><br><span class="line">                &#125;, r =&gt; &#123;</span><br><span class="line">                    <span class="comment">// 2.3.3.3.2 If/when rejectPromise is called with a reason r, reject promise with r.</span></span><br><span class="line">                    reject(r)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="comment">// 2.3.3.4 If calling then throws an exception e</span></span><br><span class="line">            reject(e)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 2.3.4 If x is not an object or function, fulfill promise with x.</span></span><br><span class="line">        resolve(x)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3><span id="3-çŠ¶æ€ä¸å¯é€†è½¬">3ã€çŠ¶æ€ä¸å¯é€†è½¬</span></h3><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¤„ç†å‡½æ•°ï¼šå¤„ç†promise2å’Œxçš„å…³ç³»</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span> (<span class="params">promise2, x, resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 2.3.1 If promise and x refer to the same object, reject promise with a TypeError as the reason.</span></span><br><span class="line">    <span class="keyword">if</span> (promise2 === x) &#123;</span><br><span class="line">        <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'å¾ªç¯å¼•ç”¨'</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> called</span><br><span class="line">    <span class="comment">//  2.3.3 if x is an object or function</span></span><br><span class="line">    <span class="keyword">if</span> (x !== <span class="literal">null</span> &amp;&amp; <span class="keyword">typeof</span> x === <span class="string">'object'</span> || <span class="keyword">typeof</span> x === <span class="string">'function'</span> )&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 2.3.3.1 Let then be x.then.</span></span><br><span class="line">            <span class="keyword">let</span> then = x.then</span><br><span class="line">            <span class="comment">// 2.3.3.3 If then is a functionï¼Œcall it with x as this.</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> then === <span class="string">'function'</span>) &#123;</span><br><span class="line">                <span class="comment">// 2.3.3.3.1 If/when resolvePromise is called with a value y, run [[Resolve]](promise, y)</span></span><br><span class="line">                then.call(x, y =&gt; &#123;</span><br><span class="line">                    <span class="comment">// `2.3.3.3.3 If both resolvePromise and rejectPromise are called, or multiple calls to the same argument are made, the first call takes precedence, and any further calls are ignored.`</span></span><br><span class="line">                    <span class="keyword">if</span> (called) <span class="keyword">return</span></span><br><span class="line">                    called = <span class="literal">true</span></span><br><span class="line">                    resolvePromise(promise2, y, resolve, reject)</span><br><span class="line">                &#125;, r =&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> (called) <span class="keyword">return</span></span><br><span class="line">                    called = <span class="literal">true</span></span><br><span class="line">                    <span class="comment">// 2.3.3.3.2 If/when rejectPromise is called with a reason r, reject promise with r.</span></span><br><span class="line">                    reject(r)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="comment">// `2.3.3.3.4 If calling then throws an exception eï¼Œ2.3.3.3.4.1 If resolvePromise or rejectPromise have been called, ignore it.`</span></span><br><span class="line">            <span class="keyword">if</span> (called) <span class="keyword">return</span></span><br><span class="line">            called = <span class="literal">true</span></span><br><span class="line">            <span class="comment">// 2.3.3.4 If calling then throws an exception e</span></span><br><span class="line">            reject(e)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 2.3.4 If x is not an object or function, fulfill promise with x.</span></span><br><span class="line">        resolve(x)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3><span id="4-promisethen-å¼‚æ­¥æ‰§è¡Œ">4ã€Promise.then å¼‚æ­¥æ‰§è¡Œ</span></h3><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Promise</span> () </span>&#123;</span><br><span class="line">    then (onFulfilled, onRejected) &#123;</span><br><span class="line">        <span class="keyword">let</span> promise2</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.status === <span class="string">'resolved'</span>) &#123;</span><br><span class="line">            promise2 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">                setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> x = onFulfilled(<span class="keyword">this</span>.value)</span><br><span class="line">                        resolvePromise(promise2, x, resolve, reject)</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                        reject(e)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="number">0</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.status === <span class="string">'rejected'</span>) &#123;</span><br><span class="line">            promise2 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">                setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> x = onRejected(<span class="keyword">this</span>.reason)</span><br><span class="line">                        resolvePromise(promise2, x, resolve, reject)</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                        reject(e)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;. <span class="number">0</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.status === <span class="string">'pending'</span>) &#123;</span><br><span class="line">            promise2 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.onResolvedCallbacks.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">let</span> x = onFulfilled(<span class="keyword">this</span>.value)</span><br><span class="line">                            promiseResolve(promise2, x, resolve, reject)</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                            reject(e)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;, <span class="number">0</span>)</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="keyword">this</span>.onRejectedCallbacks.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">let</span> x = onRejected(<span class="keyword">this</span>.reason)</span><br><span class="line">                            promiseResolve(promise2, x, resolve, reject)</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                            reject(e)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;, <span class="number">0</span>)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> promise2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3><span id="5-promisethen-ç©¿é€">5ã€Promise.then ç©¿é€</span></h3><p><code>promise.then().then()</code> å¤šæ¬¡ï¼Œéƒ½å¯ä»¥è·å–åˆ°æœ€ç»ˆç»“æœï¼Œå›ºå½“ <code>then</code> å‚æ•° <code>onFulfilled</code> ä¸ºç©ºæ—¶ï¼Œéœ€è¦è‡ªåŠ¨ <code>return value</code>ï¼›å½“ <code>onRejected</code>  ä¸ºç©ºæ—¶ï¼Œéœ€è¦ <code>return throw err</code>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Promise</span> () </span>&#123;</span><br><span class="line">    then (onFulfilled, onRejected) &#123;</span><br><span class="line">        onFulfilled = <span class="keyword">typeof</span> onFulfilled === <span class="string">'function'</span> ? onFulfilled : <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="keyword">return</span> value &#125;</span><br><span class="line">        onRejected = <span class="keyword">typeof</span> onRejected === <span class="string">'function'</span> ? onRejected : <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="keyword">throw</span> err &#125;</span><br><span class="line">        <span class="comment">// promise2çœç•¥...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2><span id="ä¸‰-å…¶å®ƒæ–¹æ³•å®ç°">ä¸‰ã€å…¶å®ƒæ–¹æ³•å®ç°</span></h2><h3><span id="1-promiseresolve">1ã€Promise.resolve</span></h3><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.resolve = <span class="function"><span class="keyword">function</span> (<span class="params">val</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        resolve(val)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3><span id="2-promisereject">2ã€Promise.reject</span></h3><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.reject = <span class="function"><span class="keyword">function</span> (<span class="params">val</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        reject(val)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3><span id="3-promiseall">3ã€Promise.all</span></h3><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.all = <span class="function"><span class="keyword">function</span> (<span class="params">promises</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> dataArr = []</span><br><span class="line">        <span class="keyword">let</span> count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; promises.length; i++) &#123;</span><br><span class="line">            promises[i].then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">                dataArr[i] = data</span><br><span class="line">                count++</span><br><span class="line">                <span class="keyword">if</span> (count === promises.lenth) &#123;</span><br><span class="line">                    resolve(dataArr)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, reject)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3><span id="4-promiserace">4ã€Promise.race</span></h3><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.race = <span class="function"><span class="keyword">function</span> (<span class="params">promises</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; promises.length; i++) &#123;</span><br><span class="line">            promise[i].then(resolve, reject)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3><span id="5-promisepromisify">5ã€Promise.promisify</span></h3><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.promisify = <span class="function"><span class="keyword">function</span> (<span class="params">fn</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">...args</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            fn(...args, (err, data) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (err) reject(err)</span><br><span class="line">                resolve(data)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2><span id="å››-promise-æ ¡éªŒ">å››ã€Promise æ ¡éªŒ</span></h2><p>è¦æƒ³éªŒè¯è‡ªå·±å®ç°çš„ <code>Promise</code> æ˜¯å¦ç¬¦åˆ <code>Promise A+</code> è§„èŒƒï¼Œå¯ä»¥å…¨å±€å®‰è£… <code>promises-aplus-tests</code> å·¥å…·åŒ…ã€‚</p><p><code>Adapters</code>ï¼š</p><p><code>In order to test your promise library, you must expose a very minimal adapter interface. These are written as Node.js modules with a few well-known exports:</code></p><ul><li><code>resolved(value): creates a promise that is resolved with value.</code></li><li><code>rejected(reason): creates a promise that is already rejected with reason.</code></li><li><code>deferred(): creates an object consisting of { promise, resolve, reject }</code></li></ul><blockquote><p><code>The resolved and rejected exports are actually optional, and will be automatically created by the test runner using deferred</code></p></blockquote><p><code>resolved</code> å’Œ <code>rejected</code> æ˜¯å¯é€‰çš„ï¼Œä¸‹é¢æˆ‘ä»¬å®ç°ä¸€ä¸‹ <code>deferred</code>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.deferred = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> dfd = &#123;&#125;</span><br><span class="line">    dfd.promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        dfd.resolve = resolve</span><br><span class="line">        dfd.reject = reject</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> dfd</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åˆ°è¿™é‡Œä¸€åˆ‡å‡†å¤‡å°±ç»ªï¼Œæ ¡éªŒæ­¥éª¤å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install promises-aplus-tests -g</span><br><span class="line">promises-aplus-tests ./Promise.js</span><br></pre></td></tr></table></figure></p><p><br></p><p><a href="https://github.com/zdddrszj/promise" target="_blank" rel="noopener">æºç </a></p><p>å¥½äº†ï¼Œåˆ°è¿™é‡Œå…¨éƒ¨ä»£ç éƒ½å·²å‘ˆç°ï¼Œèµ¶å¿«è‡ªå·±äº²æ‰‹è¯•ä¸€ä¸‹å§ï¼ğŸ˜‹ğŸ˜‹ğŸ˜‹</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#ä¸€-promise-æ„é€ å‡½æ•°å®ç°&quot;&gt;ä¸€ã€Promise æ„é€ å‡½æ•°å®ç°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#äºŒ-promisethen-å®ç°&quot;&gt;äºŒã€Promise.then å®ç°&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://zdddrszj.github.io/h-blog/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="promise" scheme="https://zdddrszj.github.io/h-blog/tags/promise/"/>
    
  </entry>
  
  <entry>
    <title>ReadableStream ç®€å•å®ç°</title>
    <link href="https://zdddrszj.github.io/h-blog/2018/07/12/readableStream/"/>
    <id>https://zdddrszj.github.io/h-blog/2018/07/12/readableStream/</id>
    <published>2018-07-12T07:42:44.000Z</published>
    <updated>2018-10-07T00:52:49.913Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><ul><li><a href="#ä¸€-åˆ›å»ºå¯è¯»æµ">ä¸€ã€åˆ›å»ºå¯è¯»æµ</a></li><li><a href="#äºŒ-è¯»å–é•¿åº¦å°äºæ°´ä½çº¿">äºŒã€è¯»å–é•¿åº¦å°äºæ°´ä½çº¿</a></li><li><a href="#ä¸‰-è¯»å–é•¿åº¦ç­‰äºæ°´ä½çº¿">ä¸‰ã€è¯»å–é•¿åº¦ç­‰äºæ°´ä½çº¿</a></li><li><a href="#å››-è¯»å–é•¿åº¦å¤§äºæ°´ä½çº¿">å››ã€è¯»å–é•¿åº¦å¤§äºæ°´ä½çº¿</a></li></ul><!-- tocstop --><p>ä»Šå¤©çš„æ–‡ç« éœ€è¦æå‰äº†è§£ä¸€ä¸‹ <code>node</code> ä¸­ <code>fs</code> æ¨¡å—çš„ç›¸å…³ <code>api</code>ï¼Œä¸å¤ªç†Ÿæ‚‰çš„åŒå­¦å¯ä»¥<a href="http://nodejs.cn/api/fs.html" target="_blank" rel="noopener">ç‚¹è¿™é‡Œ</a>ã€‚</p><blockquote><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œ<code>node</code> ä¸­çš„ <code>fs</code> æ¨¡å—åŠŸèƒ½å¤§éƒ½ä¸æ–‡ä»¶ç›¸å…³ï¼Œæ¯”å¦‚å¯ä»¥é€šè¿‡ <code>fs.createReadStream</code> åˆ›å»ºæ–‡ä»¶å¯è¯»æµï¼Œé€šè¿‡<code>fs.createWriteStream</code> åˆ›å»ºæ–‡ä»¶å¯å†™æµï¼Œè¿˜å¯ä»¥é€šè¿‡ç›‘å¬ <code>open</code>ã€<code>data</code>ã€<code>end</code>ã€<code>error</code>ã€<code>readable</code> äº‹ä»¶å¯¹æ•°æ®è¿›è¡Œæ“ä½œã€‚ç”±äºæ—¶é—´æœ‰é™ï¼Œä»Šå¤©æˆ‘ä»¬å…ˆæ¥å®ç°ä¸€ä¸‹ <code>readable</code> äº‹ä»¶åŠŸèƒ½ã€‚</p></blockquote><p>å¼€å§‹ä¹‹å‰ï¼Œå…ˆç®€å•ä»‹ç»ä¸€ä¸‹å¯è¯»æµå‡½æ•° <code>fs.createReadStream(path[, options])</code> ä¸­å„å‚æ•°æ‰€ä»£è¡¨çš„å«ä¹‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><ul><li><code>path &lt;string&gt; | &lt;Buffer&gt; | &lt;URL&gt;</code> åˆ›å»ºå¯è¯»æµçš„è·¯å¾„</li><li><code>options &lt;string&gt; | &lt;Object&gt;</code> å¯é€‰å‚æ•°<ul><li><code>flags &lt;string&gt;</code> æ–‡ä»¶è¯»å†™æ ‡è¯†ï¼Œé»˜è®¤ä¸º r</li><li><code>encoding &lt;string&gt;</code> è¯»å–ç¼–ç æ ¼å¼ï¼Œé»˜è®¤ä¸º null</li><li><code>fd &lt;integer&gt;</code> æ–‡ä»¶æè¿°ç¬¦ï¼Œé»˜è®¤ä¸º null</li><li><code>mode &lt;integer&gt;</code> æ–‡ä»¶æ“ä½œæƒé™ï¼Œé»˜è®¤ä¸º 0o666</li><li><code>autoClose &lt;boolean&gt;</code> æ–‡ä»¶æ˜¯å¦è‡ªåŠ¨å…³é—­ï¼Œé»˜è®¤ä¸º true</li><li><code>start &lt;integer&gt;</code> æ–‡ä»¶è¯»å–å¼€å§‹ä½ç½®ï¼Œé»˜è®¤ä¸º 0</li><li><code>end &lt;integer&gt;</code> æ–‡ä»¶è¯»å–ç»“æŸä½ç½®ï¼Œé»˜è®¤ä¸º Infinity</li><li><code>highWaterMark &lt;integer&gt;</code> æ°´ä½çº¿ï¼Œæ¯æ¬¡è¯»å–é•¿åº¦ï¼Œé»˜è®¤ä¸º 64å­—èŠ‚ï¼ˆ64 * 1024ï¼‰</li></ul></li></ul><h2><span id="ä¸€-åˆ›å»ºå¯è¯»æµ">ä¸€ã€åˆ›å»ºå¯è¯»æµ</span></h2><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªå¯è¯»æµçš„ç±»ï¼Œä¸é˜²å®šä¹‰ä¸º <code>ReadableStream</code>ï¼Œè¯¥ç±»å¯ä»¥é€šè¿‡ <code>on</code> å‡½æ•°è¿›è¡Œäº‹ä»¶ç›‘å¬ï¼Œæ‰€ä»¥éœ€è¦ç»§æ‰¿ <code>node</code> ä¸­ <code>EventEmitter</code> ç±»ï¼›<br>å½“ç›‘å¬ <code>readable</code> å‡½æ•°æ—¶å¯è¯»å–åˆ°æ–‡ä»¶å†…å®¹ï¼Œç”±æ­¤å¾—çŸ¥åœ¨æ„é€ å‡½æ•°ä¸­é™¤äº†éœ€è¦å®šä¹‰ä¸Šé¢çš„å˜é‡ï¼Œè¿˜éœ€è¦è°ƒç”¨æ‰“å¼€æ–‡ä»¶å’Œç¬¬ä¸€æ¬¡è¯»å–æ–‡ä»¶çš„åŠŸèƒ½ã€‚ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">let</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReadableStream</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(path, options) &#123;</span><br><span class="line">    <span class="keyword">super</span>()</span><br><span class="line">    <span class="keyword">this</span>.path = path</span><br><span class="line">    <span class="keyword">this</span>.flags = options.flags || <span class="string">'r'</span></span><br><span class="line">    <span class="keyword">this</span>.encoding = options.encoding || <span class="literal">null</span></span><br><span class="line">    <span class="keyword">this</span>.autoClose = options.autoClose || <span class="literal">true</span></span><br><span class="line">    <span class="keyword">this</span>.highWaterMark = options.highWaterMark || <span class="number">64</span> * <span class="number">1024</span></span><br><span class="line">    <span class="keyword">this</span>.start = options.start || <span class="number">0</span></span><br><span class="line">    <span class="keyword">this</span>.end = options.end || <span class="literal">null</span></span><br><span class="line">    <span class="keyword">this</span>.mode = options.mode || <span class="number">0o666</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦æ­£åœ¨è¯»å–æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">this</span>.reading = <span class="literal">false</span></span><br><span class="line">    <span class="comment">// å½“len=0æ—¶ï¼Œè§¦å‘readableäº‹ä»¶</span></span><br><span class="line">    <span class="keyword">this</span>.emitReadable = <span class="literal">false</span></span><br><span class="line">    <span class="comment">// ç¼“å­˜ä¸­å­—èŠ‚çš„é•¿åº¦</span></span><br><span class="line">    <span class="keyword">this</span>.len = <span class="number">0</span></span><br><span class="line">    <span class="comment">// ç¼“å­˜æ¯æ¬¡è¯»å–çš„å†…å®¹ï¼Œæ ¼å¼ä¸º[&lt;Buffer /&gt;, &lt;Buffer /&gt;, ...]</span></span><br><span class="line">    <span class="keyword">this</span>.arr = []</span><br><span class="line">    <span class="comment">// æ–‡ä»¶è¯»å–çš„ä½ç½®</span></span><br><span class="line">    <span class="keyword">this</span>.pos = <span class="keyword">this</span>.start</span><br><span class="line">    <span class="comment">// æ˜¯å¦æ–‡ä»¶å…¨éƒ¨è¯»å–å®Œ</span></span><br><span class="line">    <span class="keyword">this</span>.finished = <span class="literal">false</span></span><br><span class="line">    <span class="comment">// æ‰“å¼€æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">this</span>.open()</span><br><span class="line">    <span class="comment">// åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç›‘å¬äº†readableäº‹ä»¶</span></span><br><span class="line">    <span class="keyword">this</span>.on(<span class="string">'newListener'</span>, (type) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (type === <span class="string">'readable'</span>) &#123;</span><br><span class="line">        <span class="comment">// ç¬¬ä¸€æ¬¡æ–‡ä»¶è¯»å–</span></span><br><span class="line">        <span class="keyword">this</span>.read()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = ReadableStream</span><br></pre></td></tr></table></figure></p><p>æ„é€ å‡½æ•°ä¸­å…¶å®ƒå˜é‡å¯ä»¥å…ˆå¿½ç•¥ï¼Œåˆ°å®ç°é˜¶æ®µæ—¶æˆ‘ç›¸ä¿¡å¤§å®¶è‡ªç„¶æ¸…æ™°å…¶ç”¨å¤„ã€‚<br>ä¸‹é¢åˆ©ç”¨ <code>fs.open</code> å’Œ <code>fs.destory</code> å®ç° <code>open</code> å’Œ <code>destory</code> åŠŸèƒ½ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰“å¼€å¯è¯»æµ</span></span><br><span class="line">open() &#123;</span><br><span class="line">  fs.open(<span class="keyword">this</span>.path, <span class="keyword">this</span>.flags, (err, fd) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">this</span>.emit(<span class="string">'error'</span>)</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.autoClose) &#123;</span><br><span class="line">        <span class="keyword">this</span>.destory()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.fd = fd</span><br><span class="line">    <span class="keyword">this</span>.emit(<span class="string">'open'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å…³é—­å¯è¯»æµï¼Œå‚æ•°ä¸ºæ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">destory() &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span>.fd === <span class="string">'number'</span>) &#123;</span><br><span class="line">    fs.close(<span class="keyword">this</span>.fd, () =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.emit(<span class="string">'close'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.emit(<span class="string">'close'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ¥ä¸‹æ¥çœ‹ä¸‹åˆæ¬¡è¯»å–æ—¶çš„ <code>read</code> å‡½æ•°ã€‚</p><blockquote><p>å®ç°æ€è·¯ï¼šåœ¨æ„é€ å‡½æ•°ä¸­ï¼Œå½“è§¦å‘ç¬¬ä¸€æ¬¡è¯»å–æ–‡ä»¶æ—¶ï¼Œè¯»å–å¤§å°ä¸º <code>highWaterMark</code> ä¸ªï¼Œä¸é˜²æˆ‘ä»¬å°†æ¯”è¾ƒè¯»å–é•¿åº¦å’Œç¼“å­˜é•¿åº¦çš„æ–¹æ³•è®¾å®šä¸º <code>read</code>ã€‚ç„¶åå† <code>read</code> å‡½æ•°ä¸­åˆ¤æ–­ï¼Œå¦‚æœç¼“å­˜åŒºé•¿åº¦ä¸º <code>0</code> æ—¶ï¼Œè¡¨æ˜å¯ä»¥è§¦å‘ <code>readable</code> äº‹ä»¶ï¼›å¦‚æœç¼“å­˜åŒºé•¿åº¦å°äºæ°´ä½çº¿æ—¶ï¼Œåˆ™è¿›è¡Œæ–‡ä»¶è¯»å–ï¼Œæ­¤æ—¶æˆ‘ä»¬å°†çœŸæ­£è¯»å–æ–‡ä»¶çš„å‡½æ•°å‘½åä¸º <code>_read</code>ï¼›æœ€åï¼Œæ ¹æ®ç¼–ç æ ¼å¼è¿›è¡Œè¿”å›æ•°æ®ã€‚</p></blockquote><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReadableStream</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å¯è¯»æµå®ä¾‹è°ƒç”¨çš„æ–¹æ³•</span></span><br><span class="line">  read () &#123;</span><br><span class="line">    <span class="keyword">let</span> buffer = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœç¼“å­˜åŒºé•¿åº¦ä¸º0æ—¶ï¼Œè¡¨æ˜å¯ä»¥è§¦å‘readableäº‹ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.len === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.emitReadable = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœç¼“å­˜åŒºé•¿åº¦å°äºæ°´ä½çº¿æ—¶ï¼Œåˆ™è¿›è¡Œæ–‡ä»¶è¯»å–</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.len &lt; <span class="keyword">this</span>.highWaterMark) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.reading) &#123;</span><br><span class="line">        <span class="keyword">this</span>.reading = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">this</span>._read()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®ç¼–ç æ–¹å¼å¤„ç†æ•°æ®</span></span><br><span class="line">    <span class="keyword">if</span> (buffer) &#123;</span><br><span class="line">      buffer = <span class="keyword">this</span>.encoding ? buffer.toString(<span class="keyword">this</span>.encoding) : buffer</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> buffer</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// çœŸå®è¯»å–æ–‡ä»¶çš„æ–¹æ³•</span></span><br><span class="line">  _read () &#123;</span><br><span class="line">    <span class="comment">// å› ä¸ºæ‰“å¼€æ–‡ä»¶ä¸ºå¼‚æ­¥æ“ä½œï¼Œå½“è¯»å–æ—¶æ–‡ä»¶æœªæ‰“å¼€ï¼Œå¯ä»¥é€šè¿‡æ³¨å†Œä¸€æ¬¡openäº‹ä»¶ï¼Œæ‰“å¼€åæ‰§è¡Œå›è°ƒå³å¯æ‹¿åˆ°this.fd</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span>.fd !== <span class="string">'number'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.once(<span class="string">'open'</span>, () =&gt; <span class="keyword">this</span>._read())</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> howMuchToRead = <span class="keyword">this</span>.end ? <span class="built_in">Math</span>.min(<span class="keyword">this</span>.highWaterMark, <span class="keyword">this</span>.end - <span class="keyword">this</span>.pos + <span class="number">1</span>) : <span class="keyword">this</span>.highWaterMark</span><br><span class="line">    <span class="keyword">let</span> buffer = Buffer.alloc(howMuchToRead)</span><br><span class="line">    fs.read(<span class="keyword">this</span>.fd, buffer, <span class="number">0</span>, <span class="keyword">this</span>.howMuchToRead, <span class="keyword">this</span>.pos, (err, bytesRead) =&gt; &#123;</span><br><span class="line">      <span class="comment">// bytesRead ä¸ºæ–‡ä»¶è¯»å–åˆ°çš„é•¿åº¦</span></span><br><span class="line">      <span class="keyword">if</span> (bytesRead &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// å°†è¯»å–çš„å†…å®¹ç¼“å­˜åˆ°arræ•°ç»„ä¸­</span></span><br><span class="line">        <span class="keyword">this</span>.arr.push(buffer)</span><br><span class="line">        <span class="comment">// ç›¸å…³å˜é‡æ›´æ–°</span></span><br><span class="line">        <span class="keyword">this</span>.len += bytesRead</span><br><span class="line">        <span class="keyword">this</span>.pos += bytesRead</span><br><span class="line">        <span class="keyword">this</span>.reading = <span class="literal">false</span></span><br><span class="line">        <span class="comment">// ç¼“å­˜åè§¦å‘å®ä¾‹ä¸Šç”¨æˆ·è°ƒç”¨çš„readå‡½æ•°</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.emitReadable) &#123;</span><br><span class="line">          <span class="keyword">this</span>.emitReadable = <span class="literal">false</span></span><br><span class="line">          <span class="keyword">this</span>.emit(<span class="string">'readable'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å½“å‰ <code>1.txt</code> æ–‡ä»¶ä¸­çš„å†…å®¹ä¸º <code>1234567890</code>ã€‚è°ƒç”¨æ–¹å¼å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">let</span> ReadableStream = <span class="built_in">require</span>(<span class="string">'./ReadableStream'</span>)</span><br><span class="line"><span class="keyword">let</span> rs = <span class="keyword">new</span> ReadableStream(<span class="string">'./1.txt'</span>, &#123;</span><br><span class="line">  autoClose: <span class="literal">true</span>,</span><br><span class="line">  start: <span class="number">0</span>,</span><br><span class="line">  flags: <span class="string">'r'</span>,</span><br><span class="line">  encoding: <span class="string">'utf8'</span>,</span><br><span class="line">  highWaterMark: <span class="number">3</span></span><br><span class="line">&#125;)</span><br><span class="line">rs.on(<span class="string">'readable'</span>, () =&gt; &#123;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><p>æ¥ä¸‹æ¥ä»ç¼“å­˜åŒºä¸­è¯»å–æ•°æ®ã€‚</p><h2><span id="äºŒ-è¯»å–é•¿åº¦å°äºæ°´ä½çº¿">äºŒã€è¯»å–é•¿åº¦å°äºæ°´ä½çº¿</span></h2><p>å½“è¯»å–é•¿åº¦å°äºæ°´ä½çº¿æ—¶ï¼Œä½¿ç”¨åŸç”Ÿæ–¹å¼è°ƒç”¨ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">let</span> rs = fs.createReadStream(<span class="string">'./1.txt'</span>, &#123;</span><br><span class="line">  autoClose: <span class="literal">true</span>,</span><br><span class="line">  start: <span class="number">0</span>,</span><br><span class="line">  flags: <span class="string">'r'</span>,</span><br><span class="line">  encoding: <span class="string">'utf8'</span>,</span><br><span class="line">  highWaterMark: <span class="number">3</span></span><br><span class="line">&#125;)</span><br><span class="line">rs.on(<span class="string">'readable'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> r = rs.read(<span class="number">2</span>)</span><br><span class="line">  <span class="comment">// è¾“å‡ºç»“æœä¸º 12</span></span><br><span class="line">  <span class="built_in">console</span>.log(r)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><p>ç”±æ­¤å¯çŸ¥ï¼Œå¦‚æœç¼“å†²åŒºå†…å®¹å¤Ÿè¯»ï¼Œåˆ™è¿”å›ç»“æœç»“æŸè¯»å–ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReadableStream</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯è¯»æµå®ä¾‹è°ƒç”¨çš„æ–¹æ³•</span></span><br><span class="line">  read (n) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå‚æ•°ä¸ºç©ºä¸”ä¸æ˜¯åœ¨æ„é€ å‡½æ•°ä¸­è°ƒç”¨æ­¤å‡½æ•°ï¼Œn é»˜è®¤æŒ‰highWaterMarkå¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> n === <span class="string">'undefined'</span> &amp;&amp; <span class="keyword">this</span>.pos &gt; <span class="keyword">this</span>.start) &#123;</span><br><span class="line">      n = <span class="keyword">this</span>.highWaterMark</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœè¯»å–é•¿åº¦å°äºç¼“å­˜åŒºé•¿åº¦ï¼Œthis.read(2) highWaterMark=3</span></span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">0</span> &amp;&amp; n &lt;= <span class="keyword">this</span>.len) &#123;</span><br><span class="line">      buffer = Buffer.alloc(n)</span><br><span class="line">      <span class="keyword">let</span> current</span><br><span class="line">      <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">      <span class="keyword">let</span> flag = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">while</span> (flag &amp;&amp; (current = <span class="keyword">this</span>.arr.shift())) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; current.length; i++) &#123;</span><br><span class="line">          buffer[index++] = current[i]</span><br><span class="line">          <span class="keyword">if</span> (index === n) &#123;</span><br><span class="line">            flag = <span class="literal">false</span></span><br><span class="line">            <span class="keyword">let</span> other = current.slice(i + <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> (other.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="keyword">this</span>.arr.unshift(other)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.len -= n</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœç¼“å­˜åŒºé•¿åº¦ä¸º0æ—¶ï¼Œè¡¨æ˜å¯ä»¥è§¦å‘readableäº‹ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.len === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.emitReadable = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœç¼“å­˜åŒºé•¿åº¦å°äºæ°´ä½çº¿æ—¶ï¼Œåˆ™è¿›è¡Œæ–‡ä»¶è¯»å–</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.len &lt; <span class="keyword">this</span>.highWaterMark) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.reading) &#123;</span><br><span class="line">        <span class="keyword">this</span>.reading = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">this</span>._read()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®ç¼–ç æ–¹å¼å¤„ç†æ•°æ®</span></span><br><span class="line">    <span class="keyword">if</span> (buffer) &#123;</span><br><span class="line">      buffer = <span class="keyword">this</span>.encoding ? buffer.toString(<span class="keyword">this</span>.encoding) : buffer</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> buffer</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2><span id="ä¸‰-è¯»å–é•¿åº¦ç­‰äºæ°´ä½çº¿">ä¸‰ã€è¯»å–é•¿åº¦ç­‰äºæ°´ä½çº¿</span></h2><p>å½“è¯»å–é•¿åº¦ç­‰äºæ°´ä½çº¿æ—¶ï¼Œä½¿ç”¨åŸç”Ÿæ–¹å¼è°ƒç”¨ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">let</span> rs = fs.createReadStream(<span class="string">'./1.txt'</span>, &#123;</span><br><span class="line">  autoClose: <span class="literal">true</span>,</span><br><span class="line">  start: <span class="number">0</span>,</span><br><span class="line">  flags: <span class="string">'r'</span>,</span><br><span class="line">  encoding: <span class="string">'utf8'</span>,</span><br><span class="line">  highWaterMark: <span class="number">2</span></span><br><span class="line">&#125;)</span><br><span class="line">rs.on(<span class="string">'readable'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> r = rs.read(<span class="number">2</span>)</span><br><span class="line">  <span class="comment">// è¾“å‡ºç»“æœä¸º 12 34 56 78 90 null</span></span><br><span class="line">  <span class="built_in">console</span>.log(r)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><p>ç”±æ­¤å¯çŸ¥ï¼Œå¦‚æœç¼“å†²åŒºå†…å®¹è¯»å®Œä¸ºç©ºï¼Œåˆ™è¿”å›ç»“æœç»§ç»­è¯»å–ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReadableStream</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line"></span><br><span class="line">  read (n) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœè¯»å–é•¿åº¦ç­‰äºæ°´ä½çº¿ï¼Œthis.len ç­‰äº 0ï¼Œè¡¨æ˜å¯ä»¥è§¦å‘readableäº‹ä»¶ï¼Œå›º_readåä¼šè§¦å‘readableå‡½æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.len === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.emitReadable = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœç¼“å­˜åŒºé•¿åº¦å°äºæ°´ä½çº¿æ—¶ï¼Œåˆ™è¿›è¡Œæ–‡ä»¶è¯»å–</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.len &lt; <span class="keyword">this</span>.highWaterMark) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.reading) &#123;</span><br><span class="line">        <span class="keyword">this</span>.reading = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">this</span>._read()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> buffer</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2><span id="å››-è¯»å–é•¿åº¦å¤§äºæ°´ä½çº¿">å››ã€è¯»å–é•¿åº¦å¤§äºæ°´ä½çº¿</span></h2><p>å½“è¯»å–é•¿åº¦å¤§äºæ°´ä½çº¿æ—¶ï¼Œä½¿ç”¨åŸç”Ÿæ–¹å¼è°ƒç”¨ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">let</span> rs = fs.createReadStream(<span class="string">'./1.txt'</span>, &#123;</span><br><span class="line">  autoClose: <span class="literal">true</span>,</span><br><span class="line">  start: <span class="number">0</span>,</span><br><span class="line">  flags: <span class="string">'r'</span>,</span><br><span class="line">  encoding: <span class="string">'utf8'</span>,</span><br><span class="line">  highWaterMark: <span class="number">3</span></span><br><span class="line">&#125;)</span><br><span class="line">rs.on(<span class="string">'readable'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> r = rs.read(<span class="number">8</span>)</span><br><span class="line">  <span class="comment">// è¾“å‡ºç»“æœä¸º null 12345678 90</span></span><br><span class="line">  <span class="built_in">console</span>.log(r)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><p>ç”±æ­¤å¯çŸ¥ï¼Œå¦‚æœç¼“å†²åŒºå†…å®¹ä¸å¤Ÿè¯»ï¼Œåˆæ¬¡ä¼šè¿”å› <code>null</code>ï¼Œç„¶åä¿®æ”¹ <code>highWaterMark</code> å€¼ç»§ç»­è¯»å–è¿”å›ï¼Œå³ä¸º <code>12345678</code>ã€‚æ­¤æ—¶ï¼Œ<code>this.len</code> ä¸ç­‰äº <code>0</code> ä¸”å°äº <code>this.highWaterMark</code>ï¼Œä¼šå†æ¬¡è°ƒç”¨ <code>_read</code> æ–¹æ³•ï¼Œå¦‚æœè¯»å–æ–‡ä»¶ä¸ºç©ºï¼Œåˆ™éœ€è¦æ‰‹åŠ¨è§¦å‘ä¸€ä¸‹ <code>readable</code> äº‹ä»¶ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReadableStream</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯è¯»æµå®ä¾‹è°ƒç”¨çš„æ–¹æ³•</span></span><br><span class="line">  read (n) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœthis.read(8) highWaterMark=3 </span></span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="keyword">this</span>.len) &#123;</span><br><span class="line">      <span class="comment">// ä¸å¤Ÿè¯»æ—¶ä¸”æ–‡ä»¶æ²¡æœ‰è¯»å–å®Œï¼Œä¿®æ”¹highWaterMarkç»§ç»­è¯»å–</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.finished) &#123;</span><br><span class="line">        <span class="keyword">this</span>.highWaterMark = computeNewHighWaterMark(n)</span><br><span class="line">        <span class="keyword">this</span>.reading = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">this</span>.emitReadable = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">this</span>._read()</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦åˆ™ç›´æ¥è¿”å›ç¼“å­˜æ•°æ®</span></span><br><span class="line">        buffer = <span class="keyword">this</span>.arr.shift()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> buffer</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// çœŸå®è¯»å–æ–‡ä»¶çš„æ–¹æ³•</span></span><br><span class="line">  _read () &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line"></span><br><span class="line">    fs.read(<span class="keyword">this</span>.fd, buffer, <span class="number">0</span>, howMuchToRead, <span class="keyword">this</span>.pos, (err, bytesRead) =&gt; &#123;</span><br><span class="line">      <span class="comment">// bytesRead ä¸ºæ–‡ä»¶è¯»å–åˆ°çš„é•¿åº¦</span></span><br><span class="line">      <span class="keyword">if</span> (bytesRead &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// this.lenä¸ç­‰äº0ä¸”å°äºthis.highWaterMarkï¼Œéœ€è¦æ‰‹åŠ¨è§¦å‘ä¸€ä¸‹readableäº‹ä»¶</span></span><br><span class="line">        <span class="keyword">this</span>.finished = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.len) &#123;</span><br><span class="line">          <span class="keyword">this</span>.emit(<span class="string">'readable'</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>.emit(<span class="string">'end'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è®¡ç®— <code>highWaterMark</code> çš„å‡½æ•°å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">computeNewHighWaterMark</span> (<span class="params">n</span>) </span>&#123;</span><br><span class="line">  n--;</span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">  n++;</span><br><span class="line">  <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><a href="https://github.com/zdddrszj/code/blob/master/stream/readableStream/index.js" target="_blank" rel="noopener">æºç </a></p><p>ğŸ˜‹ğŸ˜‹ğŸ˜‹ï¼Œå¥½äº†ï¼Œå…¨éƒ¨åŠŸèƒ½å·²ç»å®ç°ï¼Œå°±åˆ°æ­¤ç»“æŸå§ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#ä¸€-åˆ›å»ºå¯è¯»æµ&quot;&gt;ä¸€ã€åˆ›å»ºå¯è¯»æµ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#äºŒ-è¯»å–é•¿åº¦å°äºæ°´ä½çº¿&quot;&gt;äºŒã€è¯»å–é•¿åº¦å°äºæ°´ä½çº¿&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ä¸‰-è¯»å–é•¿åº¦ç­‰äºæ°´ä½çº¿&quot;&gt;ä¸‰ã€è¯»å–é•¿åº¦ç­‰
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://zdddrszj.github.io/h-blog/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="ReadableStream" scheme="https://zdddrszj.github.io/h-blog/tags/ReadableStream/"/>
    
  </entry>
  
  <entry>
    <title>å®ç° CommonJs è§„èŒƒä¸­çš„ Require æ¨¡å—</title>
    <link href="https://zdddrszj.github.io/h-blog/2018/06/25/requireAchieved/"/>
    <id>https://zdddrszj.github.io/h-blog/2018/06/25/requireAchieved/</id>
    <published>2018-06-25T05:22:26.000Z</published>
    <updated>2018-10-07T00:52:49.913Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><ul><li><a href="#ä¸€-æ„é€ reqå‡½æ•°">ä¸€ã€æ„é€ reqå‡½æ•°</a></li><li><a href="#äºŒ-æ„é€ moduleå‡½æ•°">äºŒã€æ„é€ Moduleå‡½æ•°</a></li></ul><!-- tocstop --><p>å¼€å§‹ä¹‹å‰å¤§å®¶è¦å…ˆç†Ÿæ‚‰ä¸‹ <code>node</code> ä¸­å¸¸ç”¨æ–‡ä»¶è¯»å†™ï¼Œè·¯å¾„æ“ä½œç­‰ <code>API</code>ã€‚</p><blockquote><p>å®ç°æ€è·¯ï¼šæˆ‘ä»¬é€šè¿‡å®šä¹‰ä¸€ä¸ª <code>req</code> å‡½æ•°ï¼Œä»£æ›¿ <code>node</code> ä¸­çš„ <code>require</code> ï¼Œè¿™ä¸ªå‡½æ•°é¦–å…ˆä¼šæ ¹æ®è·¯å¾„å‚æ•°è¿›è¡Œè·¯å¾„è§£æï¼Œæ‰¾åˆ°å¯¹åº”æ–‡ä»¶ï¼›ç„¶ååˆ¤æ–­ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨è¯¥æ–‡ä»¶å¯¹è±¡ï¼Œå­˜åœ¨åˆ™è¿”å›ï¼Œå¦åˆ™åˆ›å»ºè¯¥æ–‡ä»¶å¯¹è±¡ï¼Œæ­¤æ—¶ä¸é˜²é€šè¿‡ <code>new</code> ä¸€ä¸ª <code>Module</code> å‡½æ•°å®ä¾‹æ¥åˆ›å»ºï¼›å†ç„¶åï¼Œé€šè¿‡ <code>node</code> ä¸­ <code>fs</code> æ¨¡å—çš„ <code>readFileSync</code> æ–¹æ³•åŠ è½½æ–‡ä»¶ï¼Œå¹¶æŠŠæ–‡ä»¶å†…å®¹æ”¾åœ¨é—­åŒ…å‡½æ•°ä¸­ï¼Œå‡½æ•°å‚æ•°æœ‰<code>exports</code>ã€<code>require</code>ã€<code>module</code>ï¼Œé€šè¿‡ <code>node</code> ä¸­ <code>vm</code> æ¨¡å—çš„ <code>runInThisContext</code> æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ²™ç®±ç¯å¢ƒï¼ŒåŒæ—¶åˆ†åˆ«ç»™ <code>exports</code>ã€<code>require</code>ã€<code>module</code> å‚æ•°èµ‹å€¼å¹¶æ‰§è¡Œï¼Œæœ€åç¼“å­˜æ¨¡å—å¹¶é€šè¿‡ <code>module.exports</code> è¿”å›æ–‡ä»¶å†…å®¹ã€‚</p><h2><span id="ä¸€-æ„é€ reqå‡½æ•°">ä¸€ã€æ„é€ reqå‡½æ•°</span></h2><p>è¯¦ç»†ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">req</span> (<span class="params">path</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å…ˆè¦æ ¹æ®è·¯å¾„å˜æˆä¸€ä¸ªç»å¯¹è·¯å¾„</span></span><br><span class="line">  <span class="keyword">let</span> filename = Module._resolveFilename(path)</span><br><span class="line">  <span class="comment">// æ–‡ä»¶è·¯å¾„å”¯ä¸€</span></span><br><span class="line">  <span class="keyword">if</span> (Module._cache[filename]) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœåŠ è½½è¿‡ ç›´æ¥æŠŠåŠ è½½è¿‡çš„ç»“æœè¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> Module._cache[filename].exports</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// é€šè¿‡æ–‡ä»¶ååˆ›å»ºä¸€ä¸ªæ¨¡å—</span></span><br><span class="line">  <span class="keyword">let</span> <span class="built_in">module</span> = <span class="keyword">new</span> Module(filename)</span><br><span class="line">  <span class="comment">// åŠ è½½æ¨¡å—ï¼Œæ ¹æ®ä¸åŒåç¼€åŠ è½½ä¸åŒå†…å®¹</span></span><br><span class="line">  <span class="built_in">module</span>.load()</span><br><span class="line">  <span class="comment">// è¿›è¡Œæ¨¡å—ç¼“å­˜</span></span><br><span class="line">  Module._cache[filename] = <span class="built_in">module</span></span><br><span class="line">  <span class="comment">// è¿”å›æœ€åçš„ç»“æœ</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">module</span>.exports</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><h2><span id="äºŒ-æ„é€ moduleå‡½æ•°">äºŒã€æ„é€ Moduleå‡½æ•°</span></h2><p>è¯¦ç»†ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">let</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Module</span>(<span class="params">filename</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// é»˜è®¤æ¨¡å—æœªåŠ è½½è¿‡</span></span><br><span class="line">  <span class="keyword">this</span>.loaded = <span class="literal">false</span></span><br><span class="line">  <span class="comment">// æ¨¡å—çš„ç»å¯¹è·¯å¾„</span></span><br><span class="line">  <span class="keyword">this</span>.filename = filename</span><br><span class="line">  <span class="comment">// æ¨¡å—å¯¼å‡ºçš„ç»“æœ</span></span><br><span class="line">  <span class="keyword">this</span>.exports = &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è·¯å¾„è§£ææ–¹æ³•å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Module._resolveFilename = <span class="function"><span class="keyword">function</span> (<span class="params">p</span>) </span>&#123;</span><br><span class="line">  p = path.join(__dirname, p)</span><br><span class="line">  <span class="comment">// å¦‚æœæ–‡ä»¶æœ‰åç¼€</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="regexp">/\.\w+$/</span>.test(p)) &#123;</span><br><span class="line">    <span class="comment">// æ·»åŠ æ‰©å±•å</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; Module._extensions.length; i++) &#123;</span><br><span class="line">      <span class="comment">// æ‹¼å‡ºä¸€ä¸ªè·¯å¾„</span></span><br><span class="line">      <span class="keyword">let</span> filePath = p + Module._extensions[i]</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        fs.accessSync(filePath)</span><br><span class="line">        <span class="comment">// è¿”å›æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">        <span class="keyword">return</span> filePath</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœaccessSyncæ–¹æ³•æŠ¥é”™ï¼Œè¯´æ˜æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºæ–‡ä»¶æœªæ‰¾åˆ°å¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">if</span> (i &gt; Module._extensions.length) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'module not found'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¦åˆ™ç›´æ¥è¿”å›æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">    <span class="keyword">return</span> p</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>Module</code> å‡½æ•°çš„ä¸»è¦åŠŸèƒ½å³æ˜¯ <code>load</code> æ–¹æ³•ï¼Œå¦‚æœç›®æ ‡æ–‡ä»¶æ˜¯ <code>js</code> æ–‡ä»¶ï¼Œåˆ™æŒ‰ç…§ <code>js</code> æ–¹å¼åŠ è½½ï¼Œå¦‚æœç›®æ ‡æ–‡ä»¶æ˜¯ <code>json</code> æ–‡ä»¶ï¼Œåˆ™æŒ‰ç…§ <code>json</code> æ–¹å¼åŠ è½½ã€‚è¯¦ç»†ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> vm = <span class="built_in">require</span>(<span class="string">'vm'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¨¡å—åŠ è½½å‡½æ•°</span></span><br><span class="line">Module.prototype.load = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å–åˆ°æ–‡ä»¶åç§°åç¼€</span></span><br><span class="line">  <span class="keyword">let</span> extname = path.extname(<span class="keyword">this</span>.filename)</span><br><span class="line">  <span class="comment">// æ ¹æ®ä¸åŒåç¼€è¯»å–æ–‡ä»¶å†…å®¹</span></span><br><span class="line">  Module._extensions[extname](<span class="keyword">this</span>)</span><br><span class="line">  <span class="comment">// æ ‡è®°æ¨¡å—å·²åŠ è½½</span></span><br><span class="line">  <span class="keyword">this</span>.loaded = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¨¡å—ç¼“å­˜å¯¹è±¡</span></span><br><span class="line">Module._cache = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–‡ä»¶åç¼€</span></span><br><span class="line">Module._extensions = [<span class="string">'.js'</span>, <span class="string">'.json'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// jsonæ ¼å¼æ–‡ä»¶è¯»å–æ–¹å¼</span></span><br><span class="line">Module._extensions[<span class="string">'.json'</span>] = <span class="function"><span class="keyword">function</span> (<span class="params">module</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> content = fs.readFileSync(<span class="built_in">module</span>.filename, <span class="string">'utf8'</span>)</span><br><span class="line">  <span class="built_in">module</span>.exports = <span class="built_in">JSON</span>.parse(content)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºæ‰§è¡Œjsæ²™ç®±ç¯å¢ƒæ—¶éœ€è¦</span></span><br><span class="line">Module.wrapper = [<span class="string">'(function (exports, require, module)&#123;'</span>, <span class="string">'\n&#125;)'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// jsä»£ç æ‹¼æ¥</span></span><br><span class="line">Module.wrap = <span class="function"><span class="keyword">function</span> (<span class="params">content</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Module.wrapper[<span class="number">0</span>] + content + Module.wrapper[<span class="number">1</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// jsæ ¼å¼æ–‡ä»¶è¯»å–æ–¹å¼</span></span><br><span class="line">Module._extensions[<span class="string">'.js'</span>] = <span class="function"><span class="keyword">function</span> (<span class="params">module</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è¯»å–æ–‡ä»¶</span></span><br><span class="line">  <span class="keyword">let</span> content = fs.readFileSync(<span class="built_in">module</span>.filename, <span class="string">'utf8'</span>)</span><br><span class="line">  <span class="comment">// æŠŠæ–‡ä»¶å†…å®¹æ”¾åˆ°é—­åŒ…å‡½æ•°ä¸­</span></span><br><span class="line">  <span class="keyword">let</span> script = Module.wrap(content)</span><br><span class="line">  <span class="comment">// åˆ›å»ºä¸å½±å“å¤–ç•Œä¸Šä¸‹æ–‡çš„æ²™ç®±ç¯å¢ƒ</span></span><br><span class="line">  <span class="keyword">let</span> fn = vm.runInThisContext(script)</span><br><span class="line">  <span class="comment">// è®©é—­åŒ…å‡½æ•°æ‰§è¡Œï¼ŒåŒæ—¶ç»™å‡½æ•°ä¸­export require moduleå˜é‡èµ‹å€¼</span></span><br><span class="line">  fn.call(<span class="built_in">module</span>.exports, <span class="built_in">module</span>.exports, req, <span class="built_in">module</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å¥½äº†ï¼Œå®ç°èµ·æ¥æ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Œä¸‹é¢æµ‹è¯•ä¸€ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨åŒçº§ç›®å½•ä¸‹åˆ›å»ºtest.js</span></span><br><span class="line"><span class="comment">// module.exports = 'Hello World'</span></span><br><span class="line"><span class="keyword">let</span> str = req(<span class="string">'./test'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(str)</span><br></pre></td></tr></table></figure></p><p><a href="https://github.com/zdddrszj/code/blob/master/require/index.js" target="_blank" rel="noopener">æºç </a></p><p>å¥½äº†ï¼Œåˆ°è¿™é‡Œå…¨éƒ¨ä»£ç å·²ç»ç»™å‡ºï¼Œå°±åˆ°æ­¤ä¸ºæ­¢å§~ ğŸ˜‹ğŸ˜‹ğŸ˜‹</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#ä¸€-æ„é€ reqå‡½æ•°&quot;&gt;ä¸€ã€æ„é€ reqå‡½æ•°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#äºŒ-æ„é€ moduleå‡½æ•°&quot;&gt;äºŒã€æ„é€ Moduleå‡½æ•°&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;!-- tocstop --&gt;
&lt;p&gt;å¼€å§‹
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://zdddrszj.github.io/h-blog/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="require" scheme="https://zdddrszj.github.io/h-blog/tags/require/"/>
    
  </entry>
  
  <entry>
    <title>Express ç®€å•å®ç°</title>
    <link href="https://zdddrszj.github.io/h-blog/2018/06/22/expressAchieved/"/>
    <id>https://zdddrszj.github.io/h-blog/2018/06/22/expressAchieved/</id>
    <published>2018-06-22T09:11:24.000Z</published>
    <updated>2018-10-07T00:52:49.913Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><ul><li><a href="#ä¸€-å®ç°-express-å¯åŠ¨æœåŠ¡">ä¸€ã€å®ç° express å¯åŠ¨æœåŠ¡</a></li><li><a href="#äºŒ-å®ç°-express-è·¯ç”±">äºŒã€å®ç° express è·¯ç”±</a></li><li><a href="#ä¸‰-å®ç°-express-ä¸­é—´ä»¶">ä¸‰ã€å®ç° express ä¸­é—´ä»¶</a></li></ul><!-- tocstop --><p>ä»Šå¤©æˆ‘ä»¬åˆ©ç”¨ <code>node</code> ä¸­çš„ <code>http</code> æ¨¡å—å®ç°ä¸€ä¸ª <code>express</code> æ¡†æ¶ã€‚å…³äº <code>http</code> æ¨¡å—çš„ä½¿ç”¨å¤§å®¶å¯è‡ªè¡ŒæŸ¥é˜…<a href="http://nodejs.cn/api/http.html" target="_blank" rel="noopener">ç›¸å…³æ–‡æ¡£</a>ã€‚</p><h2><span id="ä¸€-å®ç°-express-å¯åŠ¨æœåŠ¡">ä¸€ã€å®ç° express å¯åŠ¨æœåŠ¡</span></h2><p>åŸç”Ÿ <code>express</code> å¯åŠ¨æœåŠ¡<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">let</span> app = express()</span><br><span class="line"><span class="keyword">let</span> server = app.listen(<span class="number">3000</span>, <span class="string">'localhost'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`app is listening at http://<span class="subst">$&#123;server.address().address&#125;</span>:<span class="subst">$&#123;server.address().port&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><p>è‹¥å®ç°å¦‚ä¸ŠåŠŸèƒ½ï¼Œé¦–å…ˆæˆ‘ä»¬ç¡®å®šçš„æ˜¯ <code>express</code> æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ‰§è¡Œåè¿”å›ä¸€ä¸ª <code>app</code> å‡½æ•°ï¼Œä¸”æœ‰ <code>listen</code> æ–¹æ³•ï¼Œæˆ‘ä»¬ä¸å¦‚ç§°è¿™ä¸ª <code>app</code> å‡½æ•°ä¸ºç›‘å¬å‡½æ•°ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createApplication</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// appæ˜¯ä¸€ä¸ªç›‘å¬å‡½æ•°</span></span><br><span class="line">  <span class="keyword">let</span> app = <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.end(<span class="string">'hello world'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  app.listen = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> server = http.createServer(app)</span><br><span class="line">    <span class="comment">// argumentså°±æ˜¯å‚æ•°(3000, 'localhost', function () &#123;&#125;)</span></span><br><span class="line">    server.listen(...arguments)</span><br><span class="line">    <span class="keyword">return</span> server</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> app</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = createApplication</span><br></pre></td></tr></table></figure></p><h2><span id="äºŒ-å®ç°-express-è·¯ç”±">äºŒã€å®ç° express è·¯ç”±</span></h2><p>åŸç”Ÿ <code>express</code> ä½¿ç”¨è·¯ç”±<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">let</span> app = express()</span><br><span class="line">app.get(<span class="string">'/name'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.end(<span class="string">'get name'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">app.listen(<span class="number">3000</span>, <span class="string">'localhost'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'app is listening'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><p>è‹¥å®ç°å¦‚ä¸ŠåŠŸèƒ½ï¼Œæˆ‘ä»¬çš„ <code>app</code> ç›‘å¬å‡½æ•°éœ€è¦å®ç°ä¸€ä¸ª <code>get</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯ä»¥æŠŠæœ¬æ¬¡è°ƒç”¨å­˜å‚¨åœ¨ <code>app</code> çš„è·¯ç”±æ•°ç»„ä¸­ï¼Œå½“æœåŠ¡å¯åŠ¨æˆåŠŸåï¼Œç›‘å¬åˆ°åŒ¹é…çš„è·¯ç”±æ—¶å³å¯è°ƒç”¨å¯¹åº”çš„å›è°ƒã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createApplication</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// appæ˜¯ä¸€ä¸ªç›‘å¬å‡½æ•°</span></span><br><span class="line">  <span class="keyword">let</span> app = <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// å½“å‰è¯·æ±‚æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">let</span> m = req.method.toLocaleLowerCase()</span><br><span class="line">    <span class="comment">// å½“å‰è¯·æ±‚è·¯å¾„</span></span><br><span class="line">    <span class="keyword">let</span> &#123; pathname &#125; = url.parse(req.url, <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; app.routes.length; i++) &#123;</span><br><span class="line">      <span class="keyword">let</span> &#123; path, method, handler &#125; = app.routes[i]</span><br><span class="line">      <span class="comment">// å¦‚æœè¯¥è·¯ç”±é¡¹åŒ¹é…åˆ°å½“å‰è¯·æ±‚ï¼Œåˆ™æ‰§è¡Œå›è°ƒ</span></span><br><span class="line">      <span class="keyword">if</span> (path === pathname &amp;&amp; method === m) &#123;</span><br><span class="line">        handler(req, res)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å­˜å‚¨æ‰€æœ‰çš„è¯·æ±‚ï¼Œä»¥ä¾¿ç›‘å¬å‡½æ•°è°ƒç”¨</span></span><br><span class="line">  app.routes = []</span><br><span class="line">  app.get = <span class="function"><span class="keyword">function</span> (<span class="params">path, handler</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> layer = &#123;</span><br><span class="line">      path,</span><br><span class="line">      method: <span class="string">'get'</span>,</span><br><span class="line">      handler</span><br><span class="line">    &#125;</span><br><span class="line">    app.routes.push(layer)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// app.listen = function () &#123;&#125;</span></span><br><span class="line">  <span class="keyword">return</span> app</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = createApplication</span><br></pre></td></tr></table></figure></p><p>å…¶ä»– <code>RESTFUL</code> æ–¹æ³•åŒç†ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createApplication</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// appæ˜¯ä¸€ä¸ªç›‘å¬å‡½æ•°</span></span><br><span class="line">  <span class="keyword">let</span> app = <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// å½“å‰è¯·æ±‚æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">let</span> m = req.method.toLocaleLowerCase()</span><br><span class="line">    <span class="comment">// å½“å‰è¯·æ±‚è·¯å¾„</span></span><br><span class="line">    <span class="keyword">let</span> &#123; pathname &#125; = url.parse(req.url, <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; app.routes.length; i++) &#123;</span><br><span class="line">      <span class="keyword">let</span> &#123; path, method, handler &#125; = app.routes[i]</span><br><span class="line">      <span class="comment">// å¦‚æœè¯¥è·¯ç”±é¡¹åŒ¹é…åˆ°å½“å‰è¯·æ±‚ï¼Œåˆ™æ‰§è¡Œå›è°ƒ</span></span><br><span class="line">      <span class="keyword">if</span> ((path === pathname || path === <span class="string">'*'</span>) &amp;&amp; (method === m || method === <span class="string">'all'</span>)) &#123;</span><br><span class="line">        handler(req, res)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å­˜å‚¨æ‰€æœ‰çš„è¯·æ±‚ï¼Œä»¥ä¾¿ç›‘å¬å‡½æ•°è°ƒç”¨</span></span><br><span class="line">  app.routes = []</span><br><span class="line">  <span class="comment">// http.METHODS è·å–RESTFULæ‰€æœ‰æ–¹æ³•</span></span><br><span class="line">  http.METHODS.forEach(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">    method = method.toLocaleLowerCase()</span><br><span class="line">    app[method] = <span class="function"><span class="keyword">function</span> (<span class="params">path, handler</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">let</span> layer = &#123;</span><br><span class="line">        method,</span><br><span class="line">        path,</span><br><span class="line">        handler</span><br><span class="line">      &#125;</span><br><span class="line">      app.routes.push(layer)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// å¦‚æœæ²¡æœ‰åŒ¹é…æˆåŠŸï¼Œæœ€ç»ˆæ‰§è¡Œallå‡½æ•°æ‰€å­˜å‚¨çš„å›è°ƒ</span></span><br><span class="line">  app.all = <span class="function"><span class="keyword">function</span> (<span class="params">path, handler</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> layer = &#123;</span><br><span class="line">      method: <span class="string">'all'</span>, <span class="comment">// è¡¨ç¤ºå…¨éƒ¨åŒ¹é…</span></span><br><span class="line">      path,</span><br><span class="line">      handler</span><br><span class="line">    &#125;</span><br><span class="line">    app.routes.push(layer)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// app.listen = function () &#123;&#125;</span></span><br><span class="line">  <span class="keyword">return</span> app</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = createApplication</span><br></pre></td></tr></table></figure></p><h2><span id="ä¸‰-å®ç°-express-ä¸­é—´ä»¶">ä¸‰ã€å®ç° express ä¸­é—´ä»¶</span></h2><p>åŸç”Ÿ <code>express</code> ä½¿ç”¨ä¸­é—´ä»¶<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">let</span> app = express()</span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/html; charset=utf-8'</span>)</span><br><span class="line">  next()</span><br><span class="line">&#125;)</span><br><span class="line">app.use(<span class="string">'/name'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  next()</span><br><span class="line">&#125;)</span><br><span class="line">app.get(<span class="string">'/name'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.end(<span class="string">'è·å–å§“å'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">app.listen(<span class="number">3000</span>, <span class="string">'localhost'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'app is listening'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><p>ç”±æ­¤å¯è§ï¼Œ<code>use</code> æ–¹æ³•å’Œ <code>method</code> æ–¹æ³•å¤§åŒå°å¼‚ï¼Œé‡ç‚¹æ˜¯å®ç° <code>next</code> æ–¹æ³•ã€‚<br><code>next</code> å‡½æ•°çš„ä½œç”¨å³æ˜¯åœ¨è¯·æ±‚åˆ°è¾¾å‰æ›´æ”¹ä¸€äº›ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œæ¯”å¦‚ä¿®æ”¹è¿”å›å­—ç¬¦é›†ç¼–ç ç­‰ï¼Œä¸”æŒ‰é¡ºåºæ‰§è¡Œï¼Œå›ºå¯ç”¨è¿­ä»£çš„æ–¹å¼å®ç°ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">let</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createApplication</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// appæ˜¯ä¸€ä¸ªç›‘å¬å‡½æ•°</span></span><br><span class="line">  <span class="keyword">let</span> app = <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// å½“å‰è¯·æ±‚æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">let</span> m = req.method.toLocaleLowerCase()</span><br><span class="line">    <span class="comment">// å½“å‰è¯·æ±‚è·¯å¾„</span></span><br><span class="line">    <span class="keyword">let</span> &#123; pathname &#125; = url.parse(req.url, <span class="literal">true</span>)</span><br><span class="line">    <span class="comment">// è¿­ä»£æ¬¡æ•°ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">    <span class="comment">// ç”¨nextä»£æ›¿forå¾ªç¯</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">next</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// å¦‚æœå…¨éƒ¨è·¯ç”±æ•°ç»„éƒ½ä¸æ»¡è¶³ï¼Œåˆ™è¿”å›æ‰¾ä¸åˆ°</span></span><br><span class="line">      <span class="keyword">if</span> (index === app.routes.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.end(<span class="string">`can not <span class="subst">$&#123;m&#125;</span> <span class="subst">$&#123;pathname&#125;</span>`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å¤„ç†ä¸­é—´ä»¶</span></span><br><span class="line">      <span class="keyword">let</span> &#123; method, path, handler &#125; = app.routes[index++]</span><br><span class="line">      <span class="keyword">if</span> (method === <span class="string">'middle'</span>) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœè¯¥ä¸­é—´ä»¶pathæ˜¯/ï¼ŒåŒ¹é…å…¨éƒ¨è¯·æ±‚ï¼Œæ‰§è¡Œå›è°ƒï¼›å¦‚æœç›¸ç­‰ï¼Œæ‰§è¡Œå›è°ƒï¼›å¦‚æœè¯¥ä¸­é—´ä»¶pathè¢«åŒ…å«åœ¨å½“å‰è¯·æ±‚urlä¸­ï¼Œä¹Ÿæ‰§è¡Œå›è°ƒ</span></span><br><span class="line">        <span class="keyword">if</span> (path === <span class="string">'/'</span> || path === pathname || pathname.startsWith(path + <span class="string">'/'</span>)) &#123;</span><br><span class="line">          handler(req, res, next)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          next()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((path === pathname || path === <span class="string">'*'</span>) &amp;&amp; (method === m || method === <span class="string">'all'</span>)) &#123;</span><br><span class="line">          handler(req, res, next)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          next()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç›´æ¥è°ƒç”¨nextå‡½æ•°ï¼Œæ ¹æ®è·¯å¾„åŒ¹é…æŸ¥æ‰¾å¯¹åº”å›è°ƒå¹¶æ‰§è¡Œ</span></span><br><span class="line">    next()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// app.routes = []</span></span><br><span class="line">  <span class="comment">// http.METHODS.forEach(() =&gt; &#123;&#125;</span></span><br><span class="line">  <span class="comment">// app.all = function (path, handler) &#123;&#125;</span></span><br><span class="line">  <span class="comment">// ä¸­é—´ä»¶ï¼šå‚æ•°å¯ä»¥ä¼ pathï¼Œä¹Ÿå¯ä»¥ä¸ä¼ ï¼Œé»˜è®¤'/'</span></span><br><span class="line">  app.use = <span class="function"><span class="keyword">function</span> (<span class="params">path, handler</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> handler !== <span class="string">'function'</span>) &#123;</span><br><span class="line">      handler = path</span><br><span class="line">      path = <span class="string">'/'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> layer = &#123;</span><br><span class="line">      method: <span class="string">'middle'</span>,</span><br><span class="line">      path,</span><br><span class="line">      handler</span><br><span class="line">    &#125;</span><br><span class="line">    app.routes.push(layer)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// app.listen = function () &#123;&#125;</span></span><br><span class="line">  <span class="keyword">return</span> app</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = createApplication</span><br></pre></td></tr></table></figure></p><p>æ­¤æ—¶ï¼Œ<code>express</code> çš„ä¸»è¦åŠŸèƒ½å·²ç»å®ç°ï¼Œä¸‹é¢æ¥çœ‹ä¸‹å¦‚æœæ‰§è¡Œé”™è¯¯é€šè¿‡ <code>next</code> å‡½æ•°å‚æ•°è¿›è¡Œè¿”å›çš„æƒ…å†µã€‚<br>å¦‚æœ <code>next</code> å‡½æ•°æœ‰å‚æ•°ï¼Œä¼šè·³è¿‡æ¥ä¸‹æ¥çš„æ‰€æœ‰ä¸­é—´ä»¶å’Œè·¯ç”±ï¼Œç›´æ¥è¿”å›é”™è¯¯å‚æ•°æ¶ˆæ¯ï¼Œæ‰€ä»¥åœ¨å¤„ç†ä¸­é—´ä»¶ä¹‹å‰è¦å…ˆåˆ¤æ–­é”™è¯¯æƒ…å†µï¼Œå¹¶ä¸”å°†é”™è¯¯ç»§ç»­å‘ä¸‹ä¼ é€’ï¼Œåªæœ‰åŒ¹é…åˆ°æœ‰å››ä¸ªå‚æ•°çš„å›è°ƒæ—¶æ‰æ‰§è¡Œã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createApplication</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// appæ˜¯ä¸€ä¸ªç›‘å¬å‡½æ•°</span></span><br><span class="line">  <span class="keyword">let</span> app = <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// æ­¤å¤„çœç•¥...</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">next</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// æ­¤å¤„çœç•¥...</span></span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        res.end(err)</span><br><span class="line">        <span class="keyword">if</span> (handler.length === <span class="number">4</span>) &#123;</span><br><span class="line">          handler(err, req, res, next)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          next(err)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¤„ç†ä¸­é—´ä»¶ï¼Œæ­¤å¤„çœç•¥...</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    next()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// app.routes = []</span></span><br><span class="line">  <span class="comment">// http.METHODS.forEach(() =&gt; &#123;&#125;</span></span><br><span class="line">  <span class="comment">// app.all = function (path, handler) &#123;&#125;</span></span><br><span class="line">  <span class="comment">// app.use = function (path, handler) &#123;&#125;</span></span><br><span class="line">  <span class="comment">// app.listen = function () &#123;&#125;</span></span><br><span class="line">  <span class="keyword">return</span> app</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = createApplication</span><br></pre></td></tr></table></figure></p><p><a href="https://github.com/zdddrszj/code/blob/master/express/index.js" target="_blank" rel="noopener">æºç </a></p><p>å¥½äº†ï¼Œåˆ°è¿™é‡Œå…¨éƒ¨ä»£ç å·²ç»ç»™å‡ºï¼Œå°±åˆ°æ­¤ä¸ºæ­¢å§~ ğŸ˜‹ğŸ˜‹ğŸ˜‹</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#ä¸€-å®ç°-express-å¯åŠ¨æœåŠ¡&quot;&gt;ä¸€ã€å®ç° express å¯åŠ¨æœåŠ¡&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#äºŒ-å®ç°-express-è·¯ç”±&quot;&gt;äºŒã€å®ç° express è·¯ç”±&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://zdddrszj.github.io/h-blog/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="express" scheme="https://zdddrszj.github.io/h-blog/tags/express/"/>
    
  </entry>
  
  <entry>
    <title>Babel ä¸€ä¸‹ ES6 ä¸­çš„ç±»åŠç»§æ‰¿</title>
    <link href="https://zdddrszj.github.io/h-blog/2018/06/19/classAndInherits/"/>
    <id>https://zdddrszj.github.io/h-blog/2018/06/19/classAndInherits/</id>
    <published>2018-06-19T05:41:16.000Z</published>
    <updated>2018-10-07T00:52:49.912Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><ul><li><a href="#ä¸€-ç”¨es5å®ç°ç»§æ‰¿">ä¸€ã€ç”¨ES5å®ç°ç»§æ‰¿</a><ul><li><a href="#1-åˆ›å»ºçˆ¶ç±»">1ã€åˆ›å»ºçˆ¶ç±»</a></li><li><a href="#2-åˆ›å»ºå­ç±»å¹¶ç»§æ‰¿">2ã€åˆ›å»ºå­ç±»å¹¶ç»§æ‰¿</a></li></ul></li><li><a href="#äºŒ-ç”¨es6å®ç°ç»§æ‰¿">äºŒã€ç”¨es6å®ç°ç»§æ‰¿</a></li><li><a href="#ä¸‰-æ‰‹åŠ¨å®ç°es6ä¸­ç±»åŠç»§æ‰¿">ä¸‰ã€æ‰‹åŠ¨å®ç°ES6ä¸­ç±»åŠç»§æ‰¿</a><ul><li><a href="#1-å®ç°çˆ¶ç±»">1ã€å®ç°çˆ¶ç±»</a></li><li><a href="#2-å®ç°å­ç±»åŠç»§æ‰¿">2ã€å®ç°å­ç±»åŠç»§æ‰¿</a></li></ul></li></ul><!-- tocstop --><h2><span id="ä¸€-ç”¨es5å®ç°ç»§æ‰¿">ä¸€ã€ç”¨ES5å®ç°ç»§æ‰¿</span></h2><h3><span id="1-åˆ›å»ºçˆ¶ç±»">1ã€åˆ›å»ºçˆ¶ç±»</span></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Father</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ç§æœ‰å±æ€§</span></span><br><span class="line">  <span class="keyword">this</span>.name = <span class="string">'father'</span></span><br><span class="line">  <span class="comment">// ç§æœ‰æ–¹æ³•</span></span><br><span class="line">  <span class="keyword">this</span>.eat = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'eat'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å…¬æœ‰æ–¹æ³•</span></span><br><span class="line">Father.prototype.sleep = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'sleep'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Father() <span class="comment">// æ­¤æ—¶æ§åˆ¶å°è¾“å‡ºæŒ‚è½½åœ¨windowå¯¹è±¡ä¸Šçš„æ–¹æ³•ï¼Œå¯çŸ¥æ²¡æœ‰åˆ›å»ºå®ä¾‹æ—¶thisæŒ‡å‘window</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> father = <span class="keyword">new</span> Father()</span><br><span class="line">father.eat() <span class="comment">// eat</span></span><br><span class="line">father.sleep() <span class="comment">// sleep</span></span><br><span class="line"><span class="built_in">console</span>.log(father) <span class="comment">// Father &#123; name: 'father', eat: [Function] &#125;</span></span><br></pre></td></tr></table></figure><h3><span id="2-åˆ›å»ºå­ç±»å¹¶ç»§æ‰¿">2ã€åˆ›å»ºå­ç±»å¹¶ç»§æ‰¿</span></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Child</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ç»§æ‰¿çˆ¶ç±»çš„ç§æœ‰å±æ€§å’Œæ–¹æ³•</span></span><br><span class="line">  Father.call(<span class="keyword">this</span>)</span><br><span class="line">  <span class="comment">// è‡ªå·±çš„ç§æœ‰å±æ€§</span></span><br><span class="line">  <span class="keyword">this</span>.name = <span class="string">'child'</span></span><br><span class="line">  <span class="comment">// è‡ªå·±çš„ç§æœ‰æ–¹æ³•</span></span><br><span class="line">  <span class="keyword">this</span>.smoke = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'smoke'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç»§æ‰¿çˆ¶ç±»çš„å…¬å…±æ–¹æ³•ï¼šå°†Childçš„prototypeæŒ‡å‘Fatherçš„prototypeï¼ŒåŒæ—¶ä¿®æ”¹Child.prototype.constructorä¸ºChildæœ¬èº«</span></span><br><span class="line">Child.prototype = <span class="built_in">Object</span>.create(Father.prototype, &#123; <span class="attr">constructor</span>: &#123; </span><br><span class="line">  value: Child,</span><br><span class="line">  enumerable: <span class="literal">false</span>,</span><br><span class="line">  writable: <span class="literal">true</span>,</span><br><span class="line">  configurable: <span class="literal">true</span></span><br><span class="line">&#125;&#125;)</span><br><span class="line"><span class="comment">// ä¿®æ”¹åŸå‹é“¾ï¼šå°†Childçš„åŸå‹é“¾æŒ‡å‘æ‰€ä»å±çš„åŸå‹ä¸Šï¼Œå³Child.__proto__ = Fatherï¼Œæˆ–è€…</span></span><br><span class="line"><span class="built_in">Object</span>.setPrototypeOf(Child, Father)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> child = <span class="keyword">new</span> Child()</span><br><span class="line">child.eat() <span class="comment">// eat</span></span><br><span class="line">child.sleep() <span class="comment">// sleep</span></span><br><span class="line">child.smoke() <span class="comment">// smoke</span></span><br><span class="line"><span class="built_in">console</span>.log(Child.__proto__.prototype === Father.prototype) <span class="comment">// true</span></span><br></pre></td></tr></table></figure><h2><span id="äºŒ-ç”¨es6å®ç°ç»§æ‰¿">äºŒã€ç”¨es6å®ç°ç»§æ‰¿</span></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Father</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> () &#123;</span><br><span class="line">    <span class="comment">// ç§æœ‰å±æ€§</span></span><br><span class="line">    <span class="keyword">this</span>.name = <span class="string">'father'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å…¬æœ‰æ–¹æ³•</span></span><br><span class="line">  eat () &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'eat'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// é™æ€æ–¹æ³•ï¼Œå¯ç›´æ¥è®¿é—®çš„ç§æœ‰æ–¹æ³•</span></span><br><span class="line">  <span class="keyword">static</span> sleep () &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'sleep'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span> <span class="keyword">extends</span> <span class="title">Father</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">super</span>()</span><br><span class="line">    <span class="comment">// ç§æœ‰å±æ€§</span></span><br><span class="line">    <span class="keyword">this</span>.name = <span class="string">'child'</span></span><br><span class="line">    <span class="keyword">this</span>.age = <span class="number">12</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å…¬æœ‰æ–¹æ³•</span></span><br><span class="line">  smoke () &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'smoke'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> child = <span class="keyword">new</span> Child()</span><br><span class="line">child.eat() <span class="comment">// eat</span></span><br><span class="line">Child.sleep() <span class="comment">// sleep</span></span><br><span class="line">child.smoke() <span class="comment">// smoke</span></span><br></pre></td></tr></table></figure><h2><span id="ä¸‰-æ‰‹åŠ¨å®ç°es6ä¸­ç±»åŠç»§æ‰¿">ä¸‰ã€æ‰‹åŠ¨å®ç°ES6ä¸­ç±»åŠç»§æ‰¿</span></h2><h3><span id="1-å®ç°çˆ¶ç±»">1ã€å®ç°çˆ¶ç±»</span></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å› ä¸ºç±»å®ä¾‹éœ€è¦newåˆ›å»ºï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªç±»è°ƒç”¨æ£€æŸ¥å‡½æ•°ï¼Œå³_classCallCheckå‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_classCallCheck</span> (<span class="params">instance, Constructor</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!instance <span class="keyword">instanceof</span> <span class="keyword">constructor</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'cannot call a class as a function'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç±»åˆ›å»ºå‡½æ•°ï¼š Constructoræ˜¯åŸå‹ protoPropsæ˜¯å…¬æœ‰æ–¹æ³• staticPropsæ˜¯é™æ€æ–¹æ³•ï¼Œä¹Ÿæ˜¯ç§æœ‰æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_createClass</span>(<span class="params">Constructor, protoProps, staticProps</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">defineProperties</span>(<span class="params">target, props</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; props.length; i++) &#123;</span><br><span class="line">      <span class="built_in">Object</span>.defineProperty(target, props[i].key, &#123;</span><br><span class="line">        value: props[i].value,</span><br><span class="line">        enumerable: <span class="literal">true</span>,</span><br><span class="line">        writable: <span class="literal">true</span>,</span><br><span class="line">        configurable: <span class="literal">true</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ·»åŠ å…¬æœ‰æ–¹æ³•</span></span><br><span class="line">  <span class="keyword">if</span> (protoProps) &#123;</span><br><span class="line">    defineProperties(Constructor.prototype, protoProps)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ·»åŠ é™æ€æ–¹æ³•ï¼Œä¹Ÿæ˜¯ç§æœ‰æ–¹æ³•</span></span><br><span class="line">  <span class="keyword">if</span> (staticProps) &#123;</span><br><span class="line">    defineProperties(Constructor, staticProps)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Constructor</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> Father = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Father</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ç±»è°ƒç”¨æ£€æŸ¥</span></span><br><span class="line">    _classCallCheck(<span class="keyword">this</span>, Father)</span><br><span class="line">    <span class="comment">// ç§æœ‰å±æ€§</span></span><br><span class="line">    <span class="keyword">this</span>.name = <span class="string">'father'</span></span><br><span class="line">    <span class="comment">// return &#123;</span></span><br><span class="line">    <span class="comment">//   hobby: 'basketball'</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ä¸‹é¢æ˜¯å®ç°ç±»ï¼Œå³æŠŠå…¬æœ‰æ–¹æ³•ç»‘å®šåˆ°Fatherçš„prototypeä¸Šï¼Œé™æ€æ–¹æ³•ç›´æ¥æ”¾åˆ°Fatherä¸Š</span></span><br><span class="line">  _createClass(Father,[</span><br><span class="line">    &#123;</span><br><span class="line">      key: <span class="string">'eat'</span>,</span><br><span class="line">      value: <span class="function"><span class="keyword">function</span> <span class="title">eat</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'eat'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  [</span><br><span class="line">    &#123;</span><br><span class="line">      key: <span class="string">'sleep'</span>,</span><br><span class="line">      value: <span class="function"><span class="keyword">function</span> <span class="title">sleep</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'sleep'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ])</span><br><span class="line">  <span class="keyword">return</span> Father</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure><h3><span id="2-å®ç°å­ç±»åŠç»§æ‰¿">2ã€å®ç°å­ç±»åŠç»§æ‰¿</span></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‡½æ•°ä½œç”¨ï¼šç»§æ‰¿çˆ¶ç±»çš„å…¬å…±æ–¹æ³•å’Œä¿®æ”¹åŸå‹é“¾</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_inherits</span>(<span class="params">subClass, superClass</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> superClass !== <span class="string">'function'</span> &amp;&amp; superClass !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'super expression must either be null or a function,not'</span> + <span class="keyword">typeof</span> superClass)</span><br><span class="line">  &#125;</span><br><span class="line">  subClass.prototype = <span class="built_in">Object</span>.create(superClass &amp;&amp; superClass.prototype, &#123;</span><br><span class="line">    <span class="keyword">constructor</span>: &#123;</span><br><span class="line">      value: subClass,</span><br><span class="line">      enumerable: <span class="literal">false</span>,</span><br><span class="line">      writable: <span class="literal">true</span>,</span><br><span class="line">      configurable: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">if</span> (subClass) &#123;</span><br><span class="line">    <span class="built_in">Object</span>.setPrototypeOf ? <span class="built_in">Object</span>.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> Child = <span class="function"><span class="keyword">function</span> (<span class="params">Father</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ç»§æ‰¿çˆ¶ç±»çš„å…¬æœ‰æ–¹æ³•ï¼šå°†Childçš„prototypeæŒ‡å‘Fatherçš„prototypeï¼ŒåŒæ—¶ä¿®æ”¹Child.prototype.constructorä¸ºChildæœ¬èº«</span></span><br><span class="line">  <span class="comment">// ä¿®æ”¹åŸå‹é“¾ï¼šå°†Childçš„åŸå‹é“¾æŒ‡å‘æ‰€ä»å±çš„åŸå‹ä¸Šï¼Œå³Child.__proto__ = Father</span></span><br><span class="line">  _inherits(Child, Father)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Child</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ç±»è°ƒç”¨æ£€æŸ¥</span></span><br><span class="line">    _classCallCheck(<span class="keyword">this</span>, Child)</span><br><span class="line">    <span class="comment">// ç»§æ‰¿ç§æœ‰å±æ€§</span></span><br><span class="line">    <span class="keyword">let</span> obj = Father.call(<span class="keyword">this</span>)</span><br><span class="line">    <span class="comment">// è¿™é‡Œæ˜¯å› ä¸ºçˆ¶ç±»å‡½æ•°å¯ä»¥è¿”å›ä¸€ä¸ªæ–°å¯¹è±¡ï¼ˆè§çˆ¶ç±»æ³¨é‡Šï¼‰</span></span><br><span class="line">    <span class="keyword">let</span> that = <span class="keyword">this</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> obj === <span class="string">'object'</span>) &#123;</span><br><span class="line">      that = obj</span><br><span class="line">    &#125;</span><br><span class="line">    that.name = <span class="string">'Child'</span></span><br><span class="line">    that.age = <span class="number">12</span></span><br><span class="line">    <span class="keyword">return</span> that</span><br><span class="line">  &#125;</span><br><span class="line">  _createClass(Child, [&#123;</span><br><span class="line">    key: <span class="string">'smoking'</span>,</span><br><span class="line">    value: <span class="function"><span class="keyword">function</span> <span class="title">smoking</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'smoking'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;])</span><br><span class="line">  <span class="keyword">return</span> Child</span><br><span class="line">&#125;(Father)</span><br></pre></td></tr></table></figure><p>å¥½äº†ï¼Œåˆ°è¿™é‡Œä»‹ç»å®Œæ¯•~ ğŸ˜‹ğŸ˜‹ğŸ˜‹</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#ä¸€-ç”¨es5å®ç°ç»§æ‰¿&quot;&gt;ä¸€ã€ç”¨ES5å®ç°ç»§æ‰¿&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-åˆ›å»ºçˆ¶ç±»&quot;&gt;1ã€åˆ›å»ºçˆ¶ç±»&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-åˆ›å»ºå­ç±»å¹¶ç»§æ‰¿&quot;&gt;2ã€åˆ›å»ºå­ç±»å¹¶ç»§æ‰¿&lt;/a&gt;&lt;
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://zdddrszj.github.io/h-blog/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="es6" scheme="https://zdddrszj.github.io/h-blog/tags/es6/"/>
    
      <category term="class" scheme="https://zdddrszj.github.io/h-blog/tags/class/"/>
    
  </entry>
  
  <entry>
    <title>3D æ—¶é’Ÿ</title>
    <link href="https://zdddrszj.github.io/h-blog/2018/01/08/3DClock/"/>
    <id>https://zdddrszj.github.io/h-blog/2018/01/08/3DClock/</id>
    <published>2018-01-08T08:39:05.000Z</published>
    <updated>2018-10-07T00:52:49.912Z</updated>
    
    <content type="html"><![CDATA[<p>ä»Šå¤©æˆ‘ä»¬åˆ©ç”¨ <code>canvas</code> å’Œ <code>threejs</code> åŸºç¡€çŸ¥è¯†æ¥åšä¸€ä¸ªå¯ä»¥æ—‹è½¬çš„ 3D æ—¶é’ŸåŠ¨æ•ˆã€‚æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="http://zdddrszj.github.io/h5case/3DClock/3DClock.gif" alt="3DClock"></p><blockquote><p><code>threejs</code> åŸºç¡€æ¦‚å¿µå¤§å®¶éœ€è¦æå‰äº†è§£ä¸€ä¸‹ã€‚</p></blockquote><h3><span id="ä¸€-åˆ¶ä½œæ—¶é’Ÿ">ä¸€ã€åˆ¶ä½œæ—¶é’Ÿ</span></h3><h4><span id="1-åŸºç¡€å˜é‡å®šä¹‰">1ã€åŸºç¡€å˜é‡å®šä¹‰</span></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> requestAnimationFrame = requestAnimationFrame || webkitRequestAnimationFrame || oRequestAnimationFrame || msRequestAnimationFrame</span><br><span class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.createElement(<span class="string">'canvas'</span>),</span><br><span class="line">    ctx = canvas.getContext(<span class="string">'2d'</span>)</span><br><span class="line">    canvas.setAttribute(<span class="string">'width'</span>, <span class="number">400</span>)</span><br><span class="line">    canvas.setAttribute(<span class="string">'height'</span>, <span class="number">400</span>)</span><br><span class="line"><span class="comment">// åˆ»ç”»æ—¶é’Ÿ</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clock</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    ctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, <span class="number">400</span>, <span class="number">400</span>)</span><br><span class="line">    <span class="keyword">let</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>(),</span><br><span class="line">        hours = date.getHours(),</span><br><span class="line">        minutes = date.getMinutes(),</span><br><span class="line">        seconds = date.getSeconds()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çœç•¥ ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¾ªç¯è°ƒç”¨</span></span><br><span class="line">    requestAnimationFrame(clock)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="2-ç”»æ—¶é’Ÿè¾¹æ¡†">2ã€ç”»æ—¶é’Ÿè¾¹æ¡†</span></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰ä¸€ä¸ªä»ä¸Šåˆ°ä¸‹çš„æ¼‚äº®é¢œè‰²æ¸å˜</span></span><br><span class="line"><span class="keyword">let</span> gradient = ctx.createLinearGradient(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">400</span>)</span><br><span class="line">gradient.addColorStop(<span class="number">0</span>, <span class="string">'#48d5ae'</span>)</span><br><span class="line">gradient.addColorStop(<span class="number">1</span>, <span class="string">'#249ec2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”»æ—¶é’Ÿè¾¹æ¡†</span></span><br><span class="line">ctx.beginPath()</span><br><span class="line">ctx.lineWidth = <span class="number">10</span></span><br><span class="line">ctx.strokeStyle = gradient</span><br><span class="line">ctx.arc(<span class="number">200</span>, <span class="number">200</span>, <span class="number">195</span>, <span class="number">0</span>, <span class="number">2</span> * <span class="built_in">Math</span>.PI)</span><br><span class="line">ctx.stroke()</span><br><span class="line">ctx.closePath()</span><br></pre></td></tr></table></figure><h4><span id="3-ç”»åˆ†é’ˆåˆ»åº¦">3ã€ç”»åˆ†é’ˆåˆ»åº¦</span></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ctx.beginPath()</span><br><span class="line">ctx.lineWidth = <span class="number">5</span></span><br><span class="line">ctx.strokeStyle = <span class="string">'#9c9ba0'</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">60</span>; i++) &#123;</span><br><span class="line">    <span class="comment">// ä¿å­˜ç”»å¸ƒå½“å‰çŠ¶æ€ï¼Œå¯¹ç”»å¸ƒè¿›è¡Œå˜æ¢æ—¶éœ€è¦save restoreï¼Œå¦åˆ™å½±å“åé¢ç”»å¸ƒä¸Šçš„å…ƒç´ </span></span><br><span class="line">    ctx.save()</span><br><span class="line">    <span class="comment">// ç§»åŠ¨ç”»å¸ƒï¼Œå°†åæ ‡åŸç‚¹æ”¾åœ¨æ—¶é’Ÿä¸­å¿ƒç‚¹</span></span><br><span class="line">    ctx.translate(<span class="number">200</span>, <span class="number">200</span>)</span><br><span class="line">    <span class="comment">// æ—‹è½¬ç”»å¸ƒï¼Œæ¯æ¬¡æ—‹è½¬6åº¦ï¼Œ60æ¬¡æ—‹è½¬ä¸€å‘¨</span></span><br><span class="line">    ctx.rotate(i * <span class="number">6</span> * <span class="built_in">Math</span>.PI / <span class="number">180</span>)</span><br><span class="line">    <span class="comment">// 12ç‚¹æ–¹å‘</span></span><br><span class="line">    ctx.moveTo(<span class="number">0</span>, <span class="number">-180</span>)</span><br><span class="line">    ctx.lineTo(<span class="number">0</span>, <span class="number">-190</span>)</span><br><span class="line">    <span class="comment">// æ¢å¤ç”»å¸ƒä¹‹å‰çš„çŠ¶æ€</span></span><br><span class="line">    ctx.restore()</span><br><span class="line">&#125;</span><br><span class="line">ctx.stroke()</span><br><span class="line">ctx.closePath()</span><br></pre></td></tr></table></figure><h4><span id="4-ç”»æ—¶é’ˆåˆ»åº¦">4ã€ç”»æ—¶é’ˆåˆ»åº¦</span></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ctx.beginPath()</span><br><span class="line">ctx.lineWidth = <span class="number">8</span></span><br><span class="line">ctx.strokeStyle = <span class="string">'#535257'</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">12</span>; i++) &#123;</span><br><span class="line">    <span class="comment">// ä¿å­˜ç”»å¸ƒå½“å‰çŠ¶æ€ï¼Œå¯¹ç”»å¸ƒè¿›è¡Œå˜æ¢æ—¶éœ€è¦save restoreï¼Œå¦åˆ™å½±å“åé¢ç”»å¸ƒä¸Šçš„å…ƒç´ </span></span><br><span class="line">    ctx.save()</span><br><span class="line">    <span class="comment">// ç§»åŠ¨ç”»å¸ƒï¼Œå°†åæ ‡åŸç‚¹æ”¾åœ¨æ—¶é’Ÿä¸­å¿ƒç‚¹</span></span><br><span class="line">    ctx.translate(<span class="number">200</span>, <span class="number">200</span>)</span><br><span class="line">    <span class="comment">// æ—‹è½¬ç”»å¸ƒï¼Œæ¯æ¬¡æ—‹è½¬30åº¦ï¼Œ12æ¬¡æ—‹è½¬ä¸€å‘¨</span></span><br><span class="line">    ctx.rotate(i * <span class="number">30</span> * <span class="built_in">Math</span>.PI / <span class="number">180</span>)</span><br><span class="line">    <span class="comment">// 12ç‚¹æ–¹å‘</span></span><br><span class="line">    ctx.moveTo(<span class="number">0</span>, <span class="number">-170</span>)</span><br><span class="line">    ctx.lineTo(<span class="number">0</span>, <span class="number">-190</span>)</span><br><span class="line">    <span class="comment">// æ¢å¤ç”»å¸ƒä¹‹å‰çš„çŠ¶æ€</span></span><br><span class="line">    ctx.restore()</span><br><span class="line">&#125;</span><br><span class="line">ctx.stroke()</span><br><span class="line">ctx.closePath()</span><br></pre></td></tr></table></figure><h4><span id="5-ç”»æ—¶é—´ç‚¹">5ã€ç”»æ—¶é—´ç‚¹</span></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ctx.beginPath()</span><br><span class="line">ctx.save()</span><br><span class="line">ctx.translate(<span class="number">200</span>, <span class="number">200</span>)</span><br><span class="line">ctx.font = <span class="string">'26px Arial'</span></span><br><span class="line">ctx.textAlign = <span class="string">'center'</span></span><br><span class="line">ctx.textBaseline = <span class="string">'middle'</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> n = <span class="number">0</span>; n &lt; <span class="number">12</span>; n++) &#123;</span><br><span class="line">    <span class="comment">// n * (Math.PI * 2) / 12 ä»£è¡¨3ç‚¹</span></span><br><span class="line">    <span class="keyword">var</span> theta = (n - <span class="number">2</span>) * (<span class="built_in">Math</span>.PI * <span class="number">2</span>) / <span class="number">12</span>;</span><br><span class="line">    <span class="keyword">var</span> x = <span class="number">150</span> * <span class="built_in">Math</span>.cos(theta);</span><br><span class="line">    <span class="keyword">var</span> y = <span class="number">150</span> * <span class="built_in">Math</span>.sin(theta);</span><br><span class="line">    ctx.fillText(n + <span class="number">1</span>, x, y);</span><br><span class="line">&#125;</span><br><span class="line">ctx.restore()</span><br><span class="line">ctx.closePath()</span><br></pre></td></tr></table></figure><h4><span id="6-ç”»æ—¶é’ˆ">6ã€ç”»æ—¶é’ˆ</span></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ctx.beginPath()</span><br><span class="line">ctx.save()</span><br><span class="line">ctx.lineWidth = <span class="number">7</span></span><br><span class="line">ctx.strokeStyle = <span class="string">'#38383b'</span></span><br><span class="line">ctx.translate(<span class="number">200</span>, <span class="number">200</span>)</span><br><span class="line"><span class="comment">// æ¯å°æ—¶30åº¦</span></span><br><span class="line">ctx.rotate(hours % <span class="number">12</span> * <span class="number">30</span> * <span class="built_in">Math</span>.PI / <span class="number">180</span>)</span><br><span class="line">ctx.moveTo(<span class="number">0</span>, <span class="number">20</span>)</span><br><span class="line"><span class="comment">// 12ç‚¹æ–¹å‘</span></span><br><span class="line">ctx.lineTo(<span class="number">0</span>, <span class="number">-80</span>)</span><br><span class="line">ctx.stroke()</span><br><span class="line">ctx.restore()</span><br><span class="line">ctx.closePath()</span><br></pre></td></tr></table></figure><h4><span id="7-ç”»åˆ†é’ˆ">7ã€ç”»åˆ†é’ˆ</span></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ctx.beginPath()</span><br><span class="line">ctx.save()</span><br><span class="line">ctx.lineWidth = <span class="number">5</span></span><br><span class="line">ctx.translate(<span class="number">200</span>, <span class="number">200</span>)</span><br><span class="line"><span class="comment">// æ¯åˆ†é’Ÿ6åº¦</span></span><br><span class="line">ctx.rotate(minutes * <span class="number">6</span> * <span class="built_in">Math</span>.PI / <span class="number">180</span>)</span><br><span class="line">ctx.moveTo(<span class="number">0</span>, <span class="number">20</span>)</span><br><span class="line"><span class="comment">// 12ç‚¹æ–¹å‘</span></span><br><span class="line">ctx.lineTo(<span class="number">0</span>, <span class="number">-110</span>)</span><br><span class="line">ctx.stroke()</span><br><span class="line">ctx.restore()</span><br><span class="line">ctx.closePath()</span><br></pre></td></tr></table></figure><h4><span id="8-ç”»ç§’é’ˆ">8ã€ç”»ç§’é’ˆ</span></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ctx.beginPath()</span><br><span class="line">ctx.save()</span><br><span class="line">ctx.lineWidth = <span class="number">3</span></span><br><span class="line">ctx.strokeStyle = <span class="string">'#FD3351'</span></span><br><span class="line">ctx.translate(<span class="number">200</span>, <span class="number">200</span>)</span><br><span class="line"><span class="comment">// æ¯ç§’é’Ÿ6åº¦</span></span><br><span class="line">ctx.rotate(seconds * <span class="number">6</span> * <span class="built_in">Math</span>.PI / <span class="number">180</span>)</span><br><span class="line">ctx.moveTo(<span class="number">0</span>, <span class="number">20</span>)</span><br><span class="line"><span class="comment">// 12ç‚¹æ–¹å‘</span></span><br><span class="line">ctx.lineTo(<span class="number">0</span>, <span class="number">-130</span>)</span><br><span class="line">ctx.stroke()</span><br><span class="line">ctx.restore()</span><br><span class="line">ctx.closePath()</span><br></pre></td></tr></table></figure><h4><span id="9-ç”»æ—¶é’Ÿåœ†å¿ƒ">9ã€ç”»æ—¶é’Ÿåœ†å¿ƒ</span></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ctx.beginPath()</span><br><span class="line">ctx.fillStyle = <span class="string">'#edb052'</span></span><br><span class="line">ctx.arc(<span class="number">200</span>, <span class="number">200</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">2</span> * <span class="built_in">Math</span>.PI)</span><br><span class="line">ctx.fill()</span><br><span class="line">ctx.closePath()</span><br><span class="line">ctx.beginPath()</span><br><span class="line">ctx.fillStyle = <span class="string">'#ff364e'</span></span><br><span class="line">ctx.arc(<span class="number">200</span>, <span class="number">200</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">2</span> * <span class="built_in">Math</span>.PI)</span><br><span class="line">ctx.fill()</span><br><span class="line">ctx.closePath()</span><br></pre></td></tr></table></figure><p><g-emoji alias="innocent" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f607.png" ios-version="6.0">ğŸ˜‡</g-emoji> åˆ°æ­¤æ—¶é’Ÿåˆ»ç”»å®Œæ¯•ã€‚</p><h3><span id="äºŒ-æ·»åŠ åŠ¨ç”»">äºŒã€æ·»åŠ åŠ¨ç”»</span></h3><p>è¿™é‡Œéœ€è¦å¤§å®¶æå‰æŸ¥é˜…èµ„æ–™äº†è§£ <code>æ¸²æŸ“å™¨</code> <code>åœºæ™¯</code> <code>ç›¸æœº</code> <code>æ¨¡å‹</code> <code>å‡ ä½•ä½“</code> <code>ææ–™</code> <code>çº¹ç†</code> å‡ ä¸ªåè¯çš„æ¦‚å¿µã€‚</p><blockquote><p>é™„ä¸Šæˆ‘ç®€å•é„™é™‹çš„ç†è§£ï¼šæ¸²æŸ“å™¨å¯ä»¥å°†åœºæ™¯æ¸²æŸ“å‡ºæ¥ã€‚åœºæ™¯ç”±æ¨¡å‹æ„å»ºã€‚ç›¸æœºæœ‰é€è§†ç›¸æœºå’Œæ­£äº¤ç›¸æœºä¹‹åˆ†ï¼Œåœ¨ä¸åŒè§’åº¦ä¸åŒç›¸æœºçš„ç…§å°„ä¸‹åœºæ™¯ä¼šå±•ç¤ºå‡ºä¸åŒçš„æ•ˆæœã€‚æ¨¡å‹ç”±å‡ ä½•ä½“ç»„æˆã€‚å‡ ä½•ä½“ç”±ææ–™å¡«å……ã€‚ææ–™ç”±çº¹ç†ä¿®é¥°ï¼Œçº¹ç†å¯ä»¥æ˜¯å›¾ç‰‡ï¼Œä¹Ÿå¯ä»¥æ˜¯ç”»å¸ƒã€‚</p></blockquote><p>js ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰å˜é‡ï¼šæ¸²æŸ“å™¨ åœºæ™¯ ç›¸æœº æ¨¡å‹ å‡ ä½•ä½“ ææ–™ çº¹ç†</span></span><br><span class="line"><span class="keyword">var</span> renderer, scene, camera,  mesh, geometry, material, texture</span><br><span class="line"><span class="comment">// é¡µé¢å…¥å£å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">start</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// å®šä¹‰æ—¶é’Ÿ</span></span><br><span class="line">    clock()</span><br><span class="line">    <span class="comment">// å®šä¹‰ 3D åœºæ™¯</span></span><br><span class="line">    init()</span><br><span class="line">    <span class="comment">// å®šä¹‰åŠ¨ç”»</span></span><br><span class="line">    animate()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºæ¸²æŸ“å¯¹è±¡</span></span><br><span class="line">    renderer = <span class="keyword">new</span> THREE.WebGLRenderer()</span><br><span class="line">    renderer.setSize(<span class="built_in">window</span>.innerWidth, <span class="built_in">window</span>.innerHeight)</span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(renderer.domElement)</span><br><span class="line">    <span class="comment">// åˆ›å»ºé€è§†ç›¸æœº</span></span><br><span class="line">    camera = <span class="keyword">new</span> THREE.PerspectiveCamera(<span class="number">70</span>, <span class="built_in">window</span>.innerWidth / <span class="built_in">window</span>.innerHeight, <span class="number">1</span>, <span class="number">1000</span>)</span><br><span class="line">    camera.position.z = <span class="number">600</span></span><br><span class="line">    <span class="comment">// åˆ›å»ºåœºæ™¯å¯¹è±¡</span></span><br><span class="line">    scene = <span class="keyword">new</span> THREE.Scene()</span><br><span class="line">    <span class="comment">// åˆ›å»ºå‡ ä½•ä½“å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">var</span> geometry = <span class="keyword">new</span> THREE.CubeGeometry(<span class="number">200</span>, <span class="number">200</span>, <span class="number">200</span>)</span><br><span class="line">    <span class="comment">// åˆ›å»ºçº¹ç†ï¼ˆå³æ—¶é’Ÿï¼‰</span></span><br><span class="line">    texture = <span class="keyword">new</span> THREE.Texture(canvas)</span><br><span class="line">    <span class="comment">// å°†çº¹ç†ä¼ é€’ç»™æè´¨</span></span><br><span class="line">    material = <span class="keyword">new</span> THREE.MeshBasicMaterial(&#123; <span class="attr">map</span>: texture &#125;)</span><br><span class="line">    texture.needsUpdate = <span class="literal">true</span></span><br><span class="line">    <span class="comment">// åˆ›å»ºæ¨¡å‹</span></span><br><span class="line">    mesh = <span class="keyword">new</span> THREE.Mesh(geometry, material)</span><br><span class="line">    <span class="comment">// å°†æ¨¡å‹æ·»åŠ åˆ°åœºæ™¯</span></span><br><span class="line">    scene.add(mesh)</span><br><span class="line">    renderer.clear()</span><br><span class="line">    <span class="comment">// åœºæ™¯æ¸²æŸ“</span></span><br><span class="line">    renderer.render(scene, camera)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">animate</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    texture.needsUpdate = <span class="literal">true</span></span><br><span class="line">    mesh.rotation.y -= <span class="number">0.01</span></span><br><span class="line">    mesh.rotation.x -= <span class="number">0.01</span></span><br><span class="line">    requestAnimationFrame(animate)</span><br><span class="line">    renderer.clear()</span><br><span class="line">    renderer.render(scene, camera)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// èµ·å§‹å‡½æ•°è°ƒç”¨</span></span><br><span class="line">start()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resize</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    camera.aspect = <span class="built_in">window</span>.innerWidth / <span class="built_in">window</span>.innerHeight</span><br><span class="line">    camera.updateProjectionMatrix()</span><br><span class="line">    renderer.setSize(<span class="built_in">window</span>.innerWidth, <span class="built_in">window</span>.innerHeight)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'resize'</span>, resize)</span><br></pre></td></tr></table></figure></p><p>ç»ˆäºå¤§åŠŸå‘Šæˆï¼</p><p><a href="http://zdddrszj.github.io/h5case/3DClock/index.html">æŸ¥çœ‹demo</a></p><p><g-emoji alias="yum" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f60b.png" ios-version="6.0">ğŸ˜‹</g-emoji><g-emoji alias="yum" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f60b.png" ios-version="6.0">ğŸ˜‹</g-emoji><g-emoji alias="yum" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f60b.png" ios-version="6.0">ğŸ˜‹</g-emoji></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä»Šå¤©æˆ‘ä»¬åˆ©ç”¨ &lt;code&gt;canvas&lt;/code&gt; å’Œ &lt;code&gt;threejs&lt;/code&gt; åŸºç¡€çŸ¥è¯†æ¥åšä¸€ä¸ªå¯ä»¥æ—‹è½¬çš„ 3D æ—¶é’ŸåŠ¨æ•ˆã€‚æ•ˆæœå¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://zdddrszj.github.io/h5case/3DClock/3
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://zdddrszj.github.io/h-blog/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="canvas" scheme="https://zdddrszj.github.io/h-blog/tags/canvas/"/>
    
      <category term="threejs" scheme="https://zdddrszj.github.io/h-blog/tags/threejs/"/>
    
  </entry>
  
  <entry>
    <title>ç‚¹çº¿å›¾åŠ¨ç”»</title>
    <link href="https://zdddrszj.github.io/h-blog/2017/10/17/dotsAndLineAni/"/>
    <id>https://zdddrszj.github.io/h-blog/2017/10/17/dotsAndLineAni/</id>
    <published>2017-10-17T11:08:32.000Z</published>
    <updated>2018-06-23T08:19:44.892Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸–ç•Œæµ©ç€šæ— è¾¹ï¼Œç„¶è€Œéƒ½æ˜¯ç”±ç²’å­ç»„æˆï¼›ä¸€å¥è€è¯å¤æ‚çš„ä¸œè¥¿éƒ½æ˜¯ç”±ç®€å•çš„ä¸œè¥¿ç»„æˆã€‚</p><p>æœ¬æ–‡ä¸»é¢˜æ˜¯ä¸€ä¸ªå¤§å®¶ç»å¸¸çœ‹åˆ°çš„ç‚¹çº¿å›¾ç®€å•åŠ¨ç”»ï¼Œå³ä¸‹å›¾ï¼Œæ‰€ä»¥ç›´æ¥æ¥ä»£ç å§ï¼</p><p><img src="http://zdddrszj.github.io/h5case/DotAndLineAni/dotAndLineAni.gif" alt="dotAndLineAni"></p><p>é¦–å…ˆå£°æ˜ä¸€äº› <code>js</code> å˜é‡ï¼ˆè¿™äº›å˜é‡ä¸ç”¨æå‰çŸ¥æ™“ï¼Œè¿›å…¥ç”»å›¾é€»è¾‘æ—¶è‡ªç„¶çŸ¥é“éœ€è¦å£°æ˜å“ªäº›å˜é‡ï¼‰<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”»å¸ƒä¸Šæ‰€æœ‰ç‚¹å¯¹è±¡æ•°ç»„</span></span><br><span class="line"><span class="keyword">let</span> dotsArr = [],</span><br><span class="line">   canvas = <span class="built_in">document</span>.getElementById(<span class="string">'canvas'</span>),</span><br><span class="line">   ctx = canvas.getContext(<span class="string">'2d'</span>),</span><br><span class="line">   width = <span class="built_in">document</span>.documentElement.offsetWidth || <span class="built_in">document</span>.body.offsetWidth,</span><br><span class="line">   height = <span class="built_in">document</span>.documentElement.offsetHeight || <span class="built_in">document</span>.documentElement.offsetHeight,</span><br><span class="line">   <span class="comment">// ç”»å¸ƒç‚¹çš„æ•°é‡</span></span><br><span class="line">   dotsNum = <span class="built_in">parseInt</span>(width * height / <span class="number">8000</span>),</span><br><span class="line">   <span class="comment">// ä¸¤ä¸ªç‚¹å¯ä»¥è¿çº¿çš„é—´è·ä¸´ç•Œå€¼</span></span><br><span class="line">   dotsDistance = <span class="number">100</span></span><br><span class="line">   <span class="comment">// ç”»å¸ƒç‚¹æœ€å¤§æ•°é‡</span></span><br><span class="line">   maxDotsNum = dotsNum * <span class="number">1.5</span></span><br><span class="line">   <span class="comment">// å¤šå‡ºçš„ç‚¹æ•°é‡</span></span><br><span class="line">   overDotsNum = <span class="number">0</span></span><br><span class="line">   <span class="comment">// è®¾ç½®ç”»å¸ƒå¤§å°ï¼ˆæ³¨æ„ï¼šè¿™é‡Œä¸èƒ½ç”¨styleä»£æ›¿ï¼‰</span></span><br><span class="line">   canvas.setAttribute(<span class="string">'width'</span>, width)</span><br><span class="line">   canvas.setAttribute(<span class="string">'height'</span>, height)</span><br></pre></td></tr></table></figure></p><p>htmlç»“æ„<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">"canvas"</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h3><span id="ä¸€-ç”»ç‚¹">ä¸€ã€ç”»ç‚¹</span></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç‚¹å¯¹è±¡</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Dot</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.canvas</span><br><span class="line">    <span class="keyword">this</span>.ctx</span><br><span class="line">    <span class="comment">// xè½´åæ ‡</span></span><br><span class="line">    <span class="keyword">this</span>.x</span><br><span class="line">    <span class="comment">// yè½´åæ ‡</span></span><br><span class="line">    <span class="keyword">this</span>.y</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç‚¹åˆå§‹åŒ–æ–¹æ³•</span></span><br><span class="line">Dot.prototype = &#123;</span><br><span class="line">init: <span class="function"><span class="keyword">function</span> (<span class="params">canvas, x, y</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.canvas = canvas</span><br><span class="line">        <span class="keyword">this</span>.ctx = <span class="keyword">this</span>.canvas.getContext(<span class="string">'2d'</span>)</span><br><span class="line">        <span class="comment">// éšæœºxè½´åæ ‡</span></span><br><span class="line">        <span class="keyword">this</span>.x = x || <span class="built_in">Math</span>.random() * <span class="keyword">this</span>.canvas.width</span><br><span class="line">        <span class="comment">// éšæœºyè½´åæ ‡</span></span><br><span class="line">        <span class="keyword">this</span>.y = y || <span class="built_in">Math</span>.random() * <span class="keyword">this</span>.canvas.height</span><br><span class="line">        <span class="comment">// éšæœºåŠå¾„</span></span><br><span class="line">        <span class="keyword">this</span>.r = <span class="built_in">Math</span>.random() * <span class="number">4</span></span><br><span class="line">        <span class="comment">// éšæœºæ°´å¹³é€Ÿåº¦</span></span><br><span class="line">        <span class="keyword">this</span>.vx = <span class="built_in">Math</span>.random() * <span class="number">2</span> - <span class="number">1</span></span><br><span class="line">        <span class="comment">// éšæœºå‚ç›´é€Ÿåº¦</span></span><br><span class="line">        <span class="keyword">this</span>.vy = <span class="built_in">Math</span>.random() * <span class="number">2</span> - <span class="number">1</span></span><br><span class="line">        <span class="comment">// ç”»ä¸ªå®å¿ƒç‚¹</span></span><br><span class="line">        <span class="keyword">this</span>.ctx.beginPath()</span><br><span class="line">        <span class="keyword">this</span>.ctx.arc(<span class="keyword">this</span>.x, <span class="keyword">this</span>.y, <span class="keyword">this</span>.r, <span class="number">0</span>, <span class="number">2</span> * <span class="built_in">Math</span>.PI)</span><br><span class="line">        <span class="keyword">this</span>.ctx.fillStyle = <span class="string">"rgba(255, 255, 255, .8)"</span></span><br><span class="line">        <span class="keyword">this</span>.ctx.fill()</span><br><span class="line">        <span class="keyword">this</span>.ctx.closePath()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// éšæœºç”Ÿæˆä¸€å®šæ•°é‡çš„ç‚¹ï¼Œç”»åˆ°ç”»å¸ƒä¸Šçš„åŒæ—¶ï¼Œå°†å…¶å­˜å‚¨åœ¨dotsArræ•°ç»„ä¸­ï¼Œæ›´æ–°ç”»å¸ƒæ—¶ç”¨</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; dotsNum; i ++) &#123;</span><br><span class="line">    <span class="keyword">var</span> dot = <span class="keyword">new</span> Dot()</span><br><span class="line">    dotsArr.push(dot)</span><br><span class="line">    dot.init(canvas)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="äºŒ-ç”»çº¿åŠåŠ¨æ•ˆ">äºŒã€ç”»çº¿åŠåŠ¨æ•ˆ</span></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> requestAnimationFrame = requestAnimationFrame || webkitRequestAnimationFrame || oRequestAnimationFrame || msRequestAnimationFrame</span><br><span class="line">requestAnimationFrame(updateCanvas)</span><br><span class="line"><span class="comment">// æ›´æ–°ç”»å¸ƒ</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateCanvas</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// æ¸…ç©ºç”»å¸ƒ</span></span><br><span class="line">    ctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, canvas.width, canvas.height)</span><br><span class="line">    <span class="comment">// ç‚¹çš„ä¸ªæ•°ä¸º dotsNum ~ dotsNumï¼Œå³ 0 ~ dotsNum æˆ–è€… (dotsNum - maxDotsNum) ~ dotsNum</span></span><br><span class="line">    <span class="keyword">if</span> (dotsNum &gt; maxDotsNum) &#123;</span><br><span class="line">        overDotsNum = dotsNum - maxDotsNum</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> j = overDotsNum; j &lt; dotsNum; j ++) &#123;</span><br><span class="line">    <span class="comment">// æ›´æ–°ç‚¹åæ ‡</span></span><br><span class="line">        dotsArr[j].update()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç”»çº¿</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> m = overDotsNum; m &lt; dotsNum; m ++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> n = m + <span class="number">1</span>; n &lt; dotsNum; n ++) &#123;</span><br><span class="line">            <span class="keyword">let</span> dx = dotsArr[m].x - dotsArr[n].x</span><br><span class="line">            <span class="keyword">let</span> dy = dotsArr[m].y - dotsArr[n].y</span><br><span class="line">            <span class="comment">// ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»</span></span><br><span class="line">            <span class="keyword">let</span> d = <span class="built_in">Math</span>.sqrt(<span class="built_in">Math</span>.pow(dx, <span class="number">2</span>) + <span class="built_in">Math</span>.pow(dy, <span class="number">2</span>))</span><br><span class="line">            <span class="keyword">if</span> (d &lt; dotsDistance) &#123;</span><br><span class="line">                ctx.beginPath()</span><br><span class="line">                ctx.moveTo(dotsArr[m].x, dotsArr[m].y)</span><br><span class="line">                ctx.lineTo(dotsArr[n].x, dotsArr[n].y)</span><br><span class="line">                ctx.strokeStyle = <span class="string">'rgba(255, 255, 255, '</span> + (dotsDistance - d) / dotsDistance + <span class="string">')'</span></span><br><span class="line">                ctx.strokeWidth = <span class="number">1</span></span><br><span class="line">                ctx.stroke()</span><br><span class="line">                ctx.closePath()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é‡æ–°æ¸²æŸ“ç”»å¸ƒ</span></span><br><span class="line">    requestAnimationFrame(updateCanvas)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ›´æ–°ç‚¹åæ ‡</span></span><br><span class="line">Dot.prototype.update = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="comment">// è·å–æ­¤æ—¶è¯¥ç‚¹åæ ‡</span></span><br><span class="line"><span class="keyword">this</span>.x = <span class="keyword">this</span>.x + <span class="keyword">this</span>.vx</span><br><span class="line">    <span class="keyword">this</span>.y = <span class="keyword">this</span>.y + <span class="keyword">this</span>.vy</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç‚¹è¶Šç•Œåè°ƒç”¨inité‡æ–°éšæœºç”Ÿæˆ å› ä¸ºç‚¹çš„ä¸ªæ•°å›ºå®šï¼Œå±å¹•å®æ—¶ç»˜åˆ¶ï¼Œæ‰€ä»¥ç§»å‡ºå±å¹•çš„ç‚¹å¯¹è±¡ä¸ç”¨è€ƒè™‘å å†…å­˜ä¹‹ç±»çš„</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.x &lt; <span class="number">0</span> || <span class="keyword">this</span>.x &gt; <span class="keyword">this</span>.canvas.width) &#123;</span><br><span class="line">        <span class="keyword">this</span>.init(<span class="keyword">this</span>.canvas)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.y &lt; <span class="number">0</span> || <span class="keyword">this</span>.y &gt; <span class="keyword">this</span>.canvas.height) &#123;</span><br><span class="line">        <span class="keyword">this</span>.init(<span class="keyword">this</span>.canvas);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.ctx.beginPath()</span><br><span class="line">    <span class="keyword">this</span>.ctx.arc(<span class="keyword">this</span>.x, <span class="keyword">this</span>.y, <span class="keyword">this</span>.r, <span class="number">0</span>, <span class="number">2</span> * <span class="built_in">Math</span>.PI)</span><br><span class="line">    <span class="keyword">this</span>.ctx.fillStyle = <span class="string">"rgba(255,255,255,.8)"</span></span><br><span class="line">    <span class="keyword">this</span>.ctx.fill()</span><br><span class="line">    <span class="keyword">this</span>.ctx.closePath()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡ŒåŸºæœ¬åŠŸèƒ½å·²ç»å®Œæˆï¼Œä¸‹è¾¹ä»‹ç»ä¸€ä¸‹é¼ æ ‡ç‚¹å‡»å’Œç§»åŠ¨äº‹ä»¶çš„åŠ¨æ•ˆã€‚</p><h3><span id="ä¸‰-é¼ æ ‡ç‚¹å‡»äº‹ä»¶">ä¸‰ã€é¼ æ ‡ç‚¹å‡»äº‹ä»¶</span></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// äº‹ä»¶ç»‘å®š</span></span><br><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">'click'</span>, handleClick)</span><br><span class="line"><span class="comment">// å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleClick</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> x = e.pageX</span><br><span class="line">    <span class="keyword">let</span> y = e.pageY</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; <span class="number">5</span>; j ++) &#123;</span><br><span class="line">        dotsNum ++</span><br><span class="line">        <span class="keyword">var</span> dot = <span class="keyword">new</span> Dot()</span><br><span class="line">        dotsArr.push(dot)</span><br><span class="line">        dot.init(canvas, x, y)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="å››-é¼ æ ‡ç§»åŠ¨äº‹ä»¶">å››ã€é¼ æ ‡ç§»åŠ¨äº‹ä»¶</span></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// äº‹ä»¶ç»‘å®š</span></span><br><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">'mousemove'</span>, handleMousemove)</span><br><span class="line"><span class="comment">// å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleMousemove</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> x = e.pageX,</span><br><span class="line">        y = e.pageY</span><br><span class="line">    <span class="keyword">if</span> ((x &gt; <span class="number">0</span> &amp;&amp; x &lt; width) &amp;&amp; (y &gt; <span class="number">0</span> &amp;&amp; y &lt; height)) &#123;</span><br><span class="line">        <span class="comment">// dotä¸ºç”»å¸ƒä¸Šæœ€åç”»çš„æœ€åä¸€ä¸ªç‚¹</span></span><br><span class="line">        dot.followMouse(x, y)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// é¼ æ ‡è·ŸéšåŠé‡æ–°å®šä¹‰ç‚¹çš„åæ ‡</span></span><br><span class="line">Dot.prototype.followMouse = <span class="function"><span class="keyword">function</span> (<span class="params">tx, ty</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.x = tx</span><br><span class="line">    <span class="keyword">this</span>.y = ty</span><br><span class="line">    <span class="keyword">this</span>.ctx.beginPath()</span><br><span class="line">    <span class="keyword">this</span>.ctx.arc(<span class="keyword">this</span>.x, <span class="keyword">this</span>.y, <span class="keyword">this</span>.r, <span class="number">0</span>, <span class="number">2</span>*<span class="built_in">Math</span>.PI)</span><br><span class="line">    <span class="keyword">this</span>.ctx.fillStyle = <span class="string">"rgba(255,0,0,.8)"</span></span><br><span class="line">    <span class="keyword">this</span>.ctx.fill()</span><br><span class="line">    <span class="keyword">this</span>.ctx.closePath()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><g-emoji alias="yum" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f60b.png" ios-version="6.0">ğŸ˜‹</g-emoji><g-emoji alias="yum" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f60b.png" ios-version="6.0">ğŸ˜‹</g-emoji><g-emoji alias="yum" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f60b.png" ios-version="6.0">ğŸ˜‹</g-emoji> å¥½äº†ï¼Œåˆ°æ­¤å°±ç»“æŸå•¦~</p><p><a href="http://zdddrszj.github.io/h5case/DotAndLineAni/dotAndLineAni.html">æŸ¥çœ‹demo</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä¸–ç•Œæµ©ç€šæ— è¾¹ï¼Œç„¶è€Œéƒ½æ˜¯ç”±ç²’å­ç»„æˆï¼›ä¸€å¥è€è¯å¤æ‚çš„ä¸œè¥¿éƒ½æ˜¯ç”±ç®€å•çš„ä¸œè¥¿ç»„æˆã€‚&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡ä¸»é¢˜æ˜¯ä¸€ä¸ªå¤§å®¶ç»å¸¸çœ‹åˆ°çš„ç‚¹çº¿å›¾ç®€å•åŠ¨ç”»ï¼Œå³ä¸‹å›¾ï¼Œæ‰€ä»¥ç›´æ¥æ¥ä»£ç å§ï¼&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://zdddrszj.github.io/h5case/DotAnd
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://zdddrszj.github.io/h-blog/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="canvas" scheme="https://zdddrszj.github.io/h-blog/tags/canvas/"/>
    
      <category term="html5" scheme="https://zdddrszj.github.io/h-blog/tags/html5/"/>
    
  </entry>
  
  <entry>
    <title>Canvas å¤šçƒç¢°æ’å’Œåå¼¹</title>
    <link href="https://zdddrszj.github.io/h-blog/2017/09/27/bounce-and-collision/"/>
    <id>https://zdddrszj.github.io/h-blog/2017/09/27/bounce-and-collision/</id>
    <published>2017-09-27T06:01:14.000Z</published>
    <updated>2018-06-23T08:19:44.891Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><ul><li><a href="#ä¸€-çŸ¢é‡ç§»åŠ¨">ä¸€ã€çŸ¢é‡ç§»åŠ¨</a></li><li><a href="#äºŒ-å¤šçƒæ’å¢™åå¼¹">äºŒã€å¤šçƒæ’å¢™åå¼¹</a><ul><li><a href="#ç¬¬ä¸€ä¸ªé—®é¢˜å¤šçƒæ²¿çŸ¢é‡è¿åŠ¨">ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šå¤šçƒæ²¿çŸ¢é‡è¿åŠ¨</a></li><li><a href="#ç¬¬äºŒä¸ªé—®é¢˜å¦‚ä½•åå¼¹">ç¬¬äºŒä¸ªé—®é¢˜ï¼šå¦‚ä½•åå¼¹</a></li></ul></li></ul><!-- tocstop --><p>ç°å®ä¸–ç•Œä¸­ä¸‡åƒä¸‡ç‰©éƒ½æœ‰å…¶ç‹¬è‡ªçš„è¿è¡Œè½¨è¿¹ï¼Œä¾‹å¦‚ç›´çº¿ã€åœ†ã€èºæ—‹å’Œå¤æ‚çš„è´å¡å°”æ›²çº¿ã€‚ä»Šå¤©æˆ‘ä»¬ä¸€èµ·æ¥å­¦ä¹ ä¸€ä¸‹å¦‚ä½•ç”¨ <code>Canvas</code> å®ç°æœ€å¹³å‡¡çš„ç›´çº¿è¿åŠ¨ã€‚<code>Canvas</code> ç”»å›¾åŸºç¡€çŸ¥è¯†å¯å‚è€ƒ <a href="http://www.w3school.com.cn/html5/html_5_canvas.asp" target="_blank" rel="noopener">w3school åœ¨çº¿æ•™ç¨‹</a> ã€‚</p><h3><span id="ä¸€-çŸ¢é‡ç§»åŠ¨">ä¸€ã€çŸ¢é‡ç§»åŠ¨</span></h3><p>è¦æƒ³ä¸ºå›¾åƒè®¾ç½®åŠ¨ç”»æ•ˆæœï¼Œå¯ä»¥é‡‡ç”¨æ¯æ¬¡ä¸ºå¯¹è±¡ç»˜åˆ¶ä¸åŒçš„ <code>x</code> åæ ‡å’Œ <code>y</code> åæ ‡ï¼Œç„¶ååœ¨æ¯ä¸€å¸§ä¸­è°ƒç”¨æ˜¾ç¤ºæ›´æ–°å›¾åƒçš„å‡½æ•°å³å¯ã€‚åˆå§‹åŒ–èµ·å§‹ç‚¹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p1 = &#123;<span class="attr">x</span>:<span class="number">20</span>,<span class="attr">y</span>:<span class="number">20</span>&#125;; <span class="comment">//åˆå§‹ç‚¹åæ ‡</span></span><br><span class="line"><span class="keyword">var</span> ball = &#123;<span class="attr">x</span>:p1.x,<span class="attr">y</span>:p1.y,<span class="attr">radius</span>:<span class="number">10</span>&#125;; <span class="comment">//å°çƒåˆå§‹åæ ‡åŠåŠå¾„</span></span><br></pre></td></tr></table></figure><p>åœ¨ä¸¤ç‚¹ä¹‹é—´ç§»åŠ¨å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯å¾ˆå¤šæ—¶å€™å¹¶æ²¡æœ‰ä¸€ä¸ªè¦ç§»åˆ°å“ªé‡Œå»çš„ç›®æ ‡ç‚¹ï¼Œåªæœ‰ä»å“ªé‡Œå¼€å§‹çš„èµ·å§‹ç‚¹ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œåˆ›å»ºä¸€ä¸ª <code>vector</code> ä½œä¸ºç§»åŠ¨å¯¹è±¡å°±éå¸¸æœ‰ç”¨äº†ã€‚</p><p>çŸ¢é‡æ˜¯ä¸€ä¸ªå…·æœ‰æ•°é‡å’Œæ–¹å‘çš„ç‰©ç†é‡ã€‚æ•°é‡å°±æ˜¯å¯¹è±¡ç§»åŠ¨çš„é€Ÿåº¦ <code>speed</code> çš„å€¼ï¼Œæ–¹å‘å°±æ˜¯å¯¹è±¡ç§»åŠ¨çš„è§’åº¦ <code>angle</code> çš„å€¼ã€‚ç°åœ¨ï¼Œå°†å¯¹è±¡ç§»åŠ¨çš„è§’åº¦ <code>angle</code> çš„å€¼ï¼ˆæ–¹å‘ï¼‰è®¾ä¸º <code>45Â°</code>ï¼Œåœ¨æ•°å­¦ä¸Šï¼Œå¹³æ»‘ç›´çº¿é€šå¸¸ä»£è¡¨è§’åº¦ä¸º <code>0</code> ï¼Œ<code>45Â°</code> çš„çŸ¢é‡å°±æ„å‘³ç€å‘å³ä¸‹æ–¹ç§»åŠ¨ã€‚</p><p>å¼§åº¦ <code>radians</code> æ˜¯åº¦é‡è§’åº¦çš„æ ‡å‡†å•ä½ï¼Œå¤§éƒ¨åˆ†æ•°å­¦è®¡ç®—éƒ½éœ€è¦å°†è§’åº¦è½¬æ¢ä¸ºå¼§åº¦æ‰èƒ½ä½¿ç”¨ã€‚å°†è§’åº¦è½¬ä¸ºå¼§åº¦ï¼Œä½¿ç”¨æ ‡å‡†æ–¹ç¨‹å¼ <code>radians = angle * Math.PI/180</code> å³å¯ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> angle = <span class="number">45</span>; <span class="comment">//è§’åº¦</span></span><br><span class="line"><span class="keyword">var</span> radians = angle * <span class="built_in">Math</span>.PI/<span class="number">180</span>; <span class="comment">//å¼§åº¦</span></span><br></pre></td></tr></table></figure><p>è®¡ç®—å¯¹è±¡æ²¿çŸ¢é‡è¿åŠ¨æ—¶çš„åæ ‡å€¼ï¼Œè¯·çœ‹ä¸‹é¢ç®€ç•¥2Dåæ ‡å›¾ï¼š</p><p><img src="https://cloud.githubusercontent.com/assets/9649921/13239696/2de0e6e6-da17-11e5-8d5b-3f131eca04f5.png" alt="1"></p><p>å¯ä»¥çœ‹å‡ºï¼Œä½™å¼¦é€šå¸¸ä¸ <code>x</code> å€¼æœ‰å…³ï¼Œæ­£å¼¦é€šå¸¸ä¸ <code>y</code> å€¼æœ‰å…³ï¼Œå¯ä»¥åˆ©ç”¨ <code>sin</code> å’Œ <code>cos</code> æ¥è®¡ç®—å¯¹è±¡æ²¿çŸ¢é‡çš„ç§»åŠ¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> speed = <span class="number">5</span>; <span class="comment">//é€Ÿåº¦</span></span><br><span class="line"><span class="keyword">var</span> xunits = <span class="built_in">Math</span>.cos(radians) * speed; <span class="comment">//xåæ ‡å¢é‡</span></span><br><span class="line"><span class="keyword">var</span> yunits = <span class="built_in">Math</span>.sin(radians) * speed;  <span class="comment">//yåæ ‡å¢é‡</span></span><br></pre></td></tr></table></figure><p>åœ¨æ¸²æŸ“ç”»å¸ƒ <code>drawScreen()</code> å‡½æ•°ä¸­ï¼Œå°† <code>ball.x</code> å’Œ <code>ball.y</code> åˆ†åˆ«åŠ ä¸Š <code>xunits</code> å’Œ <code>yunits</code> ï¼Œå³å¯éšæ—¶æ›´æ–°å°çƒä½ç½®åæ ‡ç‚¹ã€‚</p><p><code>drawScreen()</code> å‡½æ•°è¯¦ç»†å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ¸²æŸ“ç”»å¸ƒ</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">drawScreen</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    context.fillStyle = <span class="string">'#eee'</span>;</span><br><span class="line">    context.fillRect(<span class="number">0</span>,<span class="number">0</span>,theCanvas.width,theCanvas.height);</span><br><span class="line">    context.strokeRect(<span class="number">1</span>,<span class="number">1</span>,theCanvas.width<span class="number">-2</span>,theCanvas.height<span class="number">-2</span>);</span><br><span class="line">    context.fillStyle = <span class="string">'red'</span>;</span><br><span class="line"></span><br><span class="line">    ball.x += xunits;</span><br><span class="line">    ball.y += yunits;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°çƒæ’å¢™æ£€æµ‹</span></span><br><span class="line">    <span class="keyword">if</span>(ball.x+ball.radius &gt; theCanvas.width)&#123;</span><br><span class="line">        ball = &#123;<span class="attr">x</span>:p1.x,<span class="attr">y</span>:p1.y,<span class="attr">radius</span>:<span class="number">10</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    context.beginPath();</span><br><span class="line">    context.arc(ball.x,ball.y,ball.radius,<span class="number">0</span>,<span class="built_in">Math</span>.PI*<span class="number">2</span>,<span class="literal">true</span>);</span><br><span class="line">    context.closePath();</span><br><span class="line">    context.fill();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¡†æ¶ <code>javascript</code> ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'load'</span>,eventWindowLoaded,<span class="literal">false</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">eventWindowLoaded</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    canvasApp();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åˆ¤æ–­æµè§ˆå™¨æ˜¯å¦æ”¯æŒcanvasæ ‡ç­¾</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">canvasSupport</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !!<span class="built_in">document</span>.createElement(<span class="string">'canvas'</span>).getContext;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ä¸»å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">canvasApp</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!canvasSupport())&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–   ä»£ç çœç•¥...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> theCanvas = <span class="built_in">document</span>.getElementById(<span class="string">'canvasOne'</span>);</span><br><span class="line">    <span class="keyword">var</span> context = theCanvas.getContext(<span class="string">'2d'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ¸²æŸ“ç”»å¸ƒ   ä»£ç çœç•¥...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> timeOut = setInterval(drawScreen,<span class="number">100</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>html</code> ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"position:absolute;top:50px;left:50px;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">"canvasOne"</span> <span class="attr">width</span>=<span class="string">"200"</span> <span class="attr">height</span>=<span class="string">"200"</span>&gt;</span></span><br><span class="line">        è¯¥æµè§ˆå™¨ä¸æ”¯æŒcanvasã€‚</span><br><span class="line">    <span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå®ç°æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="https://cloud.githubusercontent.com/assets/9649921/13216469/e75cbd06-d996-11e5-8264-c437ca18a3ff.gif" alt="jdfw"></p><p><a href="http://yixunfe.github.io/blog/demo/57/demo.html" target="_blank" rel="noopener">æŸ¥çœ‹demo</a></p><h3><span id="äºŒ-å¤šçƒæ’å¢™åå¼¹">äºŒã€å¤šçƒæ’å¢™åå¼¹</span></h3><p>å°½ç®¡åˆ›å»ºä¸€ä¸ªæœ‰æ•°é‡ã€æœ‰æ–¹å‘çš„çŸ¢é‡å¹¶è®©å¯¹è±¡æ²¿ç€å®ƒç²¾ç¡®ç§»åŠ¨çœ‹èµ·æ¥å¾ˆæœ‰åŠ¨ç”»æ„Ÿï¼Œä½†æ˜¯ç°å®ä¸­å´å¾ˆå°‘å‡ºç°ç±»ä¼¼çš„è¿åŠ¨ã€‚å¤§éƒ¨åˆ†æ—¶å€™ï¼Œäººä»¬ä¼šå¸Œæœ›è¿™ä¸ªå¯¹è±¡èƒ½å¯¹å‘¨å›´çš„ä¸–ç•Œæœ‰ååº”ï¼Œä¾‹å¦‚æ’ä¸Šæ°´å¹³æˆ–è€…å‚ç›´çš„å¢™åèƒ½å¼¹å›æ¥ã€‚</p><p>æ ¹æ®ç¬¬ä¸€å°èŠ‚çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“ä¸€ä¸ªçƒå¦‚ä½•æ²¿çŸ¢é‡è¿åŠ¨ï¼Œé‚£ä¹ˆå¤šçƒæ’å¢™åå¼¹éœ€è¦è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼Œåˆ†åˆ«æ˜¯å¤šçƒæ²¿çŸ¢é‡è¿åŠ¨å’Œå¦‚ä½•åå¼¹ã€‚</p><h4><span id="ç¬¬ä¸€ä¸ªé—®é¢˜å¤šçƒæ²¿çŸ¢é‡è¿åŠ¨">ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šå¤šçƒæ²¿çŸ¢é‡è¿åŠ¨</span></h4><p>ä¸ºå®ç°å¤šçƒåº”ç”¨ç¨‹åºï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡æ¥æ§åˆ¶å…³äºæ¯ä¸ªåå¼¹çƒçš„æ‰€æœ‰ç›¸å…³ä¿¡æ¯ï¼š<code>xã€yã€ radiusã€speedã€angleã€radiansã€xunitsã€yunits</code> ã€‚è¿™é‡Œå‡è®¾æˆ‘ä»¬è¦åˆ›å»º100ä¸ªè¿™æ ·çš„éšæœºå°çƒï¼Œç»™äºˆä¸åŒçš„é€Ÿåº¦ï¼ŒåŠå¾„å’ŒçŸ¢é‡ï¼Œå¦‚æœç”¨ä»£ç è¡¨ç¤ºï¼Œå³ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å®šä¹‰çƒæ•°é‡</span></span><br><span class="line"><span class="keyword">var</span> numBalls = <span class="number">100</span>;</span><br><span class="line"><span class="comment">//çƒæœ€å¤§åŠå¾„ æœ€å°åŠå¾„</span></span><br><span class="line"><span class="keyword">var</span> maxSize = <span class="number">6</span>,minSize = <span class="number">4</span>;</span><br><span class="line"><span class="comment">//å®šä¹‰çƒæœ€å¤§é€Ÿåº¦</span></span><br><span class="line"><span class="keyword">var</span> maxspeed=maxSize+<span class="number">5</span>;</span><br><span class="line"><span class="comment">//çƒå¯¹è±¡æ•°ç»„</span></span><br><span class="line"><span class="keyword">var</span> balls = [];</span><br><span class="line"><span class="comment">// å½“å‰çƒ xåæ ‡ yåæ ‡ é€Ÿåº¦ è§’åº¦ åŠå¾„ å¼§åº¦ xæ–¹å‘å¢é‡ yæ–¹å‘å¢é‡</span></span><br><span class="line"><span class="keyword">var</span> tempBall,tempX,tempY,tempSpeed,tempAngle,tempRadius,tempRadians,tempXunits,tempYunits;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆå§‹åŒ–100ä¸ªçƒ</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span> ; i &lt; numBalls; i ++)&#123;</span><br><span class="line">    tempRadius = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*maxSize)+minSize;</span><br><span class="line">    tempX = tempRadius + <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*(theCanvas.width - tempRadius*<span class="number">2</span>));</span><br><span class="line">    tempY = tempRadius + <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*(theCanvas.height - tempRadius*<span class="number">2</span>));</span><br><span class="line">    tempSpeed = maxspeed - tempRadius;</span><br><span class="line">    tempAngle = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">360</span>);</span><br><span class="line">    tempRadians = tempAngle * <span class="built_in">Math</span>.PI/<span class="number">180</span>;</span><br><span class="line">    tempXunits = <span class="built_in">Math</span>.cos(tempRadians) * tempSpeed;</span><br><span class="line">    tempYunits = <span class="built_in">Math</span>.sin(tempRadians) * tempSpeed;</span><br><span class="line"></span><br><span class="line">    tempBall = &#123;<span class="attr">x</span>:tempX,<span class="attr">y</span>:tempY,<span class="attr">radius</span>:tempRadius,<span class="attr">speed</span>:tempSpeed,<span class="attr">angle</span>:tempAngle,<span class="attr">radians</span>:tempRadians,<span class="attr">xunits</span>:tempXunits,<span class="attr">yunits</span>:tempYunits&#125;;</span><br><span class="line">    balls.push(tempBall);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="ç¬¬äºŒä¸ªé—®é¢˜å¦‚ä½•åå¼¹">ç¬¬äºŒä¸ªé—®é¢˜ï¼šå¦‚ä½•åå¼¹</span></h4><p>ä¸ºäº†æ›´å¥½ç†è§£åå¼¹åŠ¨ç”»ï¼Œå…ˆæ¥çœ‹ä¸€ä¸ªç®€å•çš„ç‰©ç†åŸç†ã€‚è¿™æ¡åŸç†ç»å¸¸ç”¨äºå…‰çº¿ä¸Šï¼Œä½†å¯¹äºåŠ¨ç”»2Då½¢çŠ¶ä¹Ÿéå¸¸æœ‰ç”¨ï¼Œç‰¹åˆ«æ˜¯å¯¹è±¡æ’ä¸Šæ°´å¹³æˆ–å‚ç›´çš„å¢™åå¼¹çš„æƒ…å†µã€‚è¿™ä¸ªåŸç†å°±æ˜¯ <strong>åå°„è§’åŸç†</strong>ï¼Œå³å…¥å°„è§’ç­‰äºåå°„è§’ã€‚</p><p>å…¥å°„è§’æ˜¯å¯¹è±¡æ’å¢™æ—¶çš„è§’åº¦ï¼Œåå°„è§’æ˜¯å¯¹è±¡ä»å¢™é¢åå¼¹å›æ¥çš„è§’åº¦ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://cloud.githubusercontent.com/assets/9649921/13242615/971719e0-da31-11e5-9ddd-888dc8878cf7.png" alt="2"></p><p>ç”±æ­¤å¯çŸ¥ï¼Œ<code>åå¼¹è§’ = 180 - å…¥å°„è§’</code>ã€‚</p><p> <code>javascript</code> ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ball.x ä»£è¡¨å°çƒ x åæ ‡ ball.y ä»£è¡¨å°çƒ y åæ ‡</span></span><br><span class="line"><span class="keyword">if</span>(ball.x+ball.radius &gt; theCanvas.width || ball.x-ball.radius &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    ball.angle = <span class="number">180</span> - ball.angle;</span><br><span class="line">    updateBall(ball);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(ball.y+ball.radius &gt; theCanvas.height || ball.y-ball.radius &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    ball.angle = <span class="number">360</span> - ball.angle;</span><br><span class="line">    updateBall(ball);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>updateBall(ball)</code> å‡½æ•°è¯¦ç»†å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateBall</span>(<span class="params">ball</span>)</span>&#123;</span><br><span class="line">     ball.radians = ball.angle * <span class="built_in">Math</span>.PI/<span class="number">180</span>;</span><br><span class="line">     ball.xunits = <span class="built_in">Math</span>.cos(ball.radians)*ball.speed;</span><br><span class="line">     ball.yunits = <span class="built_in">Math</span>.sin(ball.radians)*ball.speed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œï¼Œä¸»è¦ä»£ç å·²ç»å…¨éƒ¨ç»™å‡ºï¼Œæœ€ç»ˆå®ç°çš„æ•ˆæœå¦‚å›¾ï¼š</p><p><img src="https://cloud.githubusercontent.com/assets/9649921/13243052/18f53678-da36-11e5-8a84-b9bbf2d04e84.gif" alt="jdfw"></p><p><a href="http://yixunfe.github.io/blog/demo/57/demo1.html" target="_blank" rel="noopener">æŸ¥çœ‹demo</a></p><p><g-emoji alias="yum" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f60b.png" ios-version="6.0">ğŸ˜‹</g-emoji><g-emoji alias="yum" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f60b.png" ios-version="6.0">ğŸ˜‹</g-emoji><g-emoji alias="yum" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f60b.png" ios-version="6.0">ğŸ˜‹</g-emoji>  å¥½äº†ï¼Œä»Šå¤©å°±åˆ°è¿™é‡Œå§~</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#ä¸€-çŸ¢é‡ç§»åŠ¨&quot;&gt;ä¸€ã€çŸ¢é‡ç§»åŠ¨&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#äºŒ-å¤šçƒæ’å¢™åå¼¹&quot;&gt;äºŒã€å¤šçƒæ’å¢™åå¼¹&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#ç¬¬ä¸€ä¸ªé—®é¢˜å¤šçƒæ²¿çŸ¢é‡è¿åŠ¨&quot;&gt;ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šå¤šçƒæ²¿çŸ¢é‡è¿åŠ¨&lt;/
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://zdddrszj.github.io/h-blog/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="canvas" scheme="https://zdddrszj.github.io/h-blog/tags/canvas/"/>
    
      <category term="html5" scheme="https://zdddrszj.github.io/h-blog/tags/html5/"/>
    
  </entry>
  
  <entry>
    <title>ç§»åŠ¨ç«¯ H5 é¡µé¢ä¼˜åŒ–ï¼ˆä¸€ï¼‰</title>
    <link href="https://zdddrszj.github.io/h-blog/2017/08/18/page-optimization/"/>
    <id>https://zdddrszj.github.io/h-blog/2017/08/18/page-optimization/</id>
    <published>2017-08-18T05:40:55.000Z</published>
    <updated>2018-10-07T00:51:27.779Z</updated>
    
    <content type="html"><![CDATA[<p>è¥é”€ä»£æœ‰æ‰‹æ®µå‡ºï¼Œå„é¢†é£éªšæ•°ç™¾å¤©ã€‚è¦è¯´ç°åœ¨å“ªäº›è¥é”€æ–¹å¼æœ€èƒ½ä¼ æ’­ï¼Œå±¡å±¡åˆ·çˆ†æœ‹å‹åœˆçš„ <code>H5</code> é¡µé¢è‚¯å®šå°±æ˜¯é¦–å½“å…¶å†²çš„ã€‚æ‰€è°“ <code>H5</code> é¡µé¢ï¼Œå³ä»£è¡¨çš„æ˜¯ <code>Html5</code> é¡µé¢ï¼Œå¦‚ä»Šå¤§éƒ¨åˆ†æµè§ˆå™¨å·²ç»æ”¯æŒ<code>Html5</code> é¡µé¢ã€‚<code>Html5</code> æœ‰å¼ºåŒ– <code>Web</code> ç½‘é¡µçš„è¡¨ç°æ€§èƒ½å’Œè¿½åŠ æœ¬åœ°æ•°æ®åº“è¿™äº› <code>Web</code> åº”ç”¨åŠŸèƒ½çš„ä¼˜åŠ¿ã€‚</p><p>å¹¿ä¹‰è®ºåŠçš„ <code>Html5</code> å®é™…æŒ‡çš„æ˜¯åŒ…å«<code>HTML</code> ã€<code>CSS</code> å’Œ <code>JavaScript</code> åœ¨å†…çš„ä¸€å¥—æŠ€æœ¯ç»„åˆã€‚ä»Šå¤©ä¸»è¦é˜è¿° <code>H5</code> é¡µé¢ä¼—å¤šä¼˜åŒ–ä¸­çš„å‡ ä¸ªæ³¨æ„ç‚¹ã€‚</p><h3><span id="é¡µé¢æŒ‰éœ€æ¸²æŸ“åˆ—è¡¨ä¸ºä¾‹">é¡µé¢æŒ‰éœ€æ¸²æŸ“ï¼ˆåˆ—è¡¨ä¸ºä¾‹ï¼‰</span></h3><p>åœ¨åŸç”Ÿ <code>APP</code> å¼€å‘ä¸­ï¼Œå¦‚æœä¸€ä¸ªé¡µé¢å¾ˆé•¿ï¼Œ<code>UITableView</code> å’Œ <code>UICollectionView</code> éƒ½æœ‰ä¸€ä¸ªæ§ä»¶æ± ï¼Œåˆ©ç”¨ <code>Cellå¤ç”¨æœºåˆ¶</code> æ¥åšä¼˜åŒ–ï¼Œå¯ä»¥ç†è§£ä¸ºæ ¹æ®å½“å‰ç”¨æˆ·æ‰€åœ¨å±å¹•ä½ç½®è¿›è¡Œæ¸²æŸ“ï¼Œå…¶ä»–ä¸æ¸²æŸ“æˆ–è€…å°‘æ¸²æŸ“ï¼Œä»¥æé«˜é¡µé¢æ€§èƒ½ã€‚ä½†æ˜¯åœ¨ <code>Hybrid Appï¼ˆæ··åˆæ¨¡å¼ç§»åŠ¨åº”ç”¨ï¼‰</code> æ¨¡å¼ä¸­ï¼Œå¯¹<code>WebView</code> ä¸­ <code>H5</code> é¡µé¢æ¥è¯´ï¼Œå¦‚æœä¸€ä¸ªåˆ—è¡¨é¡¹åŠ è½½æœ‰è¶…è¿‡ 200 æ¡ä»¥ä¸Šï¼Œè€Œä¸”æ¯ä¸ªé¡¹ç›®éƒ½æœ‰åŠå±å›¾ç‰‡æ—¶ï¼Œå¯¹äºæ€§èƒ½åŠ£ä¸€ç‚¹çš„æ‰‹æœºæ¥è¯´ï¼Œå½“ç”¨æˆ·æ»šåŠ¨åŠ è½½æ›´å¤šæˆ–è€…ç‚¹å‡»é¡¹ç›®è¿›å…¥ç›¸åº”è¯¦ç»†å†…å®¹æ—¶ï¼Œå¯ä»¥æ˜æ˜¾æ„Ÿè§‰é¡µé¢è¿Ÿé’ï¼Œè¿™ 200 æ¡é¡¹ç›®æ¸²æŸ“èµ·æ¥ç¡®å®æœ‰ç‚¹å‹åŠ›å±±å¤§ï¼Œæ‰€ä»¥è¿™ä¸ªä¼˜åŒ–éœ€è¦ <code>H5</code> è‡ªèº«æ¥åšã€‚</p><p>åœ¨<code>WebView</code> ä¸­<code>Scroll</code> äº‹ä»¶ä¸åŒäºåœ¨æ™®é€šæµè§ˆå™¨ä¸­ï¼Œä¼šåœ¨æ»šåŠ¨äº‹ä»¶ç»“æŸæ—¶æ‰ä¼šè¢«è§¦å‘ï¼Œè¿™é‡Œæˆ‘ä»¬ç»“åˆ <code>setTimeout</code> æ¥æŒ‰éœ€æ¸²æŸ“ï¼Œåªéœ€è¦è®¾ç½® <code>visibility: hidden</code> æ ·å¼å³å¯ã€‚</p><p>å˜é‡è¯´æ˜ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> currentTabIndex = <span class="number">0</span>, <span class="comment">// å½“å‰åˆ—è¡¨ç´¢å¼•ï¼ˆç”¨äºä¸€ä¸ªé¡µé¢å¤šä¸ªåˆ—è¡¨æ—¶ï¼‰</span></span><br><span class="line">    preTabIndex = <span class="number">0</span>, <span class="comment">// å½“å‰å¯è§†åˆ—è¡¨é¡¹ç´¢å¼•</span></span><br><span class="line">    listArrayObject = &#123; <span class="comment">// å½“å‰åˆ—è¡¨å¯¹è±¡é›†åˆ</span></span><br><span class="line">        <span class="string">'0'</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="string">'1'</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="string">'2'</span>: <span class="literal">null</span>,</span><br><span class="line">         ...</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure><p>æ¥å£èµ‹å€¼ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å½“å‰åˆ—è¡¨ç´¢å¼• </span></span><br><span class="line"><span class="keyword">var</span> index = $(<span class="keyword">this</span>).index(); </span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠŠå½“å‰åˆ—è¡¨ç´¢å¼•èµ‹å€¼ç»™ currentTabIndex </span></span><br><span class="line">currentTabIndex = index; </span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å½“å‰åˆ—è¡¨é¡¹</span></span><br><span class="line"><span class="keyword">var</span> lis = $(<span class="string">'.index_list'</span>).eq(index).find(<span class="string">'li'</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¯é¡µ10æ¡ï¼ŒåŠ è½½çš„æœ€åé¡µ</span></span><br><span class="line"><span class="keyword">var</span> collection = lis.slice(lis.length - <span class="number">10</span>, lis.length); </span><br><span class="line"></span><br><span class="line"> <span class="comment">// å¯¹å½“å‰åˆ—è¡¨é›†åˆèµ‹å€¼</span></span><br><span class="line"><span class="keyword">if</span> (listArrayObject[index]) &#123;</span><br><span class="line">   listArrayObject[index].concat(collection)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    listArrayObject[index] = collection</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŒ‰éœ€æ¸²æŸ“ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™é‡Œåˆ©ç”¨ requestAnimationFrame() å‡½æ•°ï¼Œå¯ä»¥æ›´åˆç†çš„é‡æ–°æ’åˆ—åŠ¨ä½œåºåˆ—ï¼Œ</span></span><br><span class="line"><span class="comment">// å¦‚æœæµè§ˆå™¨ä¸æ”¯æŒï¼Œåªå¥½ç”¨ setTimeout() ä»£æ›¿</span></span><br><span class="line"><span class="keyword">var</span> rAF = <span class="built_in">window</span>.requestAnimationFrame  ||</span><br><span class="line">    <span class="built_in">window</span>.webkitRequestAnimationFrame  ||</span><br><span class="line">    <span class="built_in">window</span>.mozRequestAnimationFrame     ||</span><br><span class="line">    <span class="built_in">window</span>.oRequestAnimationFrame       ||</span><br><span class="line">    <span class="built_in">window</span>.msRequestAnimationFrame      ||</span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123; <span class="built_in">window</span>.setTimeout(callback, <span class="number">1000</span> / <span class="number">60</span>); &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ˜¾ç¤ºå½“å‰è§†çª—ä¸­çš„åˆ—è¡¨é¡¹ï¼Œéšè—è¶…å‡ºéƒ¨åˆ†</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showItem</span> (<span class="params">collection, index</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éšè—ä¹‹å‰æ˜¾ç¤ºçš„åˆ—è¡¨é¡¹</span></span><br><span class="line">    collection.slice(preTabIndex,preTabIndex + <span class="number">10</span>).find(<span class="string">'img'</span>).css(<span class="string">'visibility'</span>, <span class="string">'hidden'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å±•ç¤ºå½“å‰åˆ—è¡¨é¡¹ é»˜è®¤æ˜¾ç¤º 10 æ¡</span></span><br><span class="line">    collection.slice(<span class="built_in">Math</span>.max(index - <span class="number">5</span>, <span class="number">0</span>), <span class="built_in">Math</span>.min(index + <span class="number">5</span>, collection.length)).find(<span class="string">'img'</span>).css(<span class="string">'visibility'</span>, <span class="string">'visible'</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// æŠŠå½“å‰åˆ—è¡¨é¡¹ç´¢å¼•å€¼å­˜å‚¨åœ¨å˜é‡ preTabIndex ä¸­ï¼Œè¿™æ ·è¶…å‡ºå±å¹•éšè—æ—¶å°±å¯ä»¥æ ¹æ®ç´¢å¼•æ‰¾åˆ°ä¸Šä¸€æ¬¡æ˜¾ç¤ºçš„é¡¹ç›®</span></span><br><span class="line">   <span class="comment">// è€Œä¸ç”¨éå†æ‰€æœ‰é¡¹ç›®ï¼Œæ—¶é—´å¤æ‚åº¦ä» O(n) é™åˆ° O(10)</span></span><br><span class="line">    preTabIndex = <span class="built_in">Math</span>.max(index - <span class="number">5</span>, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç›‘å¬æ»šåŠ¨äº‹ä»¶</span></span><br><span class="line"><span class="keyword">var</span> isScrollEnd = <span class="string">''</span>;</span><br><span class="line">$(<span class="built_in">window</span>).on(<span class="string">'scroll'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    isScrollEnd = <span class="literal">false</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç›‘å¬å½“å‰è§†å£åˆ—è¡¨é¡¹</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isScrollFun</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!isScrollEnd)&#123;</span><br><span class="line">        <span class="keyword">var</span> winScroTop = $(<span class="built_in">window</span>).scrollTop(),winHei = $(<span class="built_in">window</span>).height();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç›´æ¥ä» listArrayObject é›†åˆä¸­è·å–åˆ—è¡¨é¡¹ç›®ï¼Œè€Œä¸æ˜¯éå† DOM æ ‘ï¼Œæé«˜é€Ÿåº¦</span></span><br><span class="line">        <span class="keyword">var</span> indexListLi = listArrayObject[currentTabIndex];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// éå†åˆ—è¡¨é¡¹ï¼Œæ­¥é•¿ä¸º3ï¼Œå¯æ ¹æ®å±å¹•æœ€å¤šæ‰¿è½½é¡¹ç›®æ•°é€‚å½“è°ƒæ•´</span></span><br><span class="line">        <span class="keyword">if</span>(indexListLi &amp;&amp; indexListLi.length &gt; <span class="number">0</span>)&#123; </span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; indexListLi.length; i += <span class="number">3</span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> li = indexListLi.eq(i),</span><br><span class="line">                    top = li.offset().top;</span><br><span class="line">                <span class="keyword">if</span>(top &gt; winScroTop &amp;&amp; top &lt; winScroTop+winHei)&#123;</span><br><span class="line">                    <span class="comment">// æŠŠå½“å‰åˆ—è¡¨é›†åˆå’Œå±å¹•è§†å£å½“å‰åˆ—è¡¨é¡¹ç´¢å¼•ä¼ å…¥å‡½æ•° showItem() </span></span><br><span class="line">                    showItem(indexListLi, i);</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        isScrollEnd = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    rAF(isScrollFun);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨ä¸»å‡½æ•°</span></span><br><span class="line">isScrollFun();</span><br></pre></td></tr></table></figure><h3><span id="touch-äº‹ä»¶">Touch äº‹ä»¶</span></h3><p>åœ¨ <code>Hybrid App</code> å¼€å‘ä¸­ï¼Œè‹¥ä¸‹æ‹‰åˆ·æ–°æ˜¯åŸç”Ÿçš„ï¼Œé‚£ä¹ˆå½“ç”¨æˆ·ä¸‹æ‹‰åˆ·æ–°æ—¶ï¼š<br>å¯¹äº <code>Android</code> ï¼šä¼šè§¦å‘ <code>touchstart</code> ã€<code>touchcancle</code><br>å¯¹äº <code>IOS</code> ï¼šä¼šè§¦å‘ <code>touchstart</code> ã€<code>touchmove</code> ã€<code>touchend</code></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è¥é”€ä»£æœ‰æ‰‹æ®µå‡ºï¼Œå„é¢†é£éªšæ•°ç™¾å¤©ã€‚è¦è¯´ç°åœ¨å“ªäº›è¥é”€æ–¹å¼æœ€èƒ½ä¼ æ’­ï¼Œå±¡å±¡åˆ·çˆ†æœ‹å‹åœˆçš„ &lt;code&gt;H5&lt;/code&gt; é¡µé¢è‚¯å®šå°±æ˜¯é¦–å½“å…¶å†²çš„ã€‚æ‰€è°“ &lt;code&gt;H5&lt;/code&gt; é¡µé¢ï¼Œå³ä»£è¡¨çš„æ˜¯ &lt;code&gt;Html5&lt;/code&gt; é¡µé¢ï¼Œå¦‚ä»Šå¤§éƒ¨åˆ†æµè§ˆå™¨å·²ç»æ”¯æŒ&lt;code&gt;H
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://zdddrszj.github.io/h-blog/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="html5" scheme="https://zdddrszj.github.io/h-blog/tags/html5/"/>
    
      <category term="performance" scheme="https://zdddrszj.github.io/h-blog/tags/performance/"/>
    
  </entry>
  
  <entry>
    <title>3D æ—‹è½¬å¿ƒ</title>
    <link href="https://zdddrszj.github.io/h-blog/2017/07/06/rotating-ball/"/>
    <id>https://zdddrszj.github.io/h-blog/2017/07/06/rotating-ball/</id>
    <published>2017-07-06T03:05:12.000Z</published>
    <updated>2018-06-23T08:19:44.894Z</updated>
    
    <content type="html"><![CDATA[<p>äº²çˆ±çš„å°ä¼™ä¼´ï¼Œä»Šå¤©åœ¨è¿™é‡Œ <code>ç”¨ css3 å®ç° 3D æ—‹è½¬å¿ƒ</code> ä½œä¸ºå°ç¤¼ç‰©é€ç»™å¤§å®¶ã€‚</p><p>åˆ¶ä½œä¹‹å‰é¦–å…ˆè¦å­¦ä¹ ä¸€ä¸‹ <code>border-radius</code> åŸºç¡€çŸ¥è¯†ï¼Œå› ä¸ºä»Šå¤©çš„è¿™ä¸ªå¿ƒå°±æ˜¯å¥¹çš„æ°ä½œã€‚å¤§å®¶å¯ä»¥å‚è€ƒ <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/border-radius" target="_blank" rel="noopener">CSS | MDN</a> æŠ€æœ¯æ–‡æ¡£ã€‚</p><h3><span id="å®ç°æ–¹æ³•">å®ç°æ–¹æ³•</span></h3><p>å¤§å®¶çœ‹çœ‹ä¸‹é¢è¿™å¼ å›¾ï¼š</p><p><img src="https://cloud.githubusercontent.com/assets/9649921/11970598/cc5bf296-a968-11e5-88c6-969b01eacbdf.png" alt="qq 20151223112051"></p><p>é’è‰²ç›´çº¿ä¸Šéƒ¨åˆ†çš„çº¢è‰²å¼§çº¿æ˜¯ä¸æ˜¯åƒä¸€ä¸ªä¸€åŠçš„ <code>â¤</code> å‘¢ï¼Ÿæ²¡é”™ï¼Œåªè¦å°†å¤–é¢é»„è‰²çŸ©å½¢è®¾ç½®ä¸€å®šçš„åœ†è§’æ¯”ä¾‹ï¼Œå°±ä¼šå˜æˆçº¢è‰²çŸ©å½¢ï¼Œå…¶ä¸­åœ†è§’æ¯”ä¾‹æˆ‘å·²åœ¨å›¾ç‰‡ä¸Šæ ‡æ³¨ï¼ŒåŒæ—¶å°†çŸ©å½¢å·¦è¾¹å’Œä¸‹è¾¹è¾¹æ¡†é•¿åº¦è®¾ä¸º<code>0px</code>ï¼Œåœ¨å°†çŸ©å½¢æ²¿<code>Z è½´</code> æ—‹è½¬ <code>45deg</code> ï¼Œæˆ‘ä»¬å°±ä¼šçœ‹åˆ°ä¸‹é¢è¿™ä¸ªå›¾å½¢ï¼š</p><p><img src="https://cloud.githubusercontent.com/assets/9649921/11970674/3fd95cda-a96a-11e5-87f5-872123ebf998.png" alt="1"></p><p>å¦‚æœæœ‰36ä¸ªè¿™æ ·çš„åŠå¿ƒå½¢ï¼Œæ¯ä¸ªå¿ƒå½¢æ²¿ <code>Yè½´</code> æ—‹è½¬ <code>10deg</code>ï¼Œæ˜¯ä¸æ˜¯å°±ä¼šå˜æˆä¸‹é¢è¿™ä¸ªå›¾å½¢å‘¢ï¼Ÿ</p><p><img src="https://cloud.githubusercontent.com/assets/9649921/11970716/e43be77a-a96a-11e5-976f-32b2c4c3fea6.png" alt="2"></p><p>è¯´åˆ°è¿™é‡Œï¼Œä¼°è®¡å¤§å®¶å·²ç»çŸ¥é“å¤§æ¦‚ä»£ç äº†å§~~~</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>æ—‹è½¬å¿ƒ<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">            body&#123;background-color:black;&#125;</span></span><br><span class="line"><span class="undefined">            .heart_div&#123;</span></span><br><span class="line"><span class="undefined">                width:200px;</span></span><br><span class="line"><span class="undefined">                height:320px;</span></span><br><span class="line"><span class="undefined">                transform-style:preserve-3d;</span></span><br><span class="line"><span class="undefined">                position: relative;</span></span><br><span class="line"><span class="undefined">                left: 0;top:0;bottom: 0;right: 0;</span></span><br><span class="line"><span class="undefined">                margin:200px auto;</span></span><br><span class="line"><span class="undefined">                /*border:1px solid yellow;*/</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">            .heart_div [class^=heart]&#123;</span></span><br><span class="line"><span class="undefined">                width:200px;</span></span><br><span class="line"><span class="undefined">                height:320px;</span></span><br><span class="line"><span class="undefined">                border:solid red;</span></span><br><span class="line"><span class="undefined">                border-width:2px 2px 0 0;</span></span><br><span class="line"><span class="undefined">                border-radius:50% 50% 0%/40% 50% 0%;</span></span><br><span class="line"><span class="undefined">                position: absolute;</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"heart_div"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> heart_div = <span class="built_in">document</span>.getElementsByClassName(<span class="string">"heart_div"</span>)[<span class="number">0</span>];</span></span><br><span class="line"><span class="javascript">            <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">1</span>;i&lt;<span class="number">37</span>;i++)&#123;</span></span><br><span class="line"><span class="javascript">                <span class="comment">/*ç»™heart_divæ·»åŠ 36ä¸ªå­å…ƒç´  ä¸”ç±»åä¸º heart1 heart2 ...*/</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> div = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</span></span><br><span class="line"><span class="javascript">                div.className = <span class="string">"heart"</span>+i;</span></span><br><span class="line"><span class="javascript">                div.style.transform=<span class="string">"rotateY("</span>+i*<span class="number">10</span>+<span class="string">"deg)  rotateZ(45deg) translateX(60px)"</span>;</span></span><br><span class="line"><span class="undefined">                heart_div.appendChild(div);</span></span><br><span class="line"><span class="undefined">            &#125;           </span></span><br><span class="line"><span class="undefined">        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸»è¦éƒ¨åˆ†å®Œæˆäº†ï¼Œä¸‹é¢å°±åŠ ä¸ªæ—‹è½¬åŠ¨ç”»å§! è¯¦ç»†å¦‚ä¸‹ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="selector-tag">style</span>&gt;</span><br><span class="line">    <span class="selector-class">.heart_div</span>&#123;</span><br><span class="line">        <span class="attribute">width</span>:<span class="number">200px</span>;</span><br><span class="line">        <span class="attribute">height</span>:<span class="number">320px</span>;</span><br><span class="line">        <span class="attribute">transform-style</span>:preserve-<span class="number">3</span>d;</span><br><span class="line">        <span class="attribute">position</span>: relative;</span><br><span class="line">        <span class="attribute">left</span>: <span class="number">0</span>;<span class="attribute">top</span>:<span class="number">0</span>;<span class="attribute">bottom</span>: <span class="number">0</span>;<span class="attribute">right</span>: <span class="number">0</span>;</span><br><span class="line">        <span class="attribute">margin</span>:<span class="number">200px</span> auto;</span><br><span class="line">        <span class="attribute">animation</span>:play <span class="number">10s</span> linear infinite;</span><br><span class="line">        <span class="attribute">-webkit-animation</span>:play <span class="number">10s</span> linear infinite;</span><br><span class="line">        <span class="attribute">-moz-animation</span>:play <span class="number">10s</span> linear infinite;</span><br><span class="line">        <span class="attribute">-o-animation</span>:play <span class="number">10s</span> linear infinite;</span><br><span class="line">        <span class="attribute">-ms-animation</span>:play <span class="number">10s</span> linear infinite;</span><br><span class="line">    &#125;</span><br><span class="line">    @<span class="keyword">keyframes</span> play&#123;</span><br><span class="line">        <span class="selector-tag">to</span>&#123;</span><br><span class="line">            <span class="attribute">transform</span>:<span class="built_in">rotateY</span>(360deg) <span class="built_in">rotateX</span>(360deg) <span class="built_in">rotateZ</span>(360deg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    @-<span class="keyword">webkit</span>-<span class="keyword">keyframes</span> play&#123;</span><br><span class="line">        <span class="selector-tag">to</span>&#123;</span><br><span class="line">            <span class="attribute">transform</span>:<span class="built_in">rotateY</span>(360deg) <span class="built_in">rotateX</span>(360deg) <span class="built_in">rotateZ</span>(360deg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    @-<span class="keyword">moz</span>-<span class="keyword">keyframes</span> play&#123;</span><br><span class="line">        <span class="selector-tag">to</span>&#123;</span><br><span class="line">            <span class="attribute">transform</span>:<span class="built_in">rotateY</span>(360deg) <span class="built_in">rotateX</span>(360deg) <span class="built_in">rotateZ</span>(360deg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    @-<span class="keyword">o</span>-<span class="keyword">keyframes</span> play&#123;</span><br><span class="line">        <span class="selector-tag">to</span>&#123;</span><br><span class="line">            <span class="attribute">transform</span>:<span class="built_in">rotateY</span>(360deg) <span class="built_in">rotateX</span>(360deg) <span class="built_in">rotateZ</span>(360deg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    @-<span class="keyword">ms</span>-<span class="keyword">keyframes</span> play&#123;</span><br><span class="line">        <span class="selector-tag">to</span>&#123;</span><br><span class="line">            <span class="attribute">transform</span>:<span class="built_in">rotateY</span>(360deg) <span class="built_in">rotateX</span>(360deg) <span class="built_in">rotateZ</span>(360deg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure><p><img class="emoji" alt=":bowtie:" src="https://assets-cdn.github.com/images/icons/emoji/bowtie.png" height="20" width="20"><img class="emoji" alt=":bowtie:" src="https://assets-cdn.github.com/images/icons/emoji/bowtie.png" height="20" width="20"><img class="emoji" alt=":bowtie:" src="https://assets-cdn.github.com/images/icons/emoji/bowtie.png" height="20" width="20">  å¥½äº†ï¼Œåˆ°è¿™é‡Œå°±å®Œå·¥å•¦ï¼ï¼ï¼</p><p><a href="http://yixunfe.github.io/blog/demo/43/demo.html" target="_blank" rel="noopener">æŸ¥çœ‹demo</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;äº²çˆ±çš„å°ä¼™ä¼´ï¼Œä»Šå¤©åœ¨è¿™é‡Œ &lt;code&gt;ç”¨ css3 å®ç° 3D æ—‹è½¬å¿ƒ&lt;/code&gt; ä½œä¸ºå°ç¤¼ç‰©é€ç»™å¤§å®¶ã€‚&lt;/p&gt;
&lt;p&gt;åˆ¶ä½œä¹‹å‰é¦–å…ˆè¦å­¦ä¹ ä¸€ä¸‹ &lt;code&gt;border-radius&lt;/code&gt; åŸºç¡€çŸ¥è¯†ï¼Œå› ä¸ºä»Šå¤©çš„è¿™ä¸ªå¿ƒå°±æ˜¯å¥¹çš„æ°ä½œã€‚å¤§å®¶å¯ä»¥å‚è€ƒ &lt;a href=&quot;h
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://zdddrszj.github.io/h-blog/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="CSS3" scheme="https://zdddrszj.github.io/h-blog/tags/CSS3/"/>
    
      <category term="animation" scheme="https://zdddrszj.github.io/h-blog/tags/animation/"/>
    
  </entry>
  
  <entry>
    <title>3D æ—‹è½¬ç«‹æ–¹ä½“</title>
    <link href="https://zdddrszj.github.io/h-blog/2017/06/18/rotating-cube/"/>
    <id>https://zdddrszj.github.io/h-blog/2017/06/18/rotating-cube/</id>
    <published>2017-06-18T04:47:41.000Z</published>
    <updated>2018-06-23T08:19:44.895Z</updated>
    
    <content type="html"><![CDATA[<p>ä»Šå¤©æˆ‘ä»¬ä¸€èµ·æ¥å­¦ä¹ ä¸€ä¸‹å¦‚ä½•ç”¨ css3 å˜æ¢å®ç°å°æ—¶å€™ç©çš„å°é­”æ–¹ç«‹æ–¹ä½“ã€‚ä½†æ˜¯è¦æå‰å¤ä¹ ä¸€ä¸‹ 3D å˜æ¢çš„ç›¸å…³çŸ¥è¯†ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹ <a href="http://www.w3cplus.com/content/css3-transform" target="_blank" rel="noopener">w3cplusåšå®¢</a> æˆ–è€…    <a href="http://www.w3school.com.cn/cssref/pr_transform.asp" target="_blank" rel="noopener">w3schoolæ–‡æ¡£</a>ï¼Œç”±äºç›®å‰ webkit å†…æ ¸å¯¹ css3   å±æ€§å…¼å®¹æ€§æ¯”è¾ƒå¥½ï¼Œä¸ºä»£ç ç®€æ´ï¼Œè¿™é‡Œæˆ‘ä»¬åªè€ƒè™‘ chrome æµè§ˆå™¨ï¼Œå…¶ä»–æµè§ˆå™¨è¯»è€…å¯è‡ªè¡ŒåŠ ç›¸åº”å‰ç¼€æ¥å®ç°ã€‚</p><p>å¥½äº†ï¼Œå‡†å¤‡å°±ç»ªä¹‹åé‚£æˆ‘ä»¬å°±å¼€å§‹è¿›å…¥æ­£é¢˜å§ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€é“æ•°å­¦é¢˜ï¼šè¯·æƒ³ä¸€ä¸‹6ä¸ªæ­£æ–¹å½¢å¦‚ä½•æ‘†æ”¾èƒ½æ‹¼æˆä¸€ä¸ªæ­£æ–¹ä½“å‘¢ï¼Ÿå½“ç„¶ï¼Œæ–¹å¼æœ‰å¾ˆå¤šï¼Œè¿™é‡Œåªæå‡ºä¸€ç§ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="https://cloud.githubusercontent.com/assets/9649921/11388537/62bc684a-9372-11e5-8dc2-1a17cab5d109.png" alt="w"></p><p>æ­£æ–¹ä½“ <code>å‰å</code> <code>å·¦å³</code> <code>ä¸Šä¸‹</code> åˆ†åˆ«ç”¨ <code>front</code> <code>back</code> <code>left</code> <code>right</code> <code>top</code> <code>bottom</code> æ¥è¡¨ç¤ºã€‚</p><h3><span id="å®ç°æ–¹æ³•">å®ç°æ–¹æ³•</span></h3><p>æˆ‘ä»¬ç”¨è‡ªå®šä¹‰æ ‡ç­¾æ¥å®ç°ï¼Œhtml ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">cube</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">front</span>&gt;</span><span class="tag">&lt;/<span class="name">front</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">back</span>&gt;</span><span class="tag">&lt;/<span class="name">back</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">left</span>&gt;</span><span class="tag">&lt;/<span class="name">left</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">right</span>&gt;</span><span class="tag">&lt;/<span class="name">right</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">top</span>&gt;</span><span class="tag">&lt;/<span class="name">top</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">bottom</span>&gt;</span><span class="tag">&lt;/<span class="name">bottom</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">cube</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œç»™èƒŒæ™¯ä¸€ä¸ªç´«è‰²åˆ°é»‘è‰²çš„å¾„å‘æ¸å˜ï¼Œæ ·å¼å¦‚ä¸‹ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">html</span>&#123;</span><br><span class="line">    <span class="attribute">background</span>:<span class="built_in">radial-gradient</span>(ellipse at center,#430d6d 0%,#000 100%);</span><br><span class="line">    <span class="attribute">height</span>:<span class="number">100%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¾ç½®æ­£æ–¹ä½“åœ¨æµè§ˆå™¨çª—å£æ­£ä¸­é—´ï¼Œè‹¥æƒ³çœ‹åˆ°å˜æ¢åçš„ 3D æ•ˆæœï¼Œéœ€è¦ç»™ <code>cube</code> å£°æ˜ 3D å˜æ¢ <code>transform-style:preserve-3d;</code> ï¼ŒåŒæ—¶ç»™ <code>body</code> è®¾ç½® <code>è§†å·®</code> ï¼Œæ ·å¼å¦‚ä¸‹ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span>&#123;</span><br><span class="line">    <span class="attribute">padding</span>:<span class="number">0</span>;</span><br><span class="line">    <span class="attribute">margin</span>:<span class="number">0</span>;</span><br><span class="line">    <span class="attribute">height</span>:<span class="number">100%</span>;</span><br><span class="line">    <span class="comment">/*è®¾ç½®è§†å·®*/</span></span><br><span class="line">    <span class="attribute">perspective</span>:<span class="number">1000px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">cube</span>&#123;</span><br><span class="line">    <span class="attribute">width</span>:<span class="number">20em</span>;</span><br><span class="line">    <span class="attribute">height</span>:<span class="number">20em</span>;</span><br><span class="line">    <span class="comment">/*åœ¨çª—å£å±…ä¸­*/</span></span><br><span class="line">    <span class="attribute">position</span>:absolute;<span class="attribute">left</span>:<span class="number">0</span>;<span class="attribute">top</span>:<span class="number">0</span>;<span class="attribute">right</span>:<span class="number">0</span>;<span class="attribute">bottom</span>:<span class="number">0</span>;<span class="attribute">margin</span>:auto;</span><br><span class="line">    <span class="comment">/*å£°æ˜ 3D å˜æ¢*/</span></span><br><span class="line">    <span class="attribute">transform-style</span>:preserve-<span class="number">3</span>d;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼š<code>cube</code> æ˜¯æ­£æ–¹ä½“çš„çˆ¶æ ‡ç­¾ï¼Œ6ä¸ªå­å…ƒç´ æ„æˆæ­£æ–¹ä½“ï¼Œæˆ‘ä»¬ä»¥çˆ¶å…ƒç´ ä¸ºç›¸å¯¹åæ ‡ï¼Œåˆ†åˆ«å¯¹6ä¸ªæ­£æ–¹å½¢ç›¸å¯¹çˆ¶å…ƒç´ è®¾ç½®ç»å¯¹å®šä½ã€‚</p><p>è¿™æ—¶ï¼Œ6ä¸ªæ­£æ–¹å½¢å’Œçˆ¶å…ƒç´ é‡åˆï¼Œæ¥ä¸‹æ¥ï¼Œåˆ†åˆ«å¯¹å…¶å®šä½åˆ°ä¸Šè¾¹å›¾ç‰‡å¯¹åº”ä½ç½®ï¼Œå³ <code>back</code> <code>left</code> <code>right</code> <code>top</code> <code>bottom</code> åˆ†åˆ«ç›¸å¯¹ <code>front</code> è¿›è¡Œä½ç§»å’Œæ—‹è½¬ï¼Œè¿™æ ·å°±å¯ä»¥æ‹¼æˆæ­£æ–¹ä½“å•¦~~~ æ ·å¼å¦‚ä¸‹ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">front</span>&#123;</span><br><span class="line">     <span class="attribute">left</span>:<span class="number">0px</span>;</span><br><span class="line">     <span class="attribute">top</span>:<span class="number">0px</span>;</span><br><span class="line">     <span class="attribute">transform</span>:<span class="built_in">translateZ</span>(10em);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">back</span>&#123;</span><br><span class="line">     <span class="attribute">top</span>:<span class="number">0px</span>;</span><br><span class="line">     <span class="attribute">left</span>:<span class="number">0px</span>;</span><br><span class="line">     <span class="attribute">transform</span>:<span class="built_in">translateZ</span>(-10em);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">left</span>&#123;</span><br><span class="line">     <span class="attribute">left</span>:-<span class="number">20em</span>;</span><br><span class="line">     <span class="attribute">top</span>:<span class="number">0px</span>;</span><br><span class="line">     <span class="attribute">transform</span>: <span class="built_in">translateZ</span>(10em) <span class="built_in">rotateY</span>(-90deg);</span><br><span class="line">     <span class="attribute">transform-origin</span>:right;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">right</span>&#123;</span><br><span class="line">     <span class="attribute">right</span>:-<span class="number">20em</span>;</span><br><span class="line">     <span class="attribute">top</span>:<span class="number">0px</span>;</span><br><span class="line">     <span class="attribute">transform</span>:<span class="built_in">translateZ</span>(10em) <span class="built_in">rotateY</span>(90deg);</span><br><span class="line">     <span class="attribute">transform-origin</span>:left;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">top</span>&#123;</span><br><span class="line">     <span class="attribute">left</span>:<span class="number">0px</span>;</span><br><span class="line">     <span class="attribute">top</span>:-<span class="number">20em</span>;</span><br><span class="line">     <span class="attribute">transform</span>:<span class="built_in">translateZ</span>(10em) <span class="built_in">rotateX</span>(90deg);</span><br><span class="line">     <span class="attribute">transform-origin</span>:bottom;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">bottom</span>&#123;             </span><br><span class="line">     <span class="attribute">left</span>:<span class="number">0px</span>;</span><br><span class="line">     <span class="attribute">bottom</span>:-<span class="number">20em</span>;</span><br><span class="line">     <span class="attribute">transform</span>:<span class="built_in">translateZ</span>(10em) <span class="built_in">rotateX</span>(-90deg);</span><br><span class="line">     <span class="attribute">transform-origin</span>:top;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šçœ‹åˆ°è¿™é‡Œï¼Œå¤§å®¶å¯èƒ½ä¸æ˜ç™½ä¸ºä»€ä¹ˆä¸Šé¢çš„ <code>transform</code> éƒ½è¦åŠ ä¸€ä¸ª <code>transform:translateZ(10em)</code> ï¼Œè¿™æ—¶å› ä¸ºæ¥ä¸‹æ¥æˆ‘ä»¬è¦ç»™ <code>cube</code> åŠ æ—‹è½¬åŠ¨ç”»ï¼Œ<code>cube</code> å°±ä¼šä»¥è‡ªèº«ä¸­å¿ƒä¸ºæ—‹è½¬ç‚¹ï¼ˆå¯¹åº”æ­£æ–¹ä½“ <code>front</code> è¿™ä¸ªé¢ä¸ºæ—‹è½¬ç‚¹ï¼‰ï¼Œå¯¼è‡´ <code>æ­£æ–¹ä½“</code> ä¸èƒ½ä»¥è‡ªèº«ä¸­å¿ƒä¸ºæ—‹è½¬ç‚¹è¿›è¡Œæ—‹è½¬ï¼Œæ•…è€Œæˆ‘ä»¬æŠŠæ„æˆå®ƒçš„è¿™6ä¸ªé¢åˆ†åˆ«æ²¿ <code>Zè½´</code> å‘æ­£æ–¹å‘ä½ç§» <code>10em</code> ï¼Œå°±æ˜¯æ­£æ–¹å½¢è¾¹é•¿ä¸€åŠï¼Œè¿™æ · <code>cube</code> ä¸­å¿ƒç‚¹å’Œ <code>æ­£æ–¹ä½“</code> ä¸­å¿ƒç‚¹ <code>é‡åˆ</code>ã€‚</p><p>åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»å®Œæˆä¸€åŠäº†ï¼Œå¯æ˜¯æˆ‘ä»¬è¿™ä¸ªæ­£æ–¹ä½“å¹¶ä¸æ˜¯å°æ—¶å€™ç©çš„é­”æ–¹é‚£æ ·ï¼Œæ¯ä¸ªé¢è¿˜æœ‰ <code>4x4=16</code> ä¸ªå°æ­£æ–¹å½¢ï¼Œè¿™é‡Œè®¾ç½® <code>8x8=64</code> ä¸ªå°æ­£æ–¹å½¢ï¼ˆ<code>20em/2.5em=8</code>ï¼‰ã€‚css3 å¯ä»¥ä¸ºæˆ‘ä»¬çš„èƒŒæ™¯æ·»åŠ æ¸å˜ï¼Œè‹¥æƒ³å¤ä¹ ä¸€ä¸‹æ¸å˜çŸ¥è¯†ï¼Œä¹Ÿå¯ä»¥çœ‹ä¸€ä¸‹  <a href="http://www.w3cplus.com/content/css3-gradient" target="_blank" rel="noopener">w3cplusåšå®¢</a>ã€‚æ ·å¼å¦‚ä¸‹ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">cube</span>&#123;</span><br><span class="line">    <span class="attribute">background</span>:<span class="built_in">linear-gradient</span>(rgba(0,0,0,0) <span class="number">0px</span>,<span class="built_in">rgba</span>(54,226,248,.5) <span class="number">0px</span>,</span><br><span class="line">                                        <span class="built_in">rgba</span>(54,226,248,.5) <span class="number">3px</span>,<span class="built_in">rgba</span>(0,0,0,0) <span class="number">3px</span>),</span><br><span class="line">               <span class="built_in">linear-gradient</span>(90deg,rgba(0,0,0,0) <span class="number">0px</span>,<span class="built_in">rgba</span>(54,226,248,.5) <span class="number">0px</span>,</span><br><span class="line">                                        <span class="built_in">rgba</span>(54,226,248,.5) <span class="number">3px</span>,<span class="built_in">rgba</span>(0,0,0,0) <span class="number">3px</span>);</span><br><span class="line">    <span class="attribute">background-size</span>:<span class="number">2.5em</span> <span class="number">2.5em</span>,<span class="number">2.5em</span> <span class="number">2.5em</span>;</span><br><span class="line">    <span class="attribute">border</span>:<span class="number">2px</span> solid <span class="built_in">rgba</span>(54,226,248,.5);</span><br><span class="line">    <span class="attribute">box-shadow</span>:<span class="number">0</span> <span class="number">0</span> <span class="number">5em</span> <span class="built_in">rgba</span>(0,128,0,.4);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åä¸€æ­¥ï¼Œä¸ºäº†æ­£æ–¹ä½“çœ‹ä¸Šå»ä¸æ˜¯å‘†æ¿çš„ï¼Œå¯ä»¥å¯¹ <code>cube</code> åŠ ä¸Šä¸€ä¸ªåŠ¨ç”»ï¼Œæ ·å¼å¦‚ä¸‹ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">cube</span>&#123;</span><br><span class="line">    <span class="attribute">animation</span>:cube <span class="number">6s</span> linear infinite;</span><br><span class="line">    <span class="attribute">-webkit-animation</span>:cube <span class="number">6s</span> linear infinite;</span><br><span class="line">&#125;</span><br><span class="line">@<span class="keyword">keyframes</span> cube&#123;</span><br><span class="line">    <span class="selector-tag">from</span>&#123;<span class="attribute">transform</span>:<span class="built_in">translateZ</span>(-10em) <span class="built_in">rotateX</span>(0deg) <span class="built_in">rotateY</span>(0deg);&#125;</span><br><span class="line">    <span class="selector-tag">to</span>&#123;<span class="attribute">transform</span>:<span class="built_in">translateZ</span>(-10em) <span class="built_in">rotateX</span>(360deg) <span class="built_in">rotateY</span>(360deg);&#125;</span><br><span class="line">&#125;</span><br><span class="line">@-<span class="keyword">webkit</span>-<span class="keyword">keyframes</span> cube&#123;</span><br><span class="line">    <span class="selector-tag">from</span>&#123;<span class="attribute">transform</span>:<span class="built_in">translateZ</span>(-10em) <span class="built_in">rotateX</span>(0deg) <span class="built_in">rotateY</span>(0deg);&#125;</span><br><span class="line">    <span class="selector-tag">to</span>&#123;<span class="attribute">transform</span>:<span class="built_in">translateZ</span>(-10em) <span class="built_in">rotateX</span>(360deg) <span class="built_in">rotateY</span>(360deg);&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸çŸ¥é“å¤§å®¶å¯¹ä¸Šè¾¹åŠ¨ç”» <code>transform:translateZ(-10em)</code> æ˜¯å¦ç†è§£ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨åŠªåŠ›ä¸º <code>cube</code> å’Œ <code>æ­£æ–¹ä½“</code> ä¸­å¿ƒç‚¹é‡åˆæ—¶è®¾ç½®äº† <code>transform:translateZ(10em)</code>  ã€‚</p><p>è‹¥æƒ³åœ¨æ­£æ–¹ä½“ä¸­æ·»åŠ æ–‡å­—ï¼Œè®¾ç½®å­—ä½“å¤§å°è¦æ³¨æ„ä¸€ä¸‹ï¼Œchrome æµè§ˆå™¨é»˜è®¤å­—ä½“å¤§å°<code>16px</code> ï¼Œæ­£æ–¹å½¢å®½åº¦ <code>16px*20em=320px</code> ï¼Œæ•… <code>line-height:320px</code> ï¼›åŒæ—¶ç»™å­—ä½“è®¾ç½®å¤šé‡é˜´å½± <code>text-shadow</code>ï¼Œå¯ä»¥è¾¾åˆ°ç«‹ä½“æ•ˆæœï¼Œè¯¦ç»†å¦‚ä¸‹ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>æ”¾é£æ¢¦æƒ³<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">div</span>&#123;</span><br><span class="line">    <span class="attribute">color</span>:<span class="number">#fff</span>;</span><br><span class="line">    <span class="attribute">font-size</span>:<span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">font-weight</span>:bold;</span><br><span class="line">    <span class="attribute">text-align</span>:center;</span><br><span class="line">    <span class="attribute">line-height</span>:<span class="number">320px</span>;</span><br><span class="line">    <span class="attribute">text-shadow</span>:<span class="number">0</span> <span class="number">1px</span> <span class="number">0</span> <span class="number">#ccc</span>,<span class="number">0</span> <span class="number">2px</span> <span class="number">0</span> <span class="number">#bbb</span>,<span class="number">0</span> <span class="number">3px</span> <span class="number">0</span> <span class="number">#c9c9c9</span>,<span class="number">0</span> <span class="number">4px</span> <span class="number">0</span> <span class="number">#bbb</span>,<span class="number">0</span> <span class="number">4px</span> <span class="number">0</span> <span class="number">#b9b9b9</span>,<span class="number">0</span> <span class="number">5px</span> <span class="number">0</span> <span class="number">#aaa</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><g-emoji alias="smile" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f604.png" ios-version="6.0">ğŸ˜„</g-emoji><g-emoji alias="smile" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f604.png" ios-version="6.0">ğŸ˜„</g-emoji><g-emoji alias="smile" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f604.png" ios-version="6.0">ğŸ˜„</g-emoji>  å¥½äº†ï¼Œåˆ°è¿™é‡Œå°±å®Œå·¥å•¦ï¼ï¼ï¼</p><p><a href="http://yixunfe.github.io/blog/demo/36/demo.html" target="_blank" rel="noopener">æŸ¥çœ‹demo</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä»Šå¤©æˆ‘ä»¬ä¸€èµ·æ¥å­¦ä¹ ä¸€ä¸‹å¦‚ä½•ç”¨ css3 å˜æ¢å®ç°å°æ—¶å€™ç©çš„å°é­”æ–¹ç«‹æ–¹ä½“ã€‚ä½†æ˜¯è¦æå‰å¤ä¹ ä¸€ä¸‹ 3D å˜æ¢çš„ç›¸å…³çŸ¥è¯†ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹ &lt;a href=&quot;http://www.w3cplus.com/content/css3-transform&quot; target=&quot;_blank&quot; r
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://zdddrszj.github.io/h-blog/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="CSS3" scheme="https://zdddrszj.github.io/h-blog/tags/CSS3/"/>
    
      <category term="animation" scheme="https://zdddrszj.github.io/h-blog/tags/animation/"/>
    
  </entry>
  
  <entry>
    <title>DOM ä¸­çš„èŒƒå›´</title>
    <link href="https://zdddrszj.github.io/h-blog/2017/05/24/range/"/>
    <id>https://zdddrszj.github.io/h-blog/2017/05/24/range/</id>
    <published>2017-05-24T04:18:10.000Z</published>
    <updated>2018-06-23T08:19:44.894Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><ul><li><a href="#dom-ä¸­çš„èŒƒå›´">DOM ä¸­çš„èŒƒå›´</a><ul><li><a href="#1-ç”¨-dom-èŒƒå›´å®ç°ç®€å•é€‰æ‹©">1ã€ç”¨ DOM èŒƒå›´å®ç°ç®€å•é€‰æ‹©</a></li><li><a href="#2-ç”¨-dom-èŒƒå›´å®ç°å¤æ‚é€‰æ‹©">2ã€ç”¨ DOM èŒƒå›´å®ç°å¤æ‚é€‰æ‹©</a></li><li><a href="#3-æ“ä½œ-dom-èŒƒå›´ä¸­çš„å†…å®¹">3ã€æ“ä½œ DOM èŒƒå›´ä¸­çš„å†…å®¹</a></li><li><a href="#4-æ’å…¥-dom-èŒƒå›´ä¸­çš„å†…å®¹">4ã€æ’å…¥ DOM èŒƒå›´ä¸­çš„å†…å®¹</a></li><li><a href="#5-æŠ˜å -dom-èŒƒå›´">5ã€æŠ˜å  DOM èŒƒå›´</a></li><li><a href="#6-æ¯”è¾ƒ-dom-èŒƒå›´">6ã€æ¯”è¾ƒ DOM èŒƒå›´</a></li><li><a href="#7-å¤åˆ¶-dom-èŒƒå›´">7ã€å¤åˆ¶ DOM èŒƒå›´</a></li><li><a href="#8-æ¸…ç†-dom-èŒƒå›´">8ã€æ¸…ç† DOM èŒƒå›´</a></li></ul></li><li><a href="#ie8åŠæ›´æ—©ç‰ˆæœ¬ä¸­çš„èŒƒå›´">IE8åŠæ›´æ—©ç‰ˆæœ¬ä¸­çš„èŒƒå›´</a><ul><li><a href="#1-ç”¨-ie-èŒƒå›´å®ç°ç®€å•çš„é€‰æ‹©">1ã€ç”¨ IE èŒƒå›´å®ç°ç®€å•çš„é€‰æ‹©</a></li><li><a href="#2-ä½¿ç”¨-ie-èŒƒå›´å®ç°å¤æ‚çš„é€‰æ‹©">2ã€ä½¿ç”¨ IE èŒƒå›´å®ç°å¤æ‚çš„é€‰æ‹©</a></li><li><a href="#3-æ“ä½œ-ie-èŒƒå›´ä¸­çš„å†…å®¹">3ã€æ“ä½œ IE èŒƒå›´ä¸­çš„å†…å®¹</a></li><li><a href="#4-æŠ˜å -ie-èŒƒå›´">4ã€æŠ˜å  IE èŒƒå›´</a></li><li><a href="#5-æ¯”è¾ƒ-ie-èŒƒå›´">5ã€æ¯”è¾ƒ IE èŒƒå›´</a></li><li><a href="#6-å¤åˆ¶-ie-èŒƒå›´">6ã€å¤åˆ¶ IE èŒƒå›´</a></li></ul></li></ul><!-- tocstop --><p>ä¸ºäº†è®©å¼€å‘äººå‘˜æ›´æ–¹ä¾¿æ§åˆ¶é¡µé¢ï¼Œ<code>DOM2</code> çº§éå†å’ŒèŒƒå›´æ¨¡å—å®šä¹‰äº† <strong>èŒƒå›´ ï¼ˆrangeï¼‰</strong> æ¥å£ã€‚é€šè¿‡èŒƒå›´å¯ä»¥é€‰æ‹©æ–‡æ¡£ä¸­çš„ä¸€ä¸ªåŒºåŸŸï¼Œè€Œä¸å¿…è€ƒè™‘èŠ‚ç‚¹çš„ç•Œé™ï¼ˆé€‰æ‹©åœ¨åå°å®Œæˆï¼Œå¯¹ç”¨æˆ·æ˜¯ä¸å¯è§çš„ï¼‰ã€‚ <code>Firefox</code>ã€<code>Opera</code>ã€<code>Safari</code> å’Œ <code>Chrome</code> éƒ½æ”¯æŒ <code>DOM</code> èŒƒå›´ã€‚IE ä»¥ä¸“æœ‰æ–¹å¼å®ç°äº†è‡ªå·±çš„èŒƒå›´ç‰¹æ€§ã€‚</p><h1><span id="dom-ä¸­çš„èŒƒå›´">DOM ä¸­çš„èŒƒå›´</span></h1><p><code>DOM2</code> çº§åœ¨ <code>Document</code> ç±»å‹ä¸­å®šä¹‰äº† <code>createRange()</code> æ–¹æ³•ã€‚åœ¨å…¼å®¹ <code>DOM</code> çš„æµè§ˆå™¨ä¸­ï¼Œä½¿ç”¨è¿™ä¸ªæ–¹æ³•å±äº <code>document</code> å¯¹è±¡ã€‚ä½¿ç”¨ <code>hasFeature()</code> æˆ–è€…ç›´æ¥æ£€æµ‹è¯¥æ–¹æ³•ï¼Œéƒ½å¯ä»¥ç¡®å®šæµè§ˆå™¨æ˜¯å¦æ”¯æŒèŒƒå›´ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> supportsRange = <span class="built_in">document</span>.implementation.hasFeature(<span class="string">"Range"</span>,<span class="string">"2.0"</span>);</span><br><span class="line"><span class="keyword">var</span> alsoSupportsRange = (<span class="keyword">typeof</span> <span class="built_in">document</span>.createRange == <span class="string">"function"</span>);</span><br></pre></td></tr></table></figure><p>å¦‚æœæµè§ˆå™¨æ”¯æŒèŒƒå›´ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨ <code>createRange()</code> æ¥åˆ›å»º <code>DOM</code> èŒƒå›´ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> range = <span class="built_in">document</span>.createRange();</span><br></pre></td></tr></table></figure><p>ä¸èŠ‚ç‚¹ç±»ä¼¼ï¼Œæ–°åˆ›å»ºçš„èŒƒå›´ä¸åˆ›å»ºå®ƒçš„æ–‡æ¡£å…³è”åœ¨ä¸€èµ·ï¼Œä¸èƒ½ç”¨äºå…¶ä»–æ–‡æ¡£ã€‚<br>æ¯ä¸ªèŒƒå›´ç”±ä¸€ä¸ª<code>Range</code> ç±»å‹çš„å®ä¾‹è¡¨ç¤ºï¼Œè¿™ä¸ªå®ä¾‹æ‹¥æœ‰å¾ˆå¤šå±æ€§å’Œæ–¹æ³•ã€‚ä¸‹åˆ—å±æ€§æä¾›äº†å½“å‰èŒƒå›´åœ¨æ–‡æ¡£ä¸­çš„ä½ç½®ä¿¡æ¯ï¼š</p><p>1ã€<code>startContainer</code>ï¼šåŒ…å«èŒƒå›´èµ·ç‚¹çš„èŠ‚ç‚¹ï¼ˆå³é€‰åŒºä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ï¼‰ã€‚<br>2ã€<code>startOffset</code>ï¼šèŒƒå›´åœ¨ startContainer ä¸­èµ·ç‚¹çš„åç§»é‡ã€‚<br>3ã€<code>endContainer</code>ï¼šåŒ…å«èŒƒå›´ç»ˆç‚¹çš„èŠ‚ç‚¹ï¼ˆå³é€‰åŒºä¸­æœ€åä¸€ä¸ªèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ï¼‰ã€‚<br>4ã€<code>endOffset</code>ï¼šèŒƒå›´åœ¨ endContainer ä¸­ç»ˆç‚¹çš„åç§»é‡ã€‚<br>5ã€<code>commonAncestorContainer</code>ï¼šstartContainer å’Œ endContainer å…±åŒçš„ç¥–å…ˆèŠ‚ç‚¹ã€‚</p><p>ä¸‹é¢ç®€å•ä»‹ç»ä¸€ä¸‹èŒƒå›´çš„ä½¿ç”¨æ–¹æ³•ï¼š</p><h3><span id="1-ç”¨-dom-èŒƒå›´å®ç°ç®€å•é€‰æ‹©">1ã€ç”¨ DOM èŒƒå›´å®ç°ç®€å•é€‰æ‹©</span></h3><p>è¦ä½¿ç”¨èŒƒå›´æ¥é€‰æ‹©æ–‡æ¡£ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œæœ€ç®€å•çš„æ–¹å¼æ˜¯ä½¿ç”¨ <code>selectNode()</code> æˆ– <code>selectNodeContents()</code>ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"p1"</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">b</span>&gt;</span> world!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> range1 = <span class="built_in">document</span>.createRange(),</span></span><br><span class="line"><span class="javascript">                range2 = <span class="built_in">document</span>.createRange(),</span></span><br><span class="line"><span class="javascript">                p1 = <span class="built_in">document</span>.getElementById(<span class="string">"p1"</span>);</span></span><br><span class="line"><span class="undefined">            range1.selectNode(p1);</span></span><br><span class="line"><span class="undefined">            range2.selectNodeContents(p1);      </span></span><br><span class="line"><span class="undefined">        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ªèŒƒå›´åŒ…å«æ–‡æ¡£ä¸­ä¸åŒéƒ¨åˆ†ï¼Œå¦‚å›¾ï¼š<br><img src="https://cloud.githubusercontent.com/assets/9649921/11467545/c48f7f2a-9783-11e5-8f56-0b63c1ade9b1.png" alt="1"><br>åœ¨è°ƒç”¨ <code>selectNode()</code> æ—¶ï¼Œ<code>startContainer</code>ã€<code>endContainer</code> éƒ½ç­‰äºä¼ å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ <code>document.body</code>ã€‚è€Œ <code>startOffset</code> å±æ€§ç­‰äºç»™å®šèŠ‚ç‚¹åœ¨å…¶çˆ¶èŠ‚ç‚¹çš„ <code>childNodes</code> é›†åˆä¸­çš„ç´¢å¼•ï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯ <code>1</code> ï¼Œå› ä¸ºå…¼å®¹ <code>DOM</code> çš„æµè§ˆå™¨å°†ç©ºæ ¼ç®—ä½œä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹ï¼‰ï¼Œ<code>endOffset</code> ç­‰äº <code>startOffset</code> åŠ  <code>1</code> ï¼ˆå› ä¸ºåªé€‰æ‹©äº†ä¸€ä¸ªèŠ‚ç‚¹ï¼‰ã€‚<br>åœ¨è°ƒç”¨ <code>selectNodeContents()</code> æ—¶ï¼Œ<code>startContainer</code>ã€<code>endContainer</code> ç­‰äºä¼ å…¥çš„èŠ‚ç‚¹ï¼Œå³è¿™ä¸ªä¾‹å­ä¸­çš„ <code>&lt;p&gt;</code> å…ƒç´ ã€‚è€Œ <code>startOffset</code> å±æ€§å§‹ç»ˆç­‰äº <code>0</code> ï¼Œå› ä¸ºèŒƒå›´ä»ç»™å®šèŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹å¼€å§‹ã€‚æœ€åï¼Œ<code>endOffset</code> ç­‰äºå­èŠ‚ç‚¹çš„æ•°é‡ï¼ˆnode.childNodes.lengthï¼‰ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯ <code>2</code> ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(range1.startContainer); <span class="comment">//&lt;body&gt;...&lt;/body&gt;</span></span><br><span class="line"><span class="built_in">console</span>.log(range2.startContainer); <span class="comment">//&lt;p id="p1"&gt;...&lt;/p&gt;</span></span><br><span class="line"><span class="built_in">console</span>.log(range1.endContainer); <span class="comment">//&lt;body&gt;...&lt;/body&gt;</span></span><br><span class="line"><span class="built_in">console</span>.log(range2.endContainer); <span class="comment">//&lt;p id="p1"&gt;...&lt;/p&gt;</span></span><br><span class="line"><span class="built_in">console</span>.log(range1.startOffset); <span class="comment">//1</span></span><br><span class="line"><span class="built_in">console</span>.log(range2.startOffset); <span class="comment">//0</span></span><br><span class="line"><span class="built_in">console</span>.log(range1.endOffset); <span class="comment">//2</span></span><br><span class="line"><span class="built_in">console</span>.log(range2.endOffset); <span class="comment">//2</span></span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œä¸ºäº†æ›´ç²¾ç»†åœ°æ§åˆ¶å“ªäº›èŠ‚ç‚¹åŒ…å«åœ¨èŒƒå›´å†…ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ä¸‹åˆ—æ–¹æ³•ï¼š</p><p>1ã€<code>setStartBefore(refNode)</code>ï¼šå°†èŒƒå›´çš„èµ·ç‚¹è®¾ç½®åœ¨ refNode ä¹‹å‰ã€‚<br>2ã€<code>setStartAfter(refNode)</code>ï¼šå°†èŒƒå›´çš„èµ·ç‚¹è®¾ç½®åœ¨refNode ä¹‹åã€‚<br>3ã€<code>setEndBefore(refNode)</code>ï¼šå°†èŒƒå›´çš„ç»ˆç‚¹è®¾ç½®åœ¨ refNode ä¹‹å‰ã€‚<br>4ã€<code>setEndAfter(refNode)</code>ï¼šå°†èŒƒå›´çš„ç»ˆç‚¹è®¾ç½®åœ¨ refNode ä¹‹åã€‚</p><h3><span id="2-ç”¨-dom-èŒƒå›´å®ç°å¤æ‚é€‰æ‹©">2ã€ç”¨ DOM èŒƒå›´å®ç°å¤æ‚é€‰æ‹©</span></h3><p>è¦åˆ›å»ºå¤æ‚çš„èŒƒå›´å°±å¾—ä½¿ç”¨ <code>setStart()</code> å’Œ <code>setEnd()</code> æ–¹æ³•ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šä¸€ä¸ªå‚ç…§èŠ‚ç‚¹å’Œä¸€ä¸ªåç§»é‡å€¼ã€‚å¯¹ <code>setStart()</code> æ¥è¯´ï¼Œå‚ç…§èŠ‚ç‚¹ä¼šå˜æˆ <code>startContainer</code>ï¼Œè€Œåç§»é‡å€¼ä¼šå˜   <code>startOffset</code> ã€‚å¯¹äº <code>setEnd()</code> æ¥è¯´ï¼Œå‚ç…§èŠ‚ç‚¹ä¼šå˜æˆ <code>endContainer</code> ï¼Œè€Œåç§»é‡å€¼ä¼šå˜æˆ <code>endOffset</code>ã€‚<br>å¯ä»¥ä½¿ç”¨è¿™ä¸¤ä¸ªæ–¹æ³•æ¥æ¨¡æ‹Ÿ <code>selectNode()</code> å’Œ <code>selectNodeContents()</code> ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> range1 = <span class="built_in">document</span>.createRange(),</span><br><span class="line">    range2 = <span class="built_in">document</span>.createRange(),</span><br><span class="line">    p1 = <span class="built_in">document</span>.getElementById(<span class="string">"p1"</span>),</span><br><span class="line">    p1Index = <span class="number">-1</span>,i,len;</span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>, len = p1.parentNode.childNodes.length; i &lt; len; i++)&#123;</span><br><span class="line">    <span class="keyword">if</span>(p1.parentNode.childNodes[i] == p1)&#123;</span><br><span class="line">        p1Index = i;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">range1.setStart(p1.parentNode,p1Index);</span><br><span class="line">range1.setEnd(p1.parentNode,p1Index+<span class="number">1</span>);</span><br><span class="line">range2.setStart(p1,<span class="number">0</span>);</span><br><span class="line">range2.setEnd(p1,p1.childNodes.length);</span><br></pre></td></tr></table></figure><p>å‡è®¾ä½ åªæƒ³é€‰æ‹©å‰é¢ <code>HTML</code> ç¤ºä¾‹ä»£ç ä¸­ä» <code>hello</code> çš„ <code>llo</code> åˆ° <code>world!</code> çš„ <code>o</code> ï¼Œå¯ä»¥è¿™æ ·åšï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p1 = <span class="built_in">document</span>.getElementById(<span class="string">"p1"</span>),</span><br><span class="line">    helloNode = p1.firstChild.firstChild,</span><br><span class="line">    worldNode = p1.lastChild;</span><br><span class="line"><span class="keyword">var</span> range = <span class="built_in">document</span>.createRange();</span><br><span class="line">range.setStart(helloNode,<span class="number">2</span>);</span><br><span class="line">range.setEnd(worldNode,<span class="number">3</span>);</span><br></pre></td></tr></table></figure><p>ç”±äº <code>helloNode</code> å’Œ <code>worldNode</code> éƒ½æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œå› æ­¤å®ƒä»¬åˆ†åˆ«å˜æˆäº†æ–°å»ºèŒƒå›´çš„ <code>startContainer</code> å’Œ <code>endContainer</code> ã€‚æ­¤æ—¶ <code>startOffset</code> å’Œ <code>endOffset</code> åˆ†åˆ«ç”¨ä»¥ç¡®å®šä¸¤ä¸ªèŠ‚ç‚¹æ‰€åŒ…å«çš„æ–‡æœ¬ä¸­çš„ä½ç½®ï¼Œè€Œä¸æ˜¯ç”¨ä»¥ç¡®å®šå­èŠ‚ç‚¹çš„ä½ç½®ã€‚å¦‚å›¾ï¼š<br><img src="https://cloud.githubusercontent.com/assets/9649921/11468680/5ef0bfd6-978c-11e5-9c91-31f038224c73.png" alt="2"></p><h3><span id="3-æ“ä½œ-dom-èŒƒå›´ä¸­çš„å†…å®¹">3ã€æ“ä½œ DOM èŒƒå›´ä¸­çš„å†…å®¹</span></h3><p>å¯¹å‰é¢çš„ä¾‹å­è€Œè¨€ï¼ŒèŒƒå›´ç»è¿‡è®¡ç®—çŸ¥é“é€‰å–ä¸­ç¼ºå°‘ä¸€ä¸ªå¼€å§‹çš„ <code>&lt;b&gt;</code> æ ‡ç­¾ï¼Œå› æ­¤å°±ä¼šåœ¨åå°åŠ¨æ€æ·»åŠ ä¸€ä¸ªè¯¥æ ‡ç­¾ï¼ŒåŒæ—¶è¿˜ä¼šåœ¨å‰é¢åŠ å…¥ä¸€ä¸ªè¡¨ç¤ºç»“æŸçš„ <code>&lt;b&gt;</code> æ ‡ç­¾ã€‚äºæ˜¯ä¿®æ”¹åçš„ <code>DOM</code> å°±å˜æˆå¦‚ä¸‹æ‰€ç¤ºï¼š<br><code>&lt;p&gt;&lt;b&gt;He&lt;/b&gt;&lt;b&gt;llo&lt;/b&gt; world!&lt;/p&gt;</code>ã€‚</p><p>åƒè¿™æ ·åˆ›å»ºäº†èŒƒå›´ä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨å„ç§æ–¹æ³•å¯¹èŒƒå›´çš„å†…å®¹è¿›è¡Œæ“ä½œäº†ã€‚<br>ç¬¬ä¸€ä¸ªæ–¹æ³•ï¼š<code>deleteContents()</code>ï¼Œä»æ–‡æ¡£ä¸­åˆ é™¤èŒƒå›´æ‰€åŒ…å«çš„å†…å®¹ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">range.deleteContents();</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œè¿™å¥ä»£ç ä¹‹åï¼Œé¡µé¢ä¼šæ˜¾ç¤ºå¦‚ä¸‹ <code>HTML</code> ä»£ç ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"p1"</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span>He<span class="tag">&lt;/<span class="name">b</span>&gt;</span>rld!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç¬¬äºŒä¸ªæ–¹æ³•ï¼š<code>extractContents()</code> ï¼Œä¹Ÿä¼šä»æ–‡æ¡£ä¸­ç§»é™¤èŒƒå›´é€‰åŒºï¼Œä½†ä¼šè¿”å›æ–‡æ¡£ç‰‡æ®µã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fragment = range.extractContents();</span><br><span class="line">p1.parentNode.appendChild(fragment);</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œè¿™å¥ä»£ç ä¹‹åï¼Œé¡µé¢ä¼šæ˜¾ç¤ºå¦‚ä¸‹ <code>HTML</code> ä»£ç ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"p1"</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span>He<span class="tag">&lt;/<span class="name">b</span>&gt;</span>rld!<span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span>llo<span class="tag">&lt;/<span class="name">b</span>&gt;</span> wo</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸‰ä¸ªæ–¹æ³•ï¼š<code>cloneContents()</code> ï¼Œä¼šåˆ›å»ºèŒƒå›´å¯¹è±¡çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œç„¶åæ’å…¥åˆ°å…¶ä»–åœ°æ–¹ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fragment = range.cloneContents();</span><br><span class="line">p1.parentNode.appendChild(fragment);</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œè¿™å¥ä»£ç ä¹‹åï¼Œé¡µé¢ä¼šæ˜¾ç¤ºå¦‚ä¸‹ <code>HTML</code> ä»£ç ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"p1"</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">b</span>&gt;</span> world!<span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span>llo<span class="tag">&lt;/<span class="name">b</span>&gt;</span> wo</span><br></pre></td></tr></table></figure><h3><span id="4-æ’å…¥-dom-èŒƒå›´ä¸­çš„å†…å®¹">4ã€æ’å…¥ DOM èŒƒå›´ä¸­çš„å†…å®¹</span></h3><p>åˆ©ç”¨èŒƒå›´ï¼Œå¯ä»¥åˆ é™¤æˆ–å¤åˆ¶å†…å®¹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ <code>insertNode()</code> æ–¹æ³•åƒèŒƒå›´é€‰åŒºçš„å¼€å§‹å¤„æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹ã€‚å‡è®¾æˆ‘ä»¬åœ¨å‰é¢ä¾‹å­ä¸­çš„ <code>HTML</code> å‰é¢æ’å…¥ä»¥ä¸‹ <code>HTML</code> ä»£ç ï¼š<code>&lt;span style=&quot;color:red;&quot;&gt;Inserted text&lt;/span&gt;</code>  ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> span = <span class="built_in">document</span>.createElement(<span class="string">"span"</span>);</span><br><span class="line">span.style.color = <span class="string">"red"</span>;</span><br><span class="line">span.appendChild(<span class="built_in">document</span>.createTextNode(<span class="string">"Inserted text"</span>));</span><br><span class="line">range.insertNode(span);</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œè¿™å¥ä»£ç ä¹‹åï¼Œé¡µé¢ä¼šæ˜¾ç¤ºå¦‚ä¸‹ <code>HTML</code> ä»£ç ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"p1"</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span>He<span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"color: red;"</span>&gt;</span>Inserted text<span class="tag">&lt;/<span class="name">span</span>&gt;</span>llo<span class="tag">&lt;/<span class="name">b</span>&gt;</span> world!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼š<code>&lt;span&gt;</code> æ­£å¥½è¢«æ’å…¥åˆ°äº† <code>hello</code> ä¸­çš„ <code>llo</code> å‰é¢ï¼Œè€Œè¯¥ä½ç½®å°±æ˜¯èŒƒå›´é€‰åŒºçš„å¼€å§‹ä½ç½®ã€‚è¿˜è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰æ·»åŠ æˆ–åˆ é™¤ <code>&lt;b&gt;</code> å…ƒç´ ï¼Œä½¿ç”¨è¿™ç§æŠ€æœ¯å¯ä»¥æ’å…¥ä¸€äº›å¸®åŠ©æç¤ºä¿¡æ¯ï¼Œä¾‹å¦‚åœ¨æ‰“å¼€æ–°çª—å£çš„é“¾æ¥æ—æ’å…¥ä¸€å¹…å›¾åƒã€‚</p><p>é™¤äº†åƒèŒƒå›´å†…éƒ¨æ’å…¥å†…å®¹ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å›´ç»•èŒƒå›´æ’å…¥å†…å®¹ï¼Œæ­¤æ—¶å°±è¦ä½¿ç”¨ <code>surroundContents()</code> æ–¹æ³•ã€‚è¯¥æ–¹æ³•æ¥å—ä¸€ä¸ªå‚æ•°ï¼Œå³ç¯ç»•èŒƒå›´å†…å®¹çš„èŠ‚ç‚¹ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">range.selectNode(helloNode);</span><br><span class="line"><span class="keyword">var</span> span = <span class="built_in">document</span>.createElement(<span class="string">"span"</span>);</span><br><span class="line">span.style.backgroundColor = <span class="string">"yellow"</span>;  </span><br><span class="line">range.surroundContents(span);</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œè¿™å¥ä»£ç ä¹‹åï¼Œä¼šç»™èŒƒå›´é€‰åŒºåŠ ä¸Šä¸€ä¸ªé»„è‰²èƒŒæ™¯ã€‚å¾—åˆ°çš„ <code>HTML</code> ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"p1"</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"background-color: yellow;"</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span> world!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šä¸ºäº†æ’å…¥ <code>&lt;span&gt;</code> ï¼ŒèŒƒå›´å¿…é¡»åŒ…å«æ•´ä¸ª <code>DOM</code> é€‰åŒºï¼ˆä¸èƒ½ä»…ä»…åŒ…å«é€‰ä¸­çš„ <code>DOM</code> èŠ‚ç‚¹ï¼‰ã€‚</p><h3><span id="5-æŠ˜å -dom-èŒƒå›´">5ã€æŠ˜å  DOM èŒƒå›´</span></h3><p>æ‰€è°“ <strong>æŠ˜å èŒƒå›´</strong> ï¼Œå°±æ˜¯æŒ‡èŒƒå›´ä¸­æœªé€‰æ‹©æ–‡æ¡£çš„ä»»ä½•éƒ¨åˆ†ã€‚ä½¿ç”¨ <code>collapse()</code> æ–¹æ³•æ¥æŠ˜å èŒƒå›´ï¼Œè¯¥æ–¹æ³•æ¥å—ä¸€ä¸ªå‚æ•°ï¼Œä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºè¦æŠ˜å åˆ°èŒƒå›´çš„å“ªä¸€ç«¯ã€‚å‚æ•° <code>true</code> è¡¨ç¤ºè¦æŠ˜å åˆ°èŒƒå›´çš„èµ·ç‚¹ï¼Œå‚æ•° <code>false</code> è¡¨ç¤ºè¦æŠ˜å åˆ°èŒƒå›´çš„ç»ˆç‚¹ã€‚è¦ç¡®å®šèŒƒå›´å·²ç»æŠ˜å å®Œæ¯•ï¼Œå¯ä»¥æ£€æŸ¥ <code>collapsed</code> å±æ€§ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">range.collapse(<span class="literal">true</span>); <span class="comment">//æŠ˜å åˆ°èµ·ç‚¹</span></span><br><span class="line">alert(range.collapsed); <span class="comment">//è¾“å‡º true</span></span><br></pre></td></tr></table></figure><p>æ£€æµ‹æŸä¸ªèŒƒå›´æ˜¯å¦å¤„äºæŠ˜å çŠ¶æ€ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬ç¡®å®šèŒƒå›´ä¸­çš„ä¸¤ä¸ªèŠ‚ç‚¹æ˜¯å¦ç´§å¯†ç›¸é‚»ã€‚ä¾‹å¦‚ï¼Œå¯¹äºä¸‹é¢çš„ <code>HTML</code> ä»£ç ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"p1"</span>&gt;</span>Paragraph 1<span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"p2"</span>&gt;</span>Paragraph 2<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å‡è®¾ä¸çŸ¥å…¶å®é™…æ„æˆï¼ˆæ¯”å¦‚åŠ¨æ€ç”Ÿæˆçš„ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥åƒä¸‹é¢è¿™æ ·åˆ›å»ºä¸€ä¸ªèŒƒå›´ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p1 = <span class="built_in">document</span>.getElementById(<span class="string">'p1'</span>),</span><br><span class="line">    p2 = <span class="built_in">document</span>.getElementById(<span class="string">'p2'</span>),</span><br><span class="line">    range = <span class="built_in">document</span>.createRange();</span><br><span class="line">range.setStartAfter(p1);</span><br><span class="line">range.setEndBefore(p2);</span><br><span class="line">alert(range.collapsed); <span class="comment">//true</span></span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œåˆ›å»ºçš„èŒƒå›´æ˜¯æŠ˜å çš„ï¼Œæ‰€ä»¥ <code>p1</code> å’Œ <code>p1</code> æ˜¯ç›¸é‚»çš„ã€‚</p><h3><span id="6-æ¯”è¾ƒ-dom-èŒƒå›´">6ã€æ¯”è¾ƒ DOM èŒƒå›´</span></h3><p>åœ¨æœ‰å¤šä¸ªèŒƒå›´çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ <code>compareBoundaryPoints()</code> æ–¹æ³•æ¥ç¡®å®šè¿™äº›èŒƒå›´æ˜¯å¦æœ‰å…¬å…±çš„è¾¹ç•Œã€‚è¿™ä¸ªæ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šè¡¨ç¤ºæ¯”è¾ƒæ–¹å¼çš„å¸¸é‡å€¼å’Œè¦æ¯”è¾ƒçš„èŒƒå›´ã€‚è¡¨ç¤ºæ¯”è¾ƒæ–¹å¼çš„å¸¸é‡å¦‚ä¸‹ï¼š</p><p>1ã€<code>Range.START_TO_START</code>ï¼šæ¯”è¾ƒç¬¬ä¸€ä¸ªèŒƒå›´å’Œç¬¬äºŒä¸ªèŒƒå›´çš„èµ·ç‚¹ï¼›<br>2ã€<code>Range.START_TO_END</code>ï¼šæ¯”è¾ƒç¬¬ä¸€ä¸ªèŒƒå›´çš„èµ·ç‚¹å’Œç¬¬äºŒä¸ªèŒƒå›´çš„ç»ˆç‚¹ï¼›<br>3ã€<code>Range.END_TO_END</code>ï¼šæ¯”è¾ƒç¬¬ä¸€ä¸ªèŒƒå›´å’Œç¬¬äºŒä¸ªèŒƒå›´çš„ç»ˆç‚¹ï¼›<br>4ã€<code>Range.END_TO_START</code>ï¼šæ¯”è¾ƒç¬¬ä¸€ä¸ªèŒƒå›´çš„ç»ˆç‚¹å’Œç¬¬äºŒä¸ªèŒƒå›´çš„èµ·ç‚¹ï¼›</p><p><code>compareBoundaryPoints()</code>æ–¹æ³•è¿”å›å€¼å¦‚ä¸‹ï¼šå¦‚æœç¬¬ä¸€ä¸ªèŒƒå›´ä¸­çš„ç‚¹ä½äºç¬¬äºŒä¸ªèŒƒå›´ä¸­çš„ç‚¹ä¹‹å‰ï¼Œè¿”å› <code>-1</code> ï¼›å¦‚æœä¸¤ä¸ªç‚¹ç›¸ç­‰ï¼Œè¿”å› <code>0</code> ï¼›å¦‚æœç¬¬ä¸€ä¸ªèŒƒå›´ä¸­çš„ç‚¹ä½äºç¬¬äºŒä¸ªèŒƒå›´ä¸­çš„ç‚¹ä¹‹åï¼Œè¿”å› <code>1</code> ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> range1 = <span class="built_in">document</span>.createRange(),</span><br><span class="line">    range2 = <span class="built_in">document</span>.createRange(),</span><br><span class="line">    p1 = <span class="built_in">document</span>.getElementById(<span class="string">"p1"</span>);</span><br><span class="line">range1.selectNodeContents(p1);</span><br><span class="line">range2.selectNodeContents(p1);</span><br><span class="line">range2.setEndBefore(p1.lastChild);</span><br><span class="line">alert(range1.compareBoundaryPoints(Range.START_TO_START,range2)); <span class="comment">//0</span></span><br><span class="line">alert(range1.compareBoundaryPoints(Range.END_TO_END,range2)); <span class="comment">//1</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¸¤ä¸ªèŒƒå›´çš„èµ·ç‚¹ç›¸åŒï¼Œç¬¬ä¸€ä¸ªèŒƒå›´çš„ç»ˆç‚¹ä½äºç¬¬äºŒä¸ªèŒƒå›´çš„ç»ˆç‚¹åé¢ï¼Œå¦‚å›¾ï¼š<br><img src="https://cloud.githubusercontent.com/assets/9649921/11490882/d46e1548-9817-11e5-975c-deb496beefce.png" alt="1"></p><h3><span id="7-å¤åˆ¶-dom-èŒƒå›´">7ã€å¤åˆ¶ DOM èŒƒå›´</span></h3><p>å¯ä»¥ä½¿ç”¨ <code>cloneRange()</code> æ–¹æ³•å¤åˆ¶èŒƒå›´ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šåˆ›å»ºè°ƒç”¨å®ƒçš„èŒƒå›´çš„ä¸€ä¸ªå‰¯æœ¬ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> newRange = range.cloneRange();</span><br></pre></td></tr></table></figure><p>æ–°åˆ›å»ºçš„èŒƒå›´ä¸åŸæ¥çš„èŒƒå›´åŒ…å«ç›¸åŒçš„å±æ€§ï¼Œè€Œä¿®æ”¹å®ƒçš„ç«¯ç‚¹ä¸ä¼šå½±å“åŸæ¥çš„èŒƒå›´ã€‚</p><h3><span id="8-æ¸…ç†-dom-èŒƒå›´">8ã€æ¸…ç† DOM èŒƒå›´</span></h3><p>åœ¨ä½¿ç”¨å®ŒèŒƒå›´åï¼Œæœ€å¥½æ˜¯è°ƒç”¨ <code>detach()</code> æ–¹æ³•ï¼Œä»¥ä¾¿ä»åˆ›å»ºèŒƒå›´çš„æ–‡æ¡£ä¸­åˆ†ç¦»å‡ºè¯¥èŒƒå›´ã€‚è°ƒç”¨ <code>detach()</code> ä¹‹åï¼Œå°±å¯ä»¥æ”¾å¿ƒåœ°è§£é™¤å¯¹èŒƒå›´çš„å¼•ç”¨ï¼Œä»è€Œè®©åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶å…¶å†…å­˜äº†ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">range.detach(); <span class="comment">//ä»æ–‡æ¡£ä¸­åˆ†ç¦»</span></span><br><span class="line">range = <span class="literal">null</span>; <span class="comment">//è§£é™¤å¼•ç”¨</span></span><br></pre></td></tr></table></figure><p>åœ¨ä½¿ç”¨èŒƒå›´çš„æœ€ååœ¨æ‰§è¡Œè¿™ä¸¤ä¸ªæ­¥éª¤æ˜¯æˆ‘ä»¬æ¨èçš„æ–¹å¼ï¼Œä¸€æ—¦åˆ†ç¦»èŒƒå›´ï¼Œå°±ä¸èƒ½åœ¨æ¢å¤ä½¿ç”¨äº†ã€‚</p><h1><span id="ie8åŠæ›´æ—©ç‰ˆæœ¬ä¸­çš„èŒƒå›´">IE8åŠæ›´æ—©ç‰ˆæœ¬ä¸­çš„èŒƒå›´</span></h1><p><code>IE9</code> æ”¯æŒèŒƒå›´ï¼Œä½† <code>IE8</code> åŠä¹‹å‰ç‰ˆæœ¬ä¸æ”¯æŒèŒƒå›´ã€‚ä¸è¿‡ï¼Œ<code>IE8</code> åŠæ—©èµ·ç‰ˆæœ¬æ”¯æŒä¸€ç§ç±»ä¼¼çš„æ¦‚å¿µï¼Œå³ <strong>æ–‡æœ¬èŒƒå›´ï¼ˆtext rangeï¼‰</strong> ã€‚æ–‡æœ¬èŒƒå›´æ˜¯ <code>IE</code> ä¸“æœ‰ç‰¹æ€§ï¼Œä¸»è¦å¤„ç†æ–‡æœ¬ï¼ˆä¸ä¸€å®šæ˜¯ <code>DOM</code> èŠ‚ç‚¹ï¼‰ã€‚é€šè¿‡ <code>&lt;body&gt;</code>ã€<br><code>&lt;button&gt;</code>ã€<code>&lt;input&gt;</code>å’Œ<code>&lt;textarea&gt;</code>ç­‰å‡ ä¸ªå…ƒç´ ï¼Œå¯ä»¥è°ƒç”¨ <code>createTextRange()</code> æ–¹æ³•æ¥åˆ›å»ºæ–‡æœ¬èŒƒå›´ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> range = <span class="built_in">document</span>.body.createTextRange();</span><br></pre></td></tr></table></figure><p>ä¸ <code>DOM</code> èŒƒå›´ç±»ä¼¼ï¼Œä½¿ç”¨ <code>IE</code> æ–‡æœ¬èŒƒå›´çš„æ–¹å¼ä¹Ÿæœ‰å¾ˆå¤šç§ã€‚</p><h3><span id="1-ç”¨-ie-èŒƒå›´å®ç°ç®€å•çš„é€‰æ‹©">1ã€ç”¨ IE èŒƒå›´å®ç°ç®€å•çš„é€‰æ‹©</span></h3><p>é€‰æ‹©é¡µé¢ä¸­æŸä¸€åŒºåŸŸæœ€ç®€å•çš„æ–¹å¼ï¼Œå°±æ˜¯ä½¿ç”¨èŒƒå›´çš„ <code>findText()</code> æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•ä¼šæ‰¾åˆ°ç¬¬ä¸€æ¬¡å‡ºç°çš„ç»™å®šæ–‡æœ¬ï¼Œå¹¶å°†èŒƒå›´ç§»è¿‡æ¥ä»¥ç¯ç»•è¯¥æ–‡æœ¬ã€‚å¦‚æœæ²¡æ‰¾åˆ°æ–‡æœ¬ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å› <code>false</code> ï¼›å¦åˆ™ï¼Œè¿”å› <code>true</code> ã€‚åŒæ ·ï¼Œä»ç„¶ä»¥ä¸‹é¢çš„ <code>HTML</code> ä»£ç ä¸ºä¾‹ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"p1"</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">b</span>&gt;</span> world!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¦é€‰æ‹© <code>Hello</code> ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> range = <span class="built_in">document</span>.body.createTextRange();</span><br><span class="line"><span class="keyword">var</span> found = range.findText(<span class="string">"Hello"</span>);</span><br><span class="line">alert(found); <span class="comment">//true</span></span><br><span class="line">alert(range.text); <span class="comment">//"Hello"</span></span><br></pre></td></tr></table></figure><p><code>IE</code> ä¸­ä¸ <code>DOM</code> ä¸­çš„ <code>selectNode()</code> æ–¹æ³•æœ€æ¥è¿‘çš„æ–¹æ³•æ˜¯ <code>moveToElementText()</code> ï¼Œè¿™ä¸ªæ–¹æ³•æ¥å—ä¸€ä¸ª <code>DOM</code> å…ƒç´ ï¼Œå¹¶é€‰æ‹©è¯¥å…ƒç´ çš„æ‰€æœ‰æ–‡æœ¬ï¼ŒåŒ…å« <code>HTML</code> æ ‡ç­¾ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> range = <span class="built_in">document</span>.body.createTextRange(),</span><br><span class="line">    p1 = <span class="built_in">document</span>.getElementById(<span class="string">"p1"</span>);</span><br><span class="line">range.moveToElementText(p1);</span><br></pre></td></tr></table></figure><p>åœ¨æ–‡æœ¬èŒƒå›´ä¸­åŒ…å« <code>HTML</code> çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ <code>htmlText</code> å±æ€§å–å¾—èŒƒå›´çš„å…¨éƒ¨å†…å®¹ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alert(range.htmlText);</span><br></pre></td></tr></table></figure><p><code>IE</code> çš„èŒƒå›´æ²¡æœ‰ä»»ä½•å±æ€§å¯ä»¥éšç€èŒƒå›´é€‰åŒºçš„å˜åŒ–è€ŒåŠ¨æ€æ›´æ–°ã€‚ä¸è¿‡ï¼Œå…¶ <code>parentElement()</code> æ–¹æ³•å€’æ˜¯ä¸<code>DOM</code> çš„ <code>commonAncestorContainer</code> å±æ€§ç±»ä¼¼ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ancestor = range.parentElement();</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¾—åˆ°äº†èŒƒå›´é€‰åŒºçš„çˆ¶èŠ‚ç‚¹ã€‚</p><h3><span id="2-ä½¿ç”¨-ie-èŒƒå›´å®ç°å¤æ‚çš„é€‰æ‹©">2ã€ä½¿ç”¨ IE èŒƒå›´å®ç°å¤æ‚çš„é€‰æ‹©</span></h3><p>åœ¨ <code>IE</code> ä¸­åˆ›å»ºå¤æ‚èŒƒå›´çš„æ–¹æ³•ï¼Œå°±æ˜¯ä»¥å¢é‡å‘å››å‘¨ç§»åŠ¨èŒƒå›´ã€‚ä¸ºæ­¤ï¼Œ<code>IE</code> æä¾›äº† 4 ä¸ªæ–¹æ³•ï¼š<br><code>move()</code>ã€<code>moveStart()</code>ã€<code>moveEnd()</code> å’Œ <code>expand()</code>ã€‚<br>è¿™äº›æ–¹æ³•éƒ½æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šç§»åŠ¨å•ä½å’Œç§»åŠ¨å•ä½çš„æ•°é‡ã€‚å…¶ä¸­ï¼Œç§»åŠ¨å•ä½æ˜¯ä¸‹åˆ—ä¸€ç§å­—ç¬¦ä¸²å€¼ï¼š</p><p>1ã€<code>character</code>ï¼šè¿™ä¸ªå­—ç¬¦åœ°ç§»åŠ¨ï¼›<br>2ã€<code>word</code>ï¼šé€ä¸ªå•è¯ï¼ˆä¸€ç³»åˆ—éç©ºæ ¼å­—ç¬¦ï¼‰åœ°ç§»åŠ¨ï¼›<br>3ã€<code>sentence</code>ï¼šé€ä¸ªå¥å­ï¼ˆä¸€ç³»åˆ—ä»¥å¥å·ã€é—®å·æˆ–å¹å·ç»“å°¾çš„å­—ç¬¦ï¼‰åœ°ç§»åŠ¨ï¼›<br>4ã€<code>textedit</code>ï¼šç§»åŠ¨åˆ°å½“å‰èŒƒå›´é€‰åŒºçš„å¼€å§‹æˆ–ç»“æŸä½ç½®ã€‚</p><p>é€šè¿‡ <code>moveStart()</code> æ–¹æ³•å¯ä»¥ç§»åŠ¨åˆ°èŒƒå›´çš„èµ·ç‚¹ï¼Œé€šè¿‡ <code>moveEnd()</code> æ–¹æ³•å¯ä»¥ç§»åŠ¨åˆ°èŒƒå›´çš„ç»ˆç‚¹ï¼Œç§»åŠ¨çš„å¹…åº¦ç”±å•ä½æ•°é‡æŒ‡å®šï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">range.moveStart(<span class="string">"word"</span>,<span class="number">2</span>); <span class="comment">//èµ·ç‚¹ç§»åŠ¨ 2 ä¸ªå•è¯</span></span><br><span class="line">range.moveEnd(<span class="string">"character"</span>,<span class="number">1</span>); <span class="comment">//ç»ˆç‚¹ç§»åŠ¨ 1 ä¸ªå­—ç¬¦</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>expand()</code> æ–¹æ³•å¯ä»¥å°†èŒƒå›´è§„èŒƒåŒ–ã€‚æ¢å¥è¯è¯´ï¼Œå¯ä»¥å°†ä»»ä½•éƒ¨åˆ†é€‰æ‹©çš„æ–‡æœ¬å…¨éƒ¨é€‰ä¸­ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">range.expand(<span class="string">"word"</span>); <span class="comment">//å¯ä»¥å°†æ•´ä¸ªå•è¯é€‰ä¸­</span></span><br></pre></td></tr></table></figure><p>è€Œ <code>move()</code> æ–¹æ³•åˆ™å…ˆä¼šæŠ˜å å½“å‰èŒƒå›´ï¼Œç„¶åå†å°†èŒƒå›´ç§»åŠ¨åˆ°æŒ‡å®šçš„å•ä½æ•°é‡ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">range.move(<span class="string">"character"</span>,<span class="number">5</span>); <span class="comment">//ç§»åŠ¨ 5 ä¸ªå­—ç¬¦</span></span><br></pre></td></tr></table></figure><h3><span id="3-æ“ä½œ-ie-èŒƒå›´ä¸­çš„å†…å®¹">3ã€æ“ä½œ IE èŒƒå›´ä¸­çš„å†…å®¹</span></h3><p>åœ¨ <code>IE</code> ä¸­æ“ä½œèŒƒå›´ä¸­çš„å†…å®¹å¯ä»¥ä½¿ç”¨ <code>text</code> å±æ€§æˆ– <code>pasteHTML()</code> æ–¹æ³•ã€‚å¦‚å‰æ‰€è¿°ï¼Œé€šè¿‡ <code>text</code> å±æ€§å¯ä»¥å–å¾—èŒƒå›´ä¸­çš„å†…å®¹æ–‡æœ¬ï¼›ä½†æ˜¯ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è¿™ä¸ªå±æ€§è®¾ç½®èŒƒå›´ä¸­çš„å†…å®¹æ–‡æœ¬ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> range = <span class="built_in">document</span>.body.createTextRange();</span><br><span class="line">range.findText(<span class="string">"Hello"</span>);</span><br><span class="line">range.text = <span class="string">"Hi"</span>;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä»¥ä¸Šä»£ç åçš„ <code>HTML</code> ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">p1</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span>Hi<span class="tag">&lt;/<span class="name">b</span>&gt;</span> world!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™æ—¶ï¼Œ<code>HTML</code> æ ‡ç­¾ä¿æŒä¸å˜ï¼Œè‹¥è¦åƒèŒƒå›´ä¸­æ’å…¥ <code>HTML</code> ä»£ç ï¼Œå°±å¾—ä½¿ç”¨ <code>pasteHTMl()</code> æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> range = <span class="built_in">document</span>.body.createTextRange();</span><br><span class="line">range.findText(<span class="string">"Hello"</span>);</span><br><span class="line">range.pasteHTML(<span class="string">"&lt;em&gt;Hi&lt;/em&gt;"</span>);</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä»¥ä¸Šä»£ç åçš„ <code>HTML</code> ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">p1</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">em</span>&gt;</span>Hi<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span> world!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šåœ¨èŒƒå›´ä¸­åŒ…å« <code>HTML</code> ä»£ç æ—¶ï¼Œä¸åº”è¯¥ä½¿ç”¨ <code>pasteHTML()</code> ï¼Œå› ä¸ºè¿™æ ·å¾ˆå®¹æ˜“å¯¼è‡´ä¸å¯é¢„æ–™çš„ç»“æœï¼ˆå¾ˆå¯èƒ½æ˜¯æ ¼å¼ä¸æ­£ç¡®çš„ <code>HTML</code>ï¼‰ã€‚</p><h3><span id="4-æŠ˜å -ie-èŒƒå›´">4ã€æŠ˜å  IE èŒƒå›´</span></h3><p><code>IE</code> ä¸ºèŒƒå›´æä¾›çš„ <code>collapse()</code> æ–¹æ³•ä¸ <code>DOM</code> æ–¹æ³•ç”¨æ³•ä¸€æ ·ï¼Œå¯æƒœï¼Œæ²¡æœ‰å¯¹åº”çš„ <code>collapsed</code> å±æ€§è®©æˆ‘ä»¬çŸ¥é“èŒƒå›´æ˜¯å¦å·²ç»æŠ˜å å®Œæ¯•ã€‚ä¸ºæ­¤ï¼Œå¿…é¡»ä½¿ç”¨ <code>boundingWidth</code> å±æ€§ï¼Œè¯¥å±æ€§è¿”å›èŒƒå›´çš„å®½åº¦ï¼ˆä»¥åƒç´ ä¸ºå•ä½ï¼‰ã€‚å¦‚æœç­‰äº <code>0</code> è¯´æ˜èŒƒå›´å·²ç»æŠ˜å ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">range.collapse(<span class="literal">true</span>);</span><br><span class="line">alert(range.boundingWidth); <span class="comment">//0</span></span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œè¿˜æœ‰ <code>boundingHeight</code>ã€<code>boundingLeft</code> å’Œ<code>boundingTop</code> ç­‰å±æ€§ï¼Œå¯ä»¥æä¾›ä¸€äº›ä½ç½®ä¿¡æ¯ã€‚</p><h3><span id="5-æ¯”è¾ƒ-ie-èŒƒå›´">5ã€æ¯”è¾ƒ IE èŒƒå›´</span></h3><p><code>IE</code> ä¸­çš„ <code>compareEndPoints()</code> æ–¹æ³•ä¸ <code>DOM</code> èŒƒå›´çš„ <code>compareBoundaryPoints()</code> æ–¹æ³•ç±»ä¼¼ã€‚è¿™ä¸ªæ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šæ¯”è¾ƒçš„ç±»å‹å’Œè¦æ¯”è¾ƒçš„èŒƒå›´ã€‚æ¯”è¾ƒç±»å‹çš„å–å€¼èŒƒå›´æ˜¯ä¸‹åˆ—å‡ ä¸ªå­—ç¬¦ä¸²å€¼ï¼š<code>StartToStart</code>ã€<br><code>StartToEnd</code>ã€<code>EndToEnd</code>ã€<code>EndToStart</code>ã€‚ <code>compareEndPoints()</code> æ–¹æ³•è¿”å›å€¼åŒ <code>compareBoundaryPoints()</code> æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> range1 = <span class="built_in">document</span>.body.createTextRange(),</span><br><span class="line">    range2 = <span class="built_in">document</span>.body.createTextRange();</span><br><span class="line">range1.findText(<span class="string">"Hello world!"</span>);</span><br><span class="line">range2.findText(<span class="string">"Hello"</span>);</span><br><span class="line">alert(range1.compareEndPoints(<span class="string">"StartToStart"</span>,range2)); <span class="comment">//0</span></span><br><span class="line">alert(range1.compareEndPoints(<span class="string">"EndToEnd"</span>,range2)); <span class="comment">//1</span></span><br></pre></td></tr></table></figure><p><code>IE</code> ä¸­è¿˜æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œä¹Ÿç”¨äºæ¯”è¾ƒèŒƒå›´ï¼š<code>isEqual()</code> æ–¹æ³•ç”¨äºç¡®å®šä¸¤ä¸ªèŒƒå›´æ˜¯å¦ç›¸ç­‰ï¼Œ<code>inRange()</code> æ–¹æ³•ç”¨äºç¡®å®šä¸€ä¸ªèŒƒå›´æ˜¯å¦åŒ…å«å¦ä¸€ä¸ªèŒƒå›´ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> range1 = <span class="built_in">document</span>.body.createTextRange(),</span><br><span class="line">    range2 = <span class="built_in">document</span>.body.createTextRange();</span><br><span class="line">range1.findText(<span class="string">"Hello world!"</span>);</span><br><span class="line">range2.findText(<span class="string">"Hello"</span>);</span><br><span class="line">alert(<span class="string">"range1.isEqual(range2):"</span>+range1.isEqual(range2)); <span class="comment">//false</span></span><br><span class="line">alert(<span class="string">"range1.inRange(range2):"</span>+range1.inRange(range2)); <span class="comment">//true</span></span><br></pre></td></tr></table></figure><h3><span id="6-å¤åˆ¶-ie-èŒƒå›´">6ã€å¤åˆ¶ IE èŒƒå›´</span></h3><p>åœ¨ <code>IE</code> ä¸­ä½¿ç”¨ <code>duplicate()</code> æ–¹æ³•å¯ä»¥å¤åˆ¶æ–‡æœ¬èŒƒå›´ï¼Œç»“æœä¼šåˆ›å»ºåŸèŒƒå›´çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> newRange = range.duplicate();</span><br></pre></td></tr></table></figure><p>æ–°åˆ›å»ºçš„èŒƒå›´ä¼šå¸¦æœ‰ä¸åŸèŒƒå›´å®Œå…¨ç›¸åŒçš„å±æ€§ã€‚<br><br></p><p><g-emoji alias="yum" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f60b.png" ios-version="6.0">ğŸ˜‹</g-emoji><g-emoji alias="yum" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f60b.png" ios-version="6.0">ğŸ˜‹</g-emoji><g-emoji alias="yum" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f60b.png" ios-version="6.0">ğŸ˜‹</g-emoji> å¥½äº†ï¼ŒåŸºæœ¬çŸ¥è¯†å°±æ˜¯è¿™äº›ï¼Œåœ¨è¿™é‡Œå’Œå¤§å®¶è¯´æ‹œæ‹œå•¦~</p><p><a href="http://yixunfe.github.io/blog/demo/37/demo.html" target="_blank" rel="noopener">æŸ¥çœ‹demo</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#dom-ä¸­çš„èŒƒå›´&quot;&gt;DOM ä¸­çš„èŒƒå›´&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-ç”¨-dom-èŒƒå›´å®ç°ç®€å•é€‰æ‹©&quot;&gt;1ã€ç”¨ DOM èŒƒå›´å®ç°ç®€å•é€‰æ‹©&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-ç”¨-dom-èŒƒ
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://zdddrszj.github.io/h-blog/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="range" scheme="https://zdddrszj.github.io/h-blog/tags/range/"/>
    
  </entry>
  
</feed>
