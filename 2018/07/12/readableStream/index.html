<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Shirly,zdddrszj@163.com"><title>ReadableStream ç®€å•å®ç° Â· Shirly</title><meta name="description" content="ä¸€ã€åˆ›å»ºå¯è¯»æµ
äºŒã€è¯»å–é•¿åº¦å°äºæ°´ä½çº¿
ä¸‰ã€è¯»å–é•¿åº¦ç­‰äºæ°´ä½çº¿
å››ã€è¯»å–é•¿åº¦å¤§äºæ°´ä½çº¿


ä»Šå¤©çš„æ–‡ç« éœ€è¦æå‰äº†è§£ä¸€ä¸‹ node ä¸­ fs æ¨¡å—çš„ç›¸å…³ apiï¼Œä¸å¤ªç†Ÿæ‚‰çš„åŒå­¦å¯ä»¥ç‚¹è¿™é‡Œã€‚

ä¼—æ‰€å‘¨çŸ¥ï¼Œ"><meta name="keywords" content="Web,HTML,CSS,android,Linux"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/h-blog/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><link rel="stylesheet" href="/h-blog/css/style.css"><link rel="stylesheet" href="/h-blog/css/blog_basic.css"><link rel="stylesheet" href="/h-blog/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/h-blog/images/logo@2x.png" style="width:127px;"><h3 style="text-transform:none;"><a href="/">Shirly</a></h3><div class="description"><p>Without a friend the world is a wilderness.</p></div></div></div><ul class="social-links"><li><a href="/h-blog/atom.xml"><i class="fa fa-rss"></i></a></li><li><a href="http://weibo.com/zdddrszj/home"><i class="fa fa-weibo"></i></a></li><li><a href="http://github.com/zdddrszj"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/h-blog">é¦–é¡µ</a></li><li><a href="/h-blog/archives">å½’æ¡£</a></li><li><a href="/h-blog/tagsCloud">æ ‡ç­¾äº‘</a></li><li><a href="/h-blog/about">å…³äº</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="/h-blog/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h2><a>ReadableStream ç®€å•å®ç°</a></h2><div class="post-intro"><span class="wordcount"><i class="fa fa-calendar-o"></i><span class="post-count">2018-07-12</span></span><span class="post-meta-divider">|</span><span class="wordcount"><i class="fa fa-folder-o"></i><span class="post-count"><a href="/h-blog/categories/å‰ç«¯/" title class="tag">å‰ç«¯</a></span></span><span class="post-meta-divider">|</span><span class="wordcount"><i class="fa fa-edit"></i><span class="post-count">å­—æ•°ç»Ÿè®¡2,440</span></span><span class="post-meta-divider">|</span><span class="wordcount"><i class="fa fa-clock-o"></i><span class="post-count">é˜…è¯»æ—¶é•¿11åˆ†é’Ÿ</span></span></div></div><div class="post-content"><!-- toc -->
<ul>
<li><a href="#ä¸€-åˆ›å»ºå¯è¯»æµ">ä¸€ã€åˆ›å»ºå¯è¯»æµ</a></li>
<li><a href="#äºŒ-è¯»å–é•¿åº¦å°äºæ°´ä½çº¿">äºŒã€è¯»å–é•¿åº¦å°äºæ°´ä½çº¿</a></li>
<li><a href="#ä¸‰-è¯»å–é•¿åº¦ç­‰äºæ°´ä½çº¿">ä¸‰ã€è¯»å–é•¿åº¦ç­‰äºæ°´ä½çº¿</a></li>
<li><a href="#å››-è¯»å–é•¿åº¦å¤§äºæ°´ä½çº¿">å››ã€è¯»å–é•¿åº¦å¤§äºæ°´ä½çº¿</a></li>
</ul>
<!-- tocstop -->
<p>ä»Šå¤©çš„æ–‡ç« éœ€è¦æå‰äº†è§£ä¸€ä¸‹ <code>node</code> ä¸­ <code>fs</code> æ¨¡å—çš„ç›¸å…³ <code>api</code>ï¼Œä¸å¤ªç†Ÿæ‚‰çš„åŒå­¦å¯ä»¥<a href="http://nodejs.cn/api/fs.html" target="_blank" rel="noopener">ç‚¹è¿™é‡Œ</a>ã€‚</p>
<blockquote>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼Œ<code>node</code> ä¸­çš„ <code>fs</code> æ¨¡å—åŠŸèƒ½å¤§éƒ½ä¸æ–‡ä»¶ç›¸å…³ï¼Œæ¯”å¦‚å¯ä»¥é€šè¿‡ <code>fs.createReadStream</code> åˆ›å»ºæ–‡ä»¶å¯è¯»æµï¼Œé€šè¿‡<code>fs.createWriteStream</code> åˆ›å»ºæ–‡ä»¶å¯å†™æµï¼Œè¿˜å¯ä»¥é€šè¿‡ç›‘å¬ <code>open</code>ã€<code>data</code>ã€<code>end</code>ã€<code>error</code>ã€<code>readable</code> äº‹ä»¶å¯¹æ•°æ®è¿›è¡Œæ“ä½œã€‚ç”±äºæ—¶é—´æœ‰é™ï¼Œä»Šå¤©æˆ‘ä»¬å…ˆæ¥å®ç°ä¸€ä¸‹ <code>readable</code> äº‹ä»¶åŠŸèƒ½ã€‚</p>
</blockquote>
<p>å¼€å§‹ä¹‹å‰ï¼Œå…ˆç®€å•ä»‹ç»ä¸€ä¸‹å¯è¯»æµå‡½æ•° <code>fs.createReadStream(path[, options])</code> ä¸­å„å‚æ•°æ‰€ä»£è¡¨çš„å«ä¹‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<ul>
<li><code>path &lt;string&gt; | &lt;Buffer&gt; | &lt;URL&gt;</code> åˆ›å»ºå¯è¯»æµçš„è·¯å¾„</li>
<li><code>options &lt;string&gt; | &lt;Object&gt;</code> å¯é€‰å‚æ•°<ul>
<li><code>flags &lt;string&gt;</code> æ–‡ä»¶è¯»å†™æ ‡è¯†ï¼Œé»˜è®¤ä¸º r</li>
<li><code>encoding &lt;string&gt;</code> è¯»å–ç¼–ç æ ¼å¼ï¼Œé»˜è®¤ä¸º null</li>
<li><code>fd &lt;integer&gt;</code> æ–‡ä»¶æè¿°ç¬¦ï¼Œé»˜è®¤ä¸º null</li>
<li><code>mode &lt;integer&gt;</code> æ–‡ä»¶æ“ä½œæƒé™ï¼Œé»˜è®¤ä¸º 0o666</li>
<li><code>autoClose &lt;boolean&gt;</code> æ–‡ä»¶æ˜¯å¦è‡ªåŠ¨å…³é—­ï¼Œé»˜è®¤ä¸º true</li>
<li><code>start &lt;integer&gt;</code> æ–‡ä»¶è¯»å–å¼€å§‹ä½ç½®ï¼Œé»˜è®¤ä¸º 0</li>
<li><code>end &lt;integer&gt;</code> æ–‡ä»¶è¯»å–ç»“æŸä½ç½®ï¼Œé»˜è®¤ä¸º Infinity</li>
<li><code>highWaterMark &lt;integer&gt;</code> æ°´ä½çº¿ï¼Œæ¯æ¬¡è¯»å–é•¿åº¦ï¼Œé»˜è®¤ä¸º 64å­—èŠ‚ï¼ˆ64 * 1024ï¼‰</li>
</ul>
</li>
</ul>
<h2><span id="ä¸€-åˆ›å»ºå¯è¯»æµ">ä¸€ã€åˆ›å»ºå¯è¯»æµ</span></h2><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªå¯è¯»æµçš„ç±»ï¼Œä¸é˜²å®šä¹‰ä¸º <code>ReadableStream</code>ï¼Œè¯¥ç±»å¯ä»¥é€šè¿‡ <code>on</code> å‡½æ•°è¿›è¡Œäº‹ä»¶ç›‘å¬ï¼Œæ‰€ä»¥éœ€è¦ç»§æ‰¿ <code>node</code> ä¸­ <code>EventEmitter</code> ç±»ï¼›<br>å½“ç›‘å¬ <code>readable</code> å‡½æ•°æ—¶å¯è¯»å–åˆ°æ–‡ä»¶å†…å®¹ï¼Œç”±æ­¤å¾—çŸ¥åœ¨æ„é€ å‡½æ•°ä¸­é™¤äº†éœ€è¦å®šä¹‰ä¸Šé¢çš„å˜é‡ï¼Œè¿˜éœ€è¦è°ƒç”¨æ‰“å¼€æ–‡ä»¶å’Œç¬¬ä¸€æ¬¡è¯»å–æ–‡ä»¶çš„åŠŸèƒ½ã€‚ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">let</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReadableStream</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(path, options) &#123;</span><br><span class="line">    <span class="keyword">super</span>()</span><br><span class="line">    <span class="keyword">this</span>.path = path</span><br><span class="line">    <span class="keyword">this</span>.flags = options.flags || <span class="string">'r'</span></span><br><span class="line">    <span class="keyword">this</span>.encoding = options.encoding || <span class="literal">null</span></span><br><span class="line">    <span class="keyword">this</span>.autoClose = options.autoClose || <span class="literal">true</span></span><br><span class="line">    <span class="keyword">this</span>.highWaterMark = options.highWaterMark || <span class="number">64</span> * <span class="number">1024</span></span><br><span class="line">    <span class="keyword">this</span>.start = options.start || <span class="number">0</span></span><br><span class="line">    <span class="keyword">this</span>.end = options.end || <span class="literal">null</span></span><br><span class="line">    <span class="keyword">this</span>.mode = options.mode || <span class="number">0o666</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦æ­£åœ¨è¯»å–æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">this</span>.reading = <span class="literal">false</span></span><br><span class="line">    <span class="comment">// å½“len=0æ—¶ï¼Œè§¦å‘readableäº‹ä»¶</span></span><br><span class="line">    <span class="keyword">this</span>.emitReadable = <span class="literal">false</span></span><br><span class="line">    <span class="comment">// ç¼“å­˜ä¸­å­—èŠ‚çš„é•¿åº¦</span></span><br><span class="line">    <span class="keyword">this</span>.len = <span class="number">0</span></span><br><span class="line">    <span class="comment">// ç¼“å­˜æ¯æ¬¡è¯»å–çš„å†…å®¹ï¼Œæ ¼å¼ä¸º[&lt;Buffer /&gt;, &lt;Buffer /&gt;, ...]</span></span><br><span class="line">    <span class="keyword">this</span>.arr = []</span><br><span class="line">    <span class="comment">// æ–‡ä»¶è¯»å–çš„ä½ç½®</span></span><br><span class="line">    <span class="keyword">this</span>.pos = <span class="keyword">this</span>.start</span><br><span class="line">    <span class="comment">// æ˜¯å¦æ–‡ä»¶å…¨éƒ¨è¯»å–å®Œ</span></span><br><span class="line">    <span class="keyword">this</span>.finished = <span class="literal">false</span></span><br><span class="line">    <span class="comment">// æ‰“å¼€æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">this</span>.open()</span><br><span class="line">    <span class="comment">// åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç›‘å¬äº†readableäº‹ä»¶</span></span><br><span class="line">    <span class="keyword">this</span>.on(<span class="string">'newListener'</span>, (type) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (type === <span class="string">'readable'</span>) &#123;</span><br><span class="line">        <span class="comment">// ç¬¬ä¸€æ¬¡æ–‡ä»¶è¯»å–</span></span><br><span class="line">        <span class="keyword">this</span>.read()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = ReadableStream</span><br></pre></td></tr></table></figure></p>
<p>æ„é€ å‡½æ•°ä¸­å…¶å®ƒå˜é‡å¯ä»¥å…ˆå¿½ç•¥ï¼Œåˆ°å®ç°é˜¶æ®µæ—¶æˆ‘ç›¸ä¿¡å¤§å®¶è‡ªç„¶æ¸…æ™°å…¶ç”¨å¤„ã€‚<br>ä¸‹é¢åˆ©ç”¨ <code>fs.open</code> å’Œ <code>fs.destory</code> å®ç° <code>open</code> å’Œ <code>destory</code> åŠŸèƒ½ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰“å¼€å¯è¯»æµ</span></span><br><span class="line">open() &#123;</span><br><span class="line">  fs.open(<span class="keyword">this</span>.path, <span class="keyword">this</span>.flags, (err, fd) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">this</span>.emit(<span class="string">'error'</span>)</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.autoClose) &#123;</span><br><span class="line">        <span class="keyword">this</span>.destory()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.fd = fd</span><br><span class="line">    <span class="keyword">this</span>.emit(<span class="string">'open'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å…³é—­å¯è¯»æµï¼Œå‚æ•°ä¸ºæ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">destory() &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span>.fd === <span class="string">'number'</span>) &#123;</span><br><span class="line">    fs.close(<span class="keyword">this</span>.fd, () =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.emit(<span class="string">'close'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.emit(<span class="string">'close'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æ¥ä¸‹æ¥çœ‹ä¸‹åˆæ¬¡è¯»å–æ—¶çš„ <code>read</code> å‡½æ•°ã€‚</p>
<blockquote>
<p>å®ç°æ€è·¯ï¼šåœ¨æ„é€ å‡½æ•°ä¸­ï¼Œå½“è§¦å‘ç¬¬ä¸€æ¬¡è¯»å–æ–‡ä»¶æ—¶ï¼Œè¯»å–å¤§å°ä¸º <code>highWaterMark</code> ä¸ªï¼Œä¸é˜²æˆ‘ä»¬å°†æ¯”è¾ƒè¯»å–é•¿åº¦å’Œç¼“å­˜é•¿åº¦çš„æ–¹æ³•è®¾å®šä¸º <code>read</code>ã€‚ç„¶åå† <code>read</code> å‡½æ•°ä¸­åˆ¤æ–­ï¼Œå¦‚æœç¼“å­˜åŒºé•¿åº¦ä¸º <code>0</code> æ—¶ï¼Œè¡¨æ˜å¯ä»¥è§¦å‘ <code>readable</code> äº‹ä»¶ï¼›å¦‚æœç¼“å­˜åŒºé•¿åº¦å°äºæ°´ä½çº¿æ—¶ï¼Œåˆ™è¿›è¡Œæ–‡ä»¶è¯»å–ï¼Œæ­¤æ—¶æˆ‘ä»¬å°†çœŸæ­£è¯»å–æ–‡ä»¶çš„å‡½æ•°å‘½åä¸º <code>_read</code>ï¼›æœ€åï¼Œæ ¹æ®ç¼–ç æ ¼å¼è¿›è¡Œè¿”å›æ•°æ®ã€‚</p>
</blockquote>
<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReadableStream</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å¯è¯»æµå®ä¾‹è°ƒç”¨çš„æ–¹æ³•</span></span><br><span class="line">  read () &#123;</span><br><span class="line">    <span class="keyword">let</span> buffer = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœç¼“å­˜åŒºé•¿åº¦ä¸º0æ—¶ï¼Œè¡¨æ˜å¯ä»¥è§¦å‘readableäº‹ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.len === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.emitReadable = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœç¼“å­˜åŒºé•¿åº¦å°äºæ°´ä½çº¿æ—¶ï¼Œåˆ™è¿›è¡Œæ–‡ä»¶è¯»å–</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.len &lt; <span class="keyword">this</span>.highWaterMark) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.reading) &#123;</span><br><span class="line">        <span class="keyword">this</span>.reading = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">this</span>._read()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®ç¼–ç æ–¹å¼å¤„ç†æ•°æ®</span></span><br><span class="line">    <span class="keyword">if</span> (buffer) &#123;</span><br><span class="line">      buffer = <span class="keyword">this</span>.encoding ? buffer.toString(<span class="keyword">this</span>.encoding) : buffer</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> buffer</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// çœŸå®è¯»å–æ–‡ä»¶çš„æ–¹æ³•</span></span><br><span class="line">  _read () &#123;</span><br><span class="line">    <span class="comment">// å› ä¸ºæ‰“å¼€æ–‡ä»¶ä¸ºå¼‚æ­¥æ“ä½œï¼Œå½“è¯»å–æ—¶æ–‡ä»¶æœªæ‰“å¼€ï¼Œå¯ä»¥é€šè¿‡æ³¨å†Œä¸€æ¬¡openäº‹ä»¶ï¼Œæ‰“å¼€åæ‰§è¡Œå›è°ƒå³å¯æ‹¿åˆ°this.fd</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span>.fd !== <span class="string">'number'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.once(<span class="string">'open'</span>, () =&gt; <span class="keyword">this</span>._read())</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> howMuchToRead = <span class="keyword">this</span>.end ? <span class="built_in">Math</span>.min(<span class="keyword">this</span>.highWaterMark, <span class="keyword">this</span>.end - <span class="keyword">this</span>.pos + <span class="number">1</span>) : <span class="keyword">this</span>.highWaterMark</span><br><span class="line">    <span class="keyword">let</span> buffer = Buffer.alloc(howMuchToRead)</span><br><span class="line">    fs.read(<span class="keyword">this</span>.fd, buffer, <span class="number">0</span>, <span class="keyword">this</span>.howMuchToRead, <span class="keyword">this</span>.pos, (err, bytesRead) =&gt; &#123;</span><br><span class="line">      <span class="comment">// bytesRead ä¸ºæ–‡ä»¶è¯»å–åˆ°çš„é•¿åº¦</span></span><br><span class="line">      <span class="keyword">if</span> (bytesRead &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// å°†è¯»å–çš„å†…å®¹ç¼“å­˜åˆ°arræ•°ç»„ä¸­</span></span><br><span class="line">        <span class="keyword">this</span>.arr.push(buffer)</span><br><span class="line">        <span class="comment">// ç›¸å…³å˜é‡æ›´æ–°</span></span><br><span class="line">        <span class="keyword">this</span>.len += bytesRead</span><br><span class="line">        <span class="keyword">this</span>.pos += bytesRead</span><br><span class="line">        <span class="keyword">this</span>.reading = <span class="literal">false</span></span><br><span class="line">        <span class="comment">// ç¼“å­˜åè§¦å‘å®ä¾‹ä¸Šç”¨æˆ·è°ƒç”¨çš„readå‡½æ•°</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.emitReadable) &#123;</span><br><span class="line">          <span class="keyword">this</span>.emitReadable = <span class="literal">false</span></span><br><span class="line">          <span class="keyword">this</span>.emit(<span class="string">'readable'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å½“å‰ <code>1.txt</code> æ–‡ä»¶ä¸­çš„å†…å®¹ä¸º <code>1234567890</code>ã€‚è°ƒç”¨æ–¹å¼å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">let</span> ReadableStream = <span class="built_in">require</span>(<span class="string">'./ReadableStream'</span>)</span><br><span class="line"><span class="keyword">let</span> rs = <span class="keyword">new</span> ReadableStream(<span class="string">'./1.txt'</span>, &#123;</span><br><span class="line">  autoClose: <span class="literal">true</span>,</span><br><span class="line">  start: <span class="number">0</span>,</span><br><span class="line">  flags: <span class="string">'r'</span>,</span><br><span class="line">  encoding: <span class="string">'utf8'</span>,</span><br><span class="line">  highWaterMark: <span class="number">3</span></span><br><span class="line">&#125;)</span><br><span class="line">rs.on(<span class="string">'readable'</span>, () =&gt; &#123;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>æ¥ä¸‹æ¥ä»ç¼“å­˜åŒºä¸­è¯»å–æ•°æ®ã€‚</p>
<h2><span id="äºŒ-è¯»å–é•¿åº¦å°äºæ°´ä½çº¿">äºŒã€è¯»å–é•¿åº¦å°äºæ°´ä½çº¿</span></h2><p>å½“è¯»å–é•¿åº¦å°äºæ°´ä½çº¿æ—¶ï¼Œä½¿ç”¨åŸç”Ÿæ–¹å¼è°ƒç”¨ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">let</span> rs = fs.createReadStream(<span class="string">'./1.txt'</span>, &#123;</span><br><span class="line">  autoClose: <span class="literal">true</span>,</span><br><span class="line">  start: <span class="number">0</span>,</span><br><span class="line">  flags: <span class="string">'r'</span>,</span><br><span class="line">  encoding: <span class="string">'utf8'</span>,</span><br><span class="line">  highWaterMark: <span class="number">3</span></span><br><span class="line">&#125;)</span><br><span class="line">rs.on(<span class="string">'readable'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> r = rs.read(<span class="number">2</span>)</span><br><span class="line">  <span class="comment">// è¾“å‡ºç»“æœä¸º 12</span></span><br><span class="line">  <span class="built_in">console</span>.log(r)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>ç”±æ­¤å¯çŸ¥ï¼Œå¦‚æœç¼“å†²åŒºå†…å®¹å¤Ÿè¯»ï¼Œåˆ™è¿”å›ç»“æœç»“æŸè¯»å–ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReadableStream</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯è¯»æµå®ä¾‹è°ƒç”¨çš„æ–¹æ³•</span></span><br><span class="line">  read (n) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå‚æ•°ä¸ºç©ºä¸”ä¸æ˜¯åœ¨æ„é€ å‡½æ•°ä¸­è°ƒç”¨æ­¤å‡½æ•°ï¼Œn é»˜è®¤æŒ‰highWaterMarkå¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> n === <span class="string">'undefined'</span> &amp;&amp; <span class="keyword">this</span>.pos &gt; <span class="keyword">this</span>.start) &#123;</span><br><span class="line">      n = <span class="keyword">this</span>.highWaterMark</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœè¯»å–é•¿åº¦å°äºç¼“å­˜åŒºé•¿åº¦ï¼Œthis.read(2) highWaterMark=3</span></span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">0</span> &amp;&amp; n &lt;= <span class="keyword">this</span>.len) &#123;</span><br><span class="line">      buffer = Buffer.alloc(n)</span><br><span class="line">      <span class="keyword">let</span> current</span><br><span class="line">      <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">      <span class="keyword">let</span> flag = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">while</span> (flag &amp;&amp; (current = <span class="keyword">this</span>.arr.shift())) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; current.length; i++) &#123;</span><br><span class="line">          buffer[index++] = current[i]</span><br><span class="line">          <span class="keyword">if</span> (index === n) &#123;</span><br><span class="line">            flag = <span class="literal">false</span></span><br><span class="line">            <span class="keyword">let</span> other = current.slice(i + <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> (other.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="keyword">this</span>.arr.unshift(other)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.len -= n</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœç¼“å­˜åŒºé•¿åº¦ä¸º0æ—¶ï¼Œè¡¨æ˜å¯ä»¥è§¦å‘readableäº‹ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.len === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.emitReadable = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœç¼“å­˜åŒºé•¿åº¦å°äºæ°´ä½çº¿æ—¶ï¼Œåˆ™è¿›è¡Œæ–‡ä»¶è¯»å–</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.len &lt; <span class="keyword">this</span>.highWaterMark) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.reading) &#123;</span><br><span class="line">        <span class="keyword">this</span>.reading = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">this</span>._read()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®ç¼–ç æ–¹å¼å¤„ç†æ•°æ®</span></span><br><span class="line">    <span class="keyword">if</span> (buffer) &#123;</span><br><span class="line">      buffer = <span class="keyword">this</span>.encoding ? buffer.toString(<span class="keyword">this</span>.encoding) : buffer</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> buffer</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2><span id="ä¸‰-è¯»å–é•¿åº¦ç­‰äºæ°´ä½çº¿">ä¸‰ã€è¯»å–é•¿åº¦ç­‰äºæ°´ä½çº¿</span></h2><p>å½“è¯»å–é•¿åº¦ç­‰äºæ°´ä½çº¿æ—¶ï¼Œä½¿ç”¨åŸç”Ÿæ–¹å¼è°ƒç”¨ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">let</span> rs = fs.createReadStream(<span class="string">'./1.txt'</span>, &#123;</span><br><span class="line">  autoClose: <span class="literal">true</span>,</span><br><span class="line">  start: <span class="number">0</span>,</span><br><span class="line">  flags: <span class="string">'r'</span>,</span><br><span class="line">  encoding: <span class="string">'utf8'</span>,</span><br><span class="line">  highWaterMark: <span class="number">2</span></span><br><span class="line">&#125;)</span><br><span class="line">rs.on(<span class="string">'readable'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> r = rs.read(<span class="number">2</span>)</span><br><span class="line">  <span class="comment">// è¾“å‡ºç»“æœä¸º 12 34 56 78 90 null</span></span><br><span class="line">  <span class="built_in">console</span>.log(r)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>ç”±æ­¤å¯çŸ¥ï¼Œå¦‚æœç¼“å†²åŒºå†…å®¹è¯»å®Œä¸ºç©ºï¼Œåˆ™è¿”å›ç»“æœç»§ç»­è¯»å–ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReadableStream</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line"></span><br><span class="line">  read (n) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœè¯»å–é•¿åº¦ç­‰äºæ°´ä½çº¿ï¼Œthis.len ç­‰äº 0ï¼Œè¡¨æ˜å¯ä»¥è§¦å‘readableäº‹ä»¶ï¼Œå›º_readåä¼šè§¦å‘readableå‡½æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.len === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.emitReadable = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœç¼“å­˜åŒºé•¿åº¦å°äºæ°´ä½çº¿æ—¶ï¼Œåˆ™è¿›è¡Œæ–‡ä»¶è¯»å–</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.len &lt; <span class="keyword">this</span>.highWaterMark) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.reading) &#123;</span><br><span class="line">        <span class="keyword">this</span>.reading = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">this</span>._read()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> buffer</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2><span id="å››-è¯»å–é•¿åº¦å¤§äºæ°´ä½çº¿">å››ã€è¯»å–é•¿åº¦å¤§äºæ°´ä½çº¿</span></h2><p>å½“è¯»å–é•¿åº¦å¤§äºæ°´ä½çº¿æ—¶ï¼Œä½¿ç”¨åŸç”Ÿæ–¹å¼è°ƒç”¨ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">let</span> rs = fs.createReadStream(<span class="string">'./1.txt'</span>, &#123;</span><br><span class="line">  autoClose: <span class="literal">true</span>,</span><br><span class="line">  start: <span class="number">0</span>,</span><br><span class="line">  flags: <span class="string">'r'</span>,</span><br><span class="line">  encoding: <span class="string">'utf8'</span>,</span><br><span class="line">  highWaterMark: <span class="number">3</span></span><br><span class="line">&#125;)</span><br><span class="line">rs.on(<span class="string">'readable'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> r = rs.read(<span class="number">8</span>)</span><br><span class="line">  <span class="comment">// è¾“å‡ºç»“æœä¸º null 12345678 90</span></span><br><span class="line">  <span class="built_in">console</span>.log(r)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>ç”±æ­¤å¯çŸ¥ï¼Œå¦‚æœç¼“å†²åŒºå†…å®¹ä¸å¤Ÿè¯»ï¼Œåˆæ¬¡ä¼šè¿”å› <code>null</code>ï¼Œç„¶åä¿®æ”¹ <code>highWaterMark</code> å€¼ç»§ç»­è¯»å–è¿”å›ï¼Œå³ä¸º <code>12345678</code>ã€‚æ­¤æ—¶ï¼Œ<code>this.len</code> ä¸ç­‰äº <code>0</code> ä¸”å°äº <code>this.highWaterMark</code>ï¼Œä¼šå†æ¬¡è°ƒç”¨ <code>_read</code> æ–¹æ³•ï¼Œå¦‚æœè¯»å–æ–‡ä»¶ä¸ºç©ºï¼Œåˆ™éœ€è¦æ‰‹åŠ¨è§¦å‘ä¸€ä¸‹ <code>readable</code> äº‹ä»¶ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReadableStream</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯è¯»æµå®ä¾‹è°ƒç”¨çš„æ–¹æ³•</span></span><br><span class="line">  read (n) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœthis.read(8) highWaterMark=3 </span></span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="keyword">this</span>.len) &#123;</span><br><span class="line">      <span class="comment">// ä¸å¤Ÿè¯»æ—¶ä¸”æ–‡ä»¶æ²¡æœ‰è¯»å–å®Œï¼Œä¿®æ”¹highWaterMarkç»§ç»­è¯»å–</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.finished) &#123;</span><br><span class="line">        <span class="keyword">this</span>.highWaterMark = computeNewHighWaterMark(n)</span><br><span class="line">        <span class="keyword">this</span>.reading = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">this</span>.emitReadable = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">this</span>._read()</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦åˆ™ç›´æ¥è¿”å›ç¼“å­˜æ•°æ®</span></span><br><span class="line">        buffer = <span class="keyword">this</span>.arr.shift()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> buffer</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// çœŸå®è¯»å–æ–‡ä»¶çš„æ–¹æ³•</span></span><br><span class="line">  _read () &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line"></span><br><span class="line">    fs.read(<span class="keyword">this</span>.fd, buffer, <span class="number">0</span>, howMuchToRead, <span class="keyword">this</span>.pos, (err, bytesRead) =&gt; &#123;</span><br><span class="line">      <span class="comment">// bytesRead ä¸ºæ–‡ä»¶è¯»å–åˆ°çš„é•¿åº¦</span></span><br><span class="line">      <span class="keyword">if</span> (bytesRead &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// this.lenä¸ç­‰äº0ä¸”å°äºthis.highWaterMarkï¼Œéœ€è¦æ‰‹åŠ¨è§¦å‘ä¸€ä¸‹readableäº‹ä»¶</span></span><br><span class="line">        <span class="keyword">this</span>.finished = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.len) &#123;</span><br><span class="line">          <span class="keyword">this</span>.emit(<span class="string">'readable'</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>.emit(<span class="string">'end'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ­¤å¤„å¦‚ä¸Šï¼Œçœç•¥...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è®¡ç®— <code>highWaterMark</code> çš„å‡½æ•°å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">computeNewHighWaterMark</span> (<span class="params">n</span>) </span>&#123;</span><br><span class="line">  n--;</span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">  n++;</span><br><span class="line">  <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><a href="https://github.com/zdddrszj/code/blob/master/stream/readableStream/index.js" target="_blank" rel="noopener">æºç </a></p>
<p>ğŸ˜‹ğŸ˜‹ğŸ˜‹ï¼Œå¥½äº†ï¼Œå…¨éƒ¨åŠŸèƒ½å·²ç»å®ç°ï¼Œå°±åˆ°æ­¤ç»“æŸå§ï¼</p>
</div><br><h4>Thanks</h4><div class="copyright">ç‰ˆæƒå£°æ˜ï¼šç‰ˆæƒå½’ä½œè€…æ‰€æœ‰ï¼Œå¦‚éœ€è½¬è½½è¯·è”ç³»åšä¸»ã€‚</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-07-12</span><i class="fa fa-tag"></i><!-- - item.categories.sort('posts').each(function(item) {--><!-- 		a.tag(href=config.root + item.path, title= item.name)= item.name + " "--><!-- - });--><a href="/h-blog/tags/ReadableStream/" title="ReadableStream" class="tag">ReadableStream </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,https://zdddrszj.github.io/h-blog/2018/07/12/readableStream/,Shirly,ReadableStream ç®€å•å®ç°,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/h-blog/2018/07/19/promiseAchieved/" title="Promise ç®€å•å®ç°" class="btn">ä¸Šä¸€ç¯‡</a></li><li class="next pagbuttons"><a role="navigation" href="/h-blog/2018/06/25/requireAchieved/" title="å®ç° CommonJs è§„èŒƒä¸­çš„ Require æ¨¡å—" class="btn">ä¸‹ä¸€ç¯‡</a></li></ul></div><a id="comments"></a><div id="vcomments" style="margin:0 30px;"></div><script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script><script>const gitment = new Gitment({
    id: location.href,
    owner: 'zdddrszj',
    repo: 'h-blog',
    oauth: {
        client_id: 'fa0612e95df36a1b5754',
        client_secret: '27e682fd9c45ef2379461c346d3b23d5a1db057f',
    }
})
gitment.render('comments')</script></div></div></div></div><script src="/h-blog/js/jquery.js"></script><script src="/h-blog/js/jquery-migrate-1.2.1.min.js"></script><script src="/h-blog/js/jquery.appear.js"></script><script src="/h-blog/js/tagcanvas.js"></script><script>window.onload = function() {
  try {
    TagCanvas.textColour = '#FD6B1E'
    TagCanvas.outlineColour = '#999'
    TagCanvas.Start('tagsCanvas')
  } catch (e) {}
}</script></body></html>